<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>çµ¶å¯¾ã«é¦¬ãŒèµ°ã‚‹ãƒ¬ãƒ¼ã‚¹</title>
<style>
Â Â body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f5f5f5;margin:0;padding:12px}
Â Â h2{margin:0 0 10px;background:#0b8f3c;color:#fff;padding:10px;border-radius:10px}
Â Â .box{background:#fff;border:1px solid #d0d0d0;border-radius:12px;padding:10px;margin:10px 0}
Â Â button{padding:10px 12px;border:0;border-radius:10px;background:#0b8f3c;color:#fff;font-weight:900}
Â Â button:disabled{opacity:.5}
Â Â .muted{color:#666;font-size:13px}

Â Â #race{display:grid;gap:8px;max-height:60vh;overflow:auto}
Â Â .laneWrap{border:1px solid #ddd;border-radius:12px;padding:8px;background:#fff}
Â Â .track{
Â Â Â Â position:relative;height:36px;border-radius:12px;overflow:hidden;margin-top:6px;
Â Â Â Â background:linear-gradient(#141414,#101010),
Â Â Â Â Â Â repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 1px, transparent 1px 72px);
Â Â Â Â background-size:100% 100%,72px 100%;
Â Â Â Â background-position:0 0,var(--bgx,0px) 0;
Â Â }
Â Â .finish{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.8}
Â Â .shadow{
Â Â Â Â position:absolute;left:0%;top:26px;width:30px;height:6px;border-radius:50%;
Â Â Â Â background:rgba(0,0,0,.35);filter:blur(1px);transform-origin:center;
Â Â }
Â Â .horse{
Â Â Â Â position:absolute;left:0%;top:7px;font-size:18px;user-select:none;transform-origin:center;
Â Â Â Â filter: drop-shadow(0 2px 2px rgba(0,0,0,.35));
Â Â }
Â Â .goalTag{display:none;margin-left:8px;padding:2px 8px;border-radius:999px;background:#fff3cd;border:1px solid #ffe08a;color:#7a5a00;font-size:12px;font-weight:900}
</style>
</head>
<body>
<h2>ğŸ‡ çµ¶å¯¾ã«é¦¬ãŒèµ°ã‚‹ãƒ¬ãƒ¼ã‚¹</h2>

<div class="box">
Â Â <button id="startBtn" onclick="startRace()">ãƒ¬ãƒ¼ã‚¹é–‹å§‹</button>
Â Â <button onclick="resetRace()">ãƒªã‚»ãƒƒãƒˆ</button>
Â Â <div class="muted" style="margin-top:8px">
Â Â Â Â ã“ã‚Œã¯å‹•ç”»/GIFã‚’ä½¿ã‚ãªã„ã®ã§ã€èª­ã¿è¾¼ã¿å¤±æ•—ãŒãªã <b>å¿…ãšé¦¬ï¼ˆğŸï¼‰ãŒèµ°ã‚Šã¾ã™</b>ã€‚
Â Â </div>
</div>

<div class="box">
Â Â <div id="race"></div>
</div>

<div class="box">
Â Â <pre id="result">ã¾ã ãƒ¬ãƒ¼ã‚¹ã¯å§‹ã¾ã£ã¦ã„ã¾ã›ã‚“ã€‚</pre>
</div>

<script>
const N = 10;
const TARGET_SECONDS = 15;

let horses = [];
let raf = null;
let lastT = null;
let startT = null;
let bgx = 0;
let finishOrder = [];

function init(){
Â Â horses = [];
Â Â finishOrder = [];
Â Â bgx = 0;
Â Â lastT = null;
Â Â startT = null;

Â Â const wrap = document.getElementById("race");
Â Â wrap.innerHTML = "";

Â Â for(let i=0;i<N;i++){
Â Â Â Â horses.push({
Â Â Â Â Â Â id:i,
Â Â Â Â Â Â p:0,Â Â Â Â Â Â Â Â Â Â Â Â // progress 0..1
Â Â Â Â Â Â v:0,Â Â Â Â Â Â Â Â Â Â Â Â // progress/sec
Â Â Â Â Â Â fin:false,
Â Â Â Â Â Â finTime:0,
Â Â Â Â Â Â // èƒ½åŠ›ï¼ˆå¤šå°‘ã®å·®ã¯ã‚ã‚‹ã‘ã©ã€å¿…ãšèµ°ã‚‹ï¼‰
Â Â Â Â Â Â top: 0.85 + Math.random()*0.35,
Â Â Â Â Â Â accel: 1.2 + Math.random()*0.9,
Â Â Â Â Â Â stamina: 0.85 + Math.random()*0.25,
Â Â Â Â Â Â kick: 1.0 + Math.random()*0.25
Â Â Â Â });

Â Â Â Â const lane = document.createElement("div");
Â Â Â Â lane.className = "laneWrap";
Â Â Â Â lane.innerHTML = `
Â Â Â Â Â Â <div><b>é¦¬${i+1}</b> <span id="goal${i}" class="goalTag">GOAL</span></div>
Â Â Â Â Â Â <div id="track${i}" class="track" style="--bgx:0px">
Â Â Â Â Â Â Â Â <div class="finish"></div>
Â Â Â Â Â Â Â Â <div id="shadow${i}" class="shadow"></div>
Â Â Â Â Â Â Â Â <div id="horse${i}" class="horse">ğŸ</div>
Â Â Â Â Â Â </div>
Â Â Â Â `;
Â Â Â Â wrap.appendChild(lane);

Â Â Â Â setHorseX(i, 0, 0, true);
Â Â }

Â Â document.getElementById("startBtn").disabled = false;
Â Â document.getElementById("result").textContent = "ã¾ã ãƒ¬ãƒ¼ã‚¹ã¯å§‹ã¾ã£ã¦ã„ã¾ã›ã‚“ã€‚";
}

function setHorseX(id, p01, s01, init=false){
Â Â const x = Math.max(0, Math.min(0.96, p01))*100;

Â Â const horse = document.getElementById("horse"+id);
Â Â const shadow = document.getElementById("shadow"+id);

Â Â // â€œèµ°ã£ã¦ã‚‹æ„Ÿâ€ï¼šä¸Šä¸‹ + å°‘ã—å‰å‚¾ï¼ˆé€Ÿåº¦ã§å¼·ãï¼‰
Â Â const bob = init ? 0 : Math.sin((p01*60) + (performance.now()/85))*(2 + s01*6);
Â Â const tilt = init ? 0 : (-2 + s01*4);
Â Â const scale = 1 + s01*0.06;

Â Â horse.style.left = x + "%";
Â Â horse.style.transform = `translateY(${bob*0.4}px) rotate(${tilt}deg) scale(${scale})`;

Â Â shadow.style.left = x + "%";
Â Â shadow.style.width = (26 + s01*12) + "px";
Â Â shadow.style.opacity = (0.28 + s01*0.25).toFixed(2);
Â Â shadow.style.transform = `scaleX(${1 + s01*0.35})`;
}

function startRace(){
Â Â if(raf) return;

Â Â // çµ¶å¯¾ã«å‹•ã‹ã™ï¼šã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ç‚¹ã§å°‘ã—é€Ÿåº¦ã‚’å…¥ã‚Œã‚‹
Â Â horses.forEach(h=>{
Â Â Â Â h.p = 0;
Â Â Â Â h.v = 0.02; // ã“ã“ãŒã€Œçµ¶å¯¾èµ°ã‚‹ã€ä¿é™ºï¼ˆ0ã«ã—ãªã„ï¼‰
Â Â Â Â h.fin = false;
Â Â Â Â h.finTime = 0;
Â Â Â Â document.getElementById("goal"+h.id).style.display = "none";
Â Â Â Â setHorseX(h.id, 0, 0, true);
Â Â });

Â Â finishOrder = [];
Â Â bgx = 0;
Â Â lastT = null;
Â Â startT = null;

Â Â document.getElementById("startBtn").disabled = true;
Â Â document.getElementById("result").textContent = "ãƒ¬ãƒ¼ã‚¹ä¸­â€¦";

Â Â raf = requestAnimationFrame(step);
}

function step(ts){
Â Â if(!startT) startT = ts;
Â Â if(!lastT) lastT = ts;
Â Â const dt = (ts - lastT) / 1000;
Â Â lastT = ts;

Â Â // æ™‚é–“ã‚’ç´„15ç§’ã«å¯„ã›ã‚‹ï¼ˆå…ˆé ­ã®é€²æ—ã‹ã‚‰å…¨ä½“ã‚¹ã‚±ãƒ¼ãƒ«ã‚’èª¿æ•´ï¼‰
Â Â const elapsed = (ts - startT)/1000;
Â Â let leaderP = 0;
Â Â for(const h of horses) leaderP = Math.max(leaderP, h.p);
Â Â const remainT = Math.max(0.7, TARGET_SECONDS - elapsed);
Â Â const remainD = Math.max(0.001, 1 - leaderP);
Â Â const desiredLeaderSpeed = remainD / remainT;
Â Â const baseAvg = 1 / TARGET_SECONDS;
Â Â const timeScale = Math.max(0.75, Math.min(1.35, desiredLeaderSpeed / baseAvg));

Â Â // åœ°é¢ãŒæµã‚Œã‚‹ï¼ˆå…ˆé ­é€Ÿåº¦ã§ï¼‰
Â Â let leaderV = 0;
Â Â for(const h of horses) leaderV = Math.max(leaderV, h.v);
Â Â bgx -= (leaderV * 1100) * dt;

Â Â for(const h of horses){
Â Â Â Â const tr = document.getElementById("track"+h.id);
Â Â Â Â tr.style.setProperty("--bgx", `${bgx}px`);

Â Â Â Â if(h.fin) continue;

Â Â Â Â const p = h.p;

Â Â Â Â // ã‚¹ã‚¿ãƒŸãƒŠï¼†ãƒ©ã‚¹ãƒˆã‚¹ãƒ‘ãƒ¼ãƒˆ
Â Â Â Â const staminaDrop = 1 - (p*(0.55/h.stamina));
Â Â Â Â const staminaMult = Math.max(0.55, Math.min(1.05, staminaDrop));
Â Â Â Â const kickZone = p>0.80 ? (1 + (p-0.80)/0.20*(h.kick-1)) : 1;

Â Â Â Â // â€œçµ¶å¯¾ã«èµ°ã‚‹â€ãŸã‚ã€topSpeedã®ä¸‹é™ã‚’ä½œã‚‹
Â Â Â Â const minSpeed = baseAvg * 0.35; // ä¸‹é™ï¼ˆã“ã“ãŒé‡è¦ï¼‰
Â Â Â Â const topSpeed = Math.max(
Â Â Â Â Â Â minSpeed,
Â Â Â Â Â Â baseAvg * (0.75 + h.top*0.55) * staminaMult * kickZone * timeScale
Â Â Â Â );

Â Â Â Â // åŠ é€Ÿã§è¿‘ã¥ã‘ã‚‹
Â Â Â Â const a = h.accel * (0.9 + Math.random()*0.2);
Â Â Â Â h.v += (topSpeed - h.v) * Math.max(0, Math.min(1, a*dt));

Â Â Â Â // å°‘ã—æºã‚Œ
Â Â Â Â const wobble = 1 + (Math.random()*2 - 1) * 0.025;
Â Â Â Â h.p += h.v * dt * wobble;

Â Â Â Â if(h.p >= 1){
Â Â Â Â Â Â h.p = 1;
Â Â Â Â Â Â h.fin = true;
Â Â Â Â Â Â h.finTime = performance.now();
Â Â Â Â Â Â finishOrder.push(h);
Â Â Â Â Â Â document.getElementById("goal"+h.id).style.display = "inline-block";
Â Â Â Â }

Â Â Â Â const s01 = Math.max(0, Math.min(1, h.v / (baseAvg*1.8)));
Â Â Â Â setHorseX(h.id, h.p, s01);
Â Â }

Â Â if(finishOrder.length >= N){
Â Â Â Â finishRace();
Â Â Â Â return;
Â Â }

Â Â raf = requestAnimationFrame(step);
}

function finishRace(){
Â Â cancelAnimationFrame(raf);
Â Â raf = null;

Â Â finishOrder.sort((a,b)=>a.finTime-b.finTime);
Â Â let txt = "ğŸ ãƒ¬ãƒ¼ã‚¹çµæœ\n";
Â Â finishOrder.forEach((h,i)=> txt += `${i+1}ç€ï¼šé¦¬${h.id+1}\n`);
Â Â document.getElementById("result").textContent = txt;

Â Â document.getElementById("startBtn").disabled = false;
}

function resetRace(){
Â Â if(raf){
Â Â Â Â cancelAnimationFrame(raf);
Â Â Â Â raf = null;
Â Â }
Â Â init();
}

init();
</script>
</body>
</html>
