<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>競馬ゲーム（全部入り）</title>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f5f5f5;color:#111;margin:0;padding:12px}
  h2{background:#0b8f3c;color:#fff;padding:10px;border-radius:8px;margin:0 0 10px}
  .box{background:#fff;border:1px solid #d0d0d0;border-radius:10px;padding:10px;margin:10px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{padding:10px 12px;border:0;border-radius:10px;background:#0b8f3c;color:#fff;font-weight:700}
  button.secondary{background:#333}
  button:disabled{opacity:.5}
  select,input{padding:8px;border-radius:8px;border:1px solid #ccc}
  .muted{color:#666;font-size:13px}

  /* 枠色 */
  .num{display:inline-block;min-width:26px;text-align:center;color:#fff;border-radius:6px;font-weight:800;padding:2px 0;margin-right:6px;font-size:13px}
  .w1{background:#fff;color:#111;border:1px solid #111}
  .w2{background:#111}
  .w3{background:#d40000}
  .w4{background:#0047ff}
  .w5{background:#ffd400;color:#111}
  .w6{background:#0b8f3c}
  .w7{background:#ff8a00}
  .w8{background:#ff5fb7;color:#111}

  /* オッズ表 */
  .table{width:100%;border-collapse:collapse;font-size:14px}
  .table th,.table td{border-bottom:1px solid #e6e6e6;padding:8px 6px;text-align:left}
  .table th{background:#f2f2f2}
  .right{text-align:right}
  .badge{display:inline-block;background:#eef6ff;border:1px solid #cfe6ff;color:#0a4a8a;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}

  /* トラック */
  .trackRow{display:grid;grid-template-columns: 1fr;gap:8px}
  .horseLine{background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px}
  .track{position:relative;height:24px;background:#111;border-radius:10px;overflow:hidden;margin-top:6px}
  .finishLine{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.7}
  .horseIcon{position:absolute;left:0%;top:2px;font-size:18px;transition:left .10s linear;user-select:none}
  .lane{position:absolute;left:0;top:50%;width:100%;height:1px;background:#2b2b2b}

  pre{white-space:pre-wrap;background:#111;color:#eaeaea;border-radius:10px;padding:10px;overflow:auto}
</style>
</head>
<body>

<h2> 競馬ゲーム（全部入り）</h2>

<div class="box" id="players"></div>

<div class="box">
  <div class="row">
    <button id="btnCard" onclick="makeRaceCard()">出走表（オッズ）を作る</button>
    <button id="btnStart" class="secondary" onclick="startRace()" disabled>レース開始</button>
    <button class="secondary" onclick="resetAll()">リセット</button>
  </div>
  <div class="muted">まず「出走表」を作る → オッズを見て賭ける → レース開始。</div>
</div>

<div class="box" id="raceInfo"></div>
<div class="box" id="oddsTable"></div>

<div class="box">
  <h3 style="margin:0 0 8px"> 賭け（3人対戦）</h3>
  <div id="betUI"></div>
  <div class="muted">最低100円。0円になったらその人は実質負け（賭けられない）。</div>
</div>

<div class="box">
  <h3 style="margin:0 0 8px"> レース</h3>
  <div id="race" class="trackRow"></div>
</div>

<pre id="result"></pre>

<script>
/* =========================
   データ & 保存
========================= */
const KEY = "keiba_allin_v1";
const rand = n => Math.floor(Math.random()*n);

const styles = ["逃げ","先行","差し","追込"];
const syll = ["サン","ライ","ブレ","ファ","ド","ル","カ","グ","ヴ","ナ","ト","キ","ラ","ス"];
const randName = () => syll[rand(syll.length)] + syll[rand(syll.length)] + syll[rand(syll.length)];

let players = [
  {name:"P1", money:1500},
  {name:"P2", money:1500},
  {name:"P3", money:1500}
];

let jockeys = [];
for (let i=0;i<60;i++){
  jockeys.push({
    name:`J${i+1}騎手`,
    skill:Math.random()*0.4+0.8,   // 基本能力
    finish:Math.random()*0.4+0.8,  // 直線
    chaos:Math.random()*0.6+0.7    // 大荒れ耐性
  });
}

let horsePool = [];
for (let i=0;i<300;i++){
  horsePool.push({
    name: randName(),
    style: styles[rand(4)],
    power: Math.random()*3+2,
    wins: 0,
    streak: 0
  });
}

let history = [];

function save(){
  localStorage.setItem(KEY, JSON.stringify({players, horsePool, history}));
}
function load(){
  const raw = localStorage.getItem(KEY);
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    if(d?.players) players = d.players;
    if(d?.horsePool) horsePool = d.horsePool;
    if(d?.history) history = d.history;
  }catch(e){}
}
load();

/* =========================
   画面描画
========================= */
function drawPlayers(){
  let html = `<h3 style="margin:0 0 8px"> 所持金</h3>`;
  players.forEach(p=>{
    const danger = p.money<=0 ? " <span class='badge'>0円</span>" : "";
    html += `<div>${p.name}：<b>${p.money}</b>円${danger}</div>`;
  });
  if(history.length){
    html += `<div class="muted" style="margin-top:8px">直近レース：${history.slice(0,3).map(h=>h.join(" / ")).join(" ｜ ")}</div>`;
  }
  document.getElementById("players").innerHTML = html;
}
drawPlayers();

/* =========================
   レースカード（オッズ先）
========================= */
let horses = [];     // 出走10頭（このレース）
let order = [];      // 着順
let chaos = false;   // 大荒れ
let pace = "ミドル";
let distance = 1600;
let cardReady = false;

function frameClass(i){ return "w"+((i%8)+1); }

function computeOdd(h){
  // 連勝で強くなる（少しだけ）
  const streakBoost = 1 + (h.streak||0)*0.05;
  const perf = h.power * streakBoost;

  // 連勝で人気になる → オッズは下がる（=当たりづらい配当）
  const pop = 1 / (1 + (h.streak||0)*0.25);

  const base = (16 / perf);
  const jockeyFactor = (2.05 - h.jockey.skill); // 上手い騎手ほどオッズ下げ
  let odd = base * jockeyFactor * pop;

  // 下限/上限
  odd = Math.max(1.1, Math.min(99.9, odd));
  return Number(odd.toFixed(1));
}

function makeRaceCard(){
  // 10頭抽選
  horses = horsePool.slice().sort(()=>Math.random()-0.5).slice(0,10);
  horses.forEach((h,i)=>{
    h.id = i;
    h.pos = 0;
    h.fin = false;
    h.jockey = jockeys[rand(jockeys.length)];
    h.condition = Math.random()*0.6+0.7;
    h.odd = computeOdd(h);
  });

  chaos = Math.random()<0.03; // ごく稀に大荒れ
  pace = ["スロー","ミドル","ハイ"][rand(3)];
  distance = rand(1400)+1000; // 1000〜2399m

  renderRaceInfo();
  renderOddsTable();
  renderBetUI();      // オッズが出た後に賭けUIを整える
  renderRaceLanes();  // 走るレーン（まだ動かない）
  document.getElementById("btnStart").disabled = false;
  cardReady = true;

  save();
}

function renderRaceInfo(){
  document.getElementById("raceInfo").innerHTML =
    `<h3 style="margin:0 0 8px"> レース条件</h3>
     距離：<b>${distance}m</b> ／ ペース：<b>${pace}</b>
     ${chaos ? "<span class='badge'> 大荒れ（ごく稀）</span>" : ""}`;
}

function renderOddsTable(){
  const sorted = [...horses].sort((a,b)=>a.odd-b.odd);
  let html = `<h3 style="margin:0 0 8px"> オッズ表（人気順）</h3>
  <table class="table">
    <thead>
      <tr>
        <th>人気</th><th>馬</th><th>馬名</th><th>脚質</th><th>騎手</th><th class="right">単勝</th>
      </tr>
    </thead><tbody>`;

  sorted.forEach((h,i)=>{
    html += `<tr>
      <td>${i+1}</td>
      <td><span class="num ${frameClass(h.id)}">${h.id+1}</span></td>
      <td>${h.name}</td>
      <td>${h.style}</td>
      <td>${h.jockey.name}</td>
      <td class="right"><b>${h.odd}</b>倍</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById("oddsTable").innerHTML = html;
}

function renderRaceLanes(){
  let html = "";
  horses.forEach(h=>{
    html += `<div class="horseLine">
      <div>
        <span class="num ${frameClass(h.id)}">${h.id+1}</span>
        <b>${h.name}</b>（${h.style}） 騎手:${h.jockey.name} <span class="badge">${h.odd}倍</span>
      </div>
      <div class="track">
        <div class="lane"></div>
        <div class="finishLine"></div>
        <span id="horse${h.id}" class="horseIcon"></span>
      </div>
    </div>`;
  });
  document.getElementById("race").innerHTML = html;
}

/* =========================
   賭けUI（単勝/三連複/三連単）
========================= */
function buildHorseOptions(){
  return horses.map(h=>`<option value="${h.id}">${h.id+1} ${h.name}（${h.odd}倍）</option>`).join("");
}

function renderBetUI(){
  if(!horses.length){
    document.getElementById("betUI").innerHTML = `<div class="muted">先に「出走表（オッズ）」を作ってね。</div>`;
    return;
  }
  const opts = buildHorseOptions();
  let html = "";

  players.forEach((p,pi)=>{
    html += `<div class="box" style="margin:10px 0">
      <div><b>${p.name}</b>（所持金：${p.money}円）</div>
      <div class="row" style="margin-top:6px">
        <label>券種
          <select id="type${pi}" onchange="syncLegs(${pi})">
            <option value="win">単勝</option>
            <option value="trio">三連複</option>
            <option value="trifecta">三連単</option>
          </select>
        </label>

        <label>金額
          <input id="amt${pi}" type="number" min="100" step="100" value="100" />
        </label>
      </div>

      <div class="row" style="margin-top:6px" id="legs${pi}">
        <label>馬
          <select id="leg${pi}_0">${opts}</select>
        </label>
      </div>
      <div class="muted">※ 0円の人は賭けても意味がないよ。</div>
    </div>`;
  });

  document.getElementById("betUI").innerHTML = html;
  players.forEach((_,pi)=>syncLegs(pi));
}

function syncLegs(pi){
  const type = document.getElementById(`type${pi}`)?.value || "win";
  const opts = buildHorseOptions();
  let html = "";

  if(type==="win"){
    html = `<label>馬
      <select id="leg${pi}_0">${opts}</select>
    </label>`;
  }else if(type==="trio"){
    html = `<label>1頭目 <select id="leg${pi}_0">${opts}</select></label>
            <label>2頭目 <select id="leg${pi}_1">${opts}</select></label>
            <label>3頭目 <select id="leg${pi}_2">${opts}</select></label>`;
  }else{
    html = `<label>1着 <select id="leg${pi}_0">${opts}</select></label>
            <label>2着 <select id="leg${pi}_1">${opts}</select></label>
            <label>3着 <select id="leg${pi}_2">${opts}</select></label>`;
  }

  document.getElementById(`legs${pi}`).innerHTML = html;
}

/* =========================
   レース走行ロジック
========================= */
function step(){
  horses.forEach(h=>{
    if(h.fin) return;

    // ベース速度
    let s = Math.random()*6 + (h.power*0.65);
    // 連勝で少し強くなる
    s *= (1
