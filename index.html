<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆçµ¶å¯¾èµ°ã‚‹/è³­ã‘ãƒ­ãƒƒã‚¯/å½“ãŸã‚Š+è³­ã‘é‡‘Ã—å€ç‡/å¤–ã‚Œ-è³­ã‘é‡‘/0å††ã ã‘GOï¼‰</title>
<style>
Â Â body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f5f5f5;color:#111;margin:0;padding:12px}
Â Â h2{background:#0b8f3c;color:#fff;padding:10px;border-radius:10px;margin:0 0 10px}
Â Â .box{background:#fff;border:1px solid #d0d0d0;border-radius:12px;padding:10px;margin:10px 0}
Â Â .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
Â Â button{padding:10px 12px;border:0;border-radius:10px;background:#0b8f3c;color:#fff;font-weight:900}
Â Â button.secondary{background:#333}
Â Â button:disabled{opacity:.45}
Â Â select,input{padding:8px;border-radius:10px;border:1px solid #ccc}
Â Â .muted{color:#666;font-size:13px}
Â Â .bad{display:inline-block;background:#ffecec;border:1px solid #ffb3b3;color:#7a0000;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .ok{display:inline-block;background:#eaffea;border:1px solid #b9f2b9;color:#0b5a0b;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .badge{display:inline-block;background:#eef6ff;border:1px solid #cfe6ff;color:#0a4a8a;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .live{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#e8f0ff;border:1px solid #cfe0ff;color:#143a86;font-size:12px;font-weight:900}
Â Â .goalTag{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#fff3cd;border:1px solid #ffe08a;color:#7a5a00;font-size:12px;font-weight:900}

Â Â .table{width:100%;border-collapse:collapse;font-size:14px}
Â Â .table th,.table td{border-bottom:1px solid #e7e7e7;padding:8px 6px;text-align:left;vertical-align:top}
Â Â .table th{background:#f2f2f2}
Â Â .right{text-align:right}

Â Â #raceWrap{position:sticky;top:72px;z-index:9;background:#fff;border:2px solid #0b8f3c;border-radius:14px;padding:10px}
Â Â .trackRow{display:grid;grid-template-columns:1fr;gap:8px;max-height:52vh;overflow:auto;border-radius:12px}
Â Â .horseLine{background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px}
Â Â .horseLine.top1{outline:3px solid #ffd400}
Â Â .horseLine.top2{outline:3px solid #c0c0c0}
Â Â .horseLine.top3{outline:3px solid #cd7f32}

Â Â .track{
Â Â Â Â position:relative;height:36px;border-radius:12px;overflow:hidden;margin-top:6px;
Â Â Â Â background:
Â Â Â Â Â Â linear-gradient(#141414, #101010),
Â Â Â Â Â Â repeating-linear-gradient(90deg, rgba(255,255,255,.07) 0 1px, transparent 1px 72px);
Â Â Â Â background-size: 100% 100%, 72px 100%;
Â Â Â Â background-position: 0 0, var(--bgx, 0px) 0;
Â Â }
Â Â .finishLine{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.75}
Â Â .lane{position:absolute;left:0;top:50%;width:100%;height:1px;background:#2b2b2b}

Â Â .shadow{
Â Â Â Â position:absolute; left:0%; top:26px;
Â Â Â Â width:28px; height:6px; border-radius:50%;
Â Â Â Â background:rgba(0,0,0,.35);
Â Â Â Â filter: blur(1px);
Â Â Â Â transform-origin:center;
Â Â }

Â Â /* å‹•ç”»/GIFã¯ã‚ã£ã¦ã‚‚ãªãã¦ã‚‚OKã€‚ğŸã¯å¸¸ã«è¡¨ç¤ºï¼çµ¶å¯¾èµ°ã‚‹ä¿é™º */
Â Â .horseVideo{position:absolute; left:0%; top:3px; height:30px; width:auto; border-radius:6px; display:none;
Â Â Â Â filter: drop-shadow(0 2px 2px rgba(0,0,0,.35)); transform-origin:center;}
Â Â .horseIcon{position:absolute; left:0%; top:9px; height:20px; width:auto; display:none; transform-origin:center;}
Â Â .horseEmoji{position:absolute; left:0%; top:8px; font-size:18px; display:inline; transform-origin:center; user-select:none;}

Â Â pre{white-space:pre-wrap;background:#111;color:#eaeaea;border-radius:12px;padding:10px;overflow:auto}
</style>
</head>
<body>

<h2>ğŸ‡ ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆç¢ºå®Ÿç‰ˆï¼‰</h2>

<div class="box" id="players"></div>

<div class="box">
Â Â <div class="row">
Â Â Â Â <button id="btnCard" onclick="makeRaceCard()">å‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã‚’ä½œã‚‹</button>
Â Â Â Â <button id="btnStart" class="secondary" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰</button>
Â Â Â Â <button class="secondary" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
Â Â </div>
Â Â <div class="muted" style="margin-top:8px">
Â Â Â Â ãƒ»é¦¬ã¯<b>å¿…ãšèµ°ã‚‹</b>ï¼ˆå‹•ç”»/GIFãŒç„¡ãã¦ã‚‚ğŸã§ç¢ºå®Ÿã«èµ°è¡Œï¼‰<br>
Â Â Â Â ãƒ»ãƒ¬ãƒ¼ã‚¹é–‹å§‹æ™‚ã«<b>è³­ã‘ï¼ˆé¦¬ç•ªå·/é‡‘é¡/åˆ¸ç¨®ï¼‰ã‚’ãƒ­ãƒƒã‚¯ã—ã¦è¡¨ç¤º</b> â†’ çµ¶å¯¾ã«å–ã‚Šé•ãˆãªã„<br>
Â Â Â Â ãƒ»ç²¾ç®—ï¼š<b>å½“ãŸã‚Šâ†’æ‰€æŒé‡‘ï¼‹(è³­ã‘é‡‘Ã—å€ç‡)</b>ï¼<b>å¤–ã‚Œâ†’æ‰€æŒé‡‘âˆ’(è³­ã‘é‡‘)</b><br>
Â Â Â Â ãƒ»æ‰€æŒé‡‘ãŒ<b>0å††ã«ãªã£ãŸäººã ã‘ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</b>
Â Â </div>
</div>

<div class="box" id="raceInfo"></div>
<div class="box" id="oddsTable"></div>

<div class="box">
Â Â <h3 style="margin:0 0 8px">ğŸŸï¸ è³­ã‘ï¼ˆå˜å‹ / è¤‡å‹ï¼‰</h3>
Â Â <div id="betUI"></div>
Â Â <div id="lockedUI" class="muted"></div>
</div>

<div class="box" id="raceWrap">
Â Â <div class="row" style="justify-content:space-between;align-items:center">
Â Â Â Â <h3 style="margin:0">ğŸ ãƒ¬ãƒ¼ã‚¹ <span id="liveTag" style="display:none" class="live">LIVE</span></h3>
Â Â Â Â <div class="muted">å®Ÿæ³ï¼š<span id="commentary">â€”</span></div>
Â Â </div>
Â Â <div id="race" class="trackRow"></div>
</div>

<pre id="result"></pre>

<script>
/* ===== è¨­å®š ===== */
const KEY = "keiba_absolute_v2";
const TARGET_SECONDS = 15;
const MIN_BET = 100;
const STEP = 100;
const AUTO_CAMERA = true;

/* ===== util ===== */
const rand=n=>Math.floor(Math.random()*n);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const floorStep=(v)=>Math.floor(v/STEP)*STEP;
const yen=n=>Math.floor(n);
function setCommentary(t){ document.getElementById("commentary").textContent=t; }

/* ===== åå‰ç”Ÿæˆï¼ˆæ¯å›é•ã†ï¼‰ ===== */
const syll=["ã‚µãƒ³","ãƒ©ã‚¤","ãƒ–ãƒ¬","ãƒ•ã‚¡","ãƒ‰","ãƒ«","ã‚«","ã‚°","ãƒ´","ãƒŠ","ãƒˆ","ã‚­","ãƒ©","ã‚¹","ã‚»ã‚¤","ãƒ¦ã‚¦","ã‚ªã‚¦","ã‚·ãƒ³","ãƒãƒ«","ãƒ†ãƒ„","ãƒ’ãƒ¡","ã‚¼ãƒ³","ãƒŸãƒ¤","ã‚¢ã‚­","ãƒ›ã‚·","ã‚«ã‚¼","ãƒ„ã‚­","ãƒ¦ãƒ¡"];
function genName(){ let s=""; const parts=2+rand(2); for(let i=0;i<parts;i++) s+=syll[rand(syll.length)]; return s; }
function genUniqueNames(n){ const set=new Set(); while(set.size<n) set.add(genName()); return [...set]; }

/* ===== ä¿å­˜ ===== */
let players=[{name:"P1",money:1500,dead:false},{name:"P2",money:1500,dead:false},{name:"P3",money:1500,dead:false}];
let horseStats=Array.from({length:10},()=>({powerBase:1.8+Math.random()*4.8,streak:0,wins:0}));
let history=[];
function save(){ try{ localStorage.setItem(KEY, JSON.stringify({players,horseStats,history})); }catch(e){} }
function load(){
Â Â try{
Â Â Â Â const raw=localStorage.getItem(KEY); if(!raw) return;
Â Â Â Â const d=JSON.parse(raw);
Â Â Â Â if(d?.players) players=d.players;
Â Â Â Â if(d?.horseStats) horseStats=d.horseStats;
Â Â Â Â if(d?.history) history=d.history;
Â Â }catch(e){}
}
load();

/* ===== UI:æ‰€æŒé‡‘ ===== */
function drawPlayers(){
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ’° æ‰€æŒé‡‘</h3>`;
Â Â players.forEach(p=>{
Â Â Â Â const tag = (p.money<=0 || p.dead) ? `<span class="bad">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</span>` : "";
Â Â Â Â html += `<div>${p.name}ï¼š<b>${p.money}</b>å†† ${tag}</div>`;
Â Â });
Â Â document.getElementById("players").innerHTML=html;
}
drawPlayers();

/* ===== ãƒ¬ãƒ¼ã‚¹çŠ¶æ…‹ ===== */
let horses=[], order=[];
let surface="èŠ", going="è‰¯", pace="ãƒŸãƒ‰ãƒ«", distance=1600, chaos=false;
let cardReady=false, bettingClosed=false;
let raf=null, lastT=null, startT=null, tick=0, bgx=0, lastLeader=-1;
let lockedBets=[];

/* ===== ã‚ªãƒƒã‚ºï¼ˆå˜å‹ï¼š1äººæ°—<=3 / 10äººæ°—>=150ï¼‰ ===== */
function easeOut(t){ return 1-Math.pow(1-t,2); }
function easeIn(t){ return Math.pow(t,2); }
function makePlaceOdd(winOdd, popRank){
Â Â const k=0.28+Math.random()*0.12;
Â Â let base=1+(winOdd-1)*k;
Â Â base*=(0.95+(popRank-1)*0.02);
Â Â base*=(0.97+Math.random()*0.06);
Â Â return Number(clamp(base,1.10,35.00).toFixed(2));
}
function assignOddsForRace(hs){
Â Â const fav=2.2+Math.random()*0.8;Â Â Â Â Â // 1äººæ°—<=3
Â Â const mid=25+Math.random()*35;Â Â Â Â Â Â Â // ä¸­é–“
Â Â const last=150+Math.random()*120;Â Â Â Â // 10äººæ°—>=150

Â Â const scores=hs.map(h=>Math.log(Math.max(0.01,h.power)) + (Math.random()*2-1)*0.12);
Â Â const idx=[...hs.keys()].sort((a,b)=>scores[b]-scores[a]);

Â Â idx.forEach((hid,rank)=>{
Â Â Â Â let odd;
Â Â Â Â if(rank<=4){
Â Â Â Â Â Â const t=rank/4;
Â Â Â Â Â Â odd = fav + (mid-fav)*easeOut(t);
Â Â Â Â }else{
Â Â Â Â Â Â const t=(rank-5)/4;
Â Â Â Â Â Â odd = mid + (last-mid)*easeIn(t);
Â Â Â Â }
Â Â Â Â odd*=(0.96+Math.random()*0.08);
Â Â Â Â if(rank===0) odd=Math.min(3.0,odd);
Â Â Â Â if(rank===9) odd=Math.max(150.0,odd);
Â Â Â Â hs[hid].winOdd = Number(clamp(odd,1.1,999.9).toFixed(1));
Â Â });

Â Â const popSorted=[...hs].sort((a,b)=>a.winOdd-b.winOdd);
Â Â const popRank=new Map(); popSorted.forEach((h,i)=>popRank.set(h.id,i+1));
Â Â hs.forEach(h=>h.placeOdd = makePlaceOdd(h.winOdd, popRank.get(h.id)));
}

/* ===== å‡ºèµ°è¡¨ ===== */
function makeRaceCard(){
Â Â if(raf) return;

Â Â surface = (Math.random()<0.7) ? "èŠ" : "ãƒ€ãƒ¼ãƒˆ";
Â Â going = (surface==="èŠ") ? (["è‰¯","ç¨é‡","é‡","ä¸è‰¯"][rand(4)]) : (["è‰¯","ç¨é‡","é‡"][rand(3)]);
Â Â pace = ["ã‚¹ãƒ­ãƒ¼","ãƒŸãƒ‰ãƒ«","ãƒã‚¤"][rand(3)];
Â Â distance = rand(1400)+1000;
Â Â chaos = Math.random()<0.03;

Â Â const names=genUniqueNames(10);
Â Â const styles=["é€ƒã’","å…ˆè¡Œ","å·®ã—","è¿½è¾¼"];

Â Â horses = horseStats.map((st,i)=>({
Â Â Â Â id:i,
Â Â Â Â name:names[i],
Â Â Â Â style:styles[rand(4)],
Â Â Â Â power:st.powerBase * (0.92 + Math.random()*0.16),
Â Â Â Â streak:st.streak||0,
Â Â Â Â condition:0.7+Math.random()*0.6,

Â Â Â Â winOdd:0,
Â Â Â Â placeOdd:0,

Â Â Â Â progress:0,speed:0,fin:false,_finishAt:0,
Â Â Â Â stamina:0.85+Math.random()*0.25,
Â Â Â Â accel:1.1+Math.random()*0.9,
Â Â Â Â top:0.95+Math.random()*0.35,
Â Â Â Â kick:1.0+Math.random()*0.25,
Â Â }));

Â Â assignOddsForRace(horses);

Â Â cardReady=true;
Â Â bettingClosed=false;
Â Â lockedBets=[];
Â Â order=[];
Â Â tick=0; bgx=0; lastLeader=-1;
Â Â lastT=null; startT=null;

Â Â document.getElementById("btnStart").disabled=false;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
Â Â document.getElementById("liveTag").style.display="none";
Â Â document.getElementById("result").textContent="";
Â Â setCommentary("â€”");

Â Â renderRaceInfo();
Â Â renderOddsTable();
Â Â renderBetUI();
Â Â renderRaceLanes();
Â Â renderLockedUI();
Â Â save();
}

function renderRaceInfo(){
Â Â document.getElementById("raceInfo").innerHTML =
Â Â Â Â `<h3 style="margin:0 0 8px">ğŸ“Œ ãƒ¬ãƒ¼ã‚¹æ¡ä»¶</h3>
Â Â Â Â Â ${surface}${going} ï¼ è·é›¢ï¼š<b>${distance}m</b> ï¼ ãƒšãƒ¼ã‚¹ï¼š<b>${pace}</b>
Â Â Â Â Â ${chaos?`<span class="badge">âš ï¸ å¤§è’ã‚Œ</span>`:""}
Â Â Â Â Â <span class="badge">ç´„${TARGET_SECONDS}ç§’</span>`;
}

function renderOddsTable(){
Â Â const sorted=[...horses].sort((a,b)=>a.winOdd-b.winOdd);
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ“Š ã‚ªãƒƒã‚ºè¡¨ï¼ˆäººæ°—é †ï¼‰</h3>
Â Â <table class="table"><thead><tr>
Â Â Â Â <th>äººæ°—</th><th>é¦¬ç•ª</th><th>é¦¬å</th><th class="right">å˜å‹</th><th class="right">è¤‡å‹</th>
Â Â </tr></thead><tbody>`;
Â Â sorted.forEach((h,i)=>{
Â Â Â Â html += `<tr><td>${i+1}</td><td>${h.id+1}</td><td>${h.name}</td>
Â Â Â Â Â Â <td class="right"><b>${h.winOdd}</b>å€</td><td class="right"><b>${h.placeOdd}</b>å€</td></tr>`;
Â Â });
Â Â html += `</tbody></table>`;
Â Â document.getElementById("oddsTable").innerHTML=html;
}

/* ===== è³­ã‘UIï¼ˆæ‰€æŒé‡‘ã‚ˆã‚Šå¤šãè³­ã‘ã‚‰ã‚Œãªã„ï¼‰ ===== */
function buildHorseOptions(){
Â Â return horses.map(h=>`<option value="${h.id}">${h.id+1} ${h.name}ï¼ˆå˜å‹${h.winOdd}å€/è¤‡å‹${h.placeOdd}å€ï¼‰</option>`).join("");
}
function renderBetUI(){
Â Â const wrap=document.getElementById("betUI");
Â Â if(!horses.length){ wrap.innerHTML=`<div class="muted">å…ˆã«å‡ºèµ°è¡¨ã‚’ä½œã£ã¦ã­ã€‚</div>`; return; }

Â Â const opts=buildHorseOptions();
Â Â let html="";
Â Â players.forEach((p,pi)=>{
Â Â Â Â const dead = (p.money<=0 || p.dead);
Â Â Â Â const disabled = (bettingClosed || dead) ? "disabled" : "";
Â Â Â Â const note = bettingClosed ? `<span class="bad">ç· åˆ‡</span>` : (dead?`<span class="bad">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</span>`:`<span class="ok">å—ä»˜ä¸­</span>`);
Â Â Â Â const max=Math.max(0,p.money);
Â Â Â Â const v0 = (max>=MIN_BET)?MIN_BET:0;

Â Â Â Â html += `<div class="box" style="margin:10px 0">
Â Â Â Â Â Â <div><b>${p.name}</b>ï¼ˆæ‰€æŒé‡‘ï¼š${p.money}å††ï¼‰ ${note}</div>
Â Â Â Â Â Â <div class="row" style="margin-top:6px">
Â Â Â Â Â Â Â Â <label>åˆ¸ç¨®
Â Â Â Â Â Â Â Â Â Â <select id="type${pi}" ${disabled}>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="win">å˜å‹</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="place">è¤‡å‹</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é¦¬
Â Â Â Â Â Â Â Â Â Â <select id="horse${pi}" ${disabled}>${opts}</select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é‡‘é¡
Â Â Â Â Â Â Â Â Â Â <input id="amt${pi}" type="number" min="0" step="${STEP}" value="${v0}" max="${max}" ${disabled}
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â inputmode="numeric" oninput="capBet(${pi})"/>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <span class="muted">ä¸Šé™ï¼š${max}å††</span>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div id="warn${pi}" class="muted" style="margin-top:6px"></div>
Â Â Â Â </div>`;
Â Â });
Â Â wrap.innerHTML=html;
Â Â players.forEach((_,pi)=>capBet(pi));
}
window.capBet=function(pi){
Â Â const p=players[pi];
Â Â const inp=document.getElementById("amt"+pi);
Â Â const warn=document.getElementById("warn"+pi);
Â Â if(!inp || !warn) return;

Â Â const max=Math.max(0,p.money);
Â Â inp.max=String(max);

Â Â let v=Number(inp.value);
Â Â if(!Number.isFinite(v) || v<0) v=0;
Â Â v=floorStep(v);
Â Â if(v>max) v=floorStep(max);
Â Â if(v>0 && v<MIN_BET) v=MIN_BET;
Â Â if(v>max) v=0;

Â Â inp.value=v;
Â Â warn.textContent = (v===0 && max>0) ? "0å††ï¼è³­ã‘ãªã—" : "";
};

/* ===== ãƒ­ãƒƒã‚¯ï¼ˆçµ¶å¯¾ã«å–ã‚Šé•ãˆãªã„ï¼‰ ===== */
function lockBets(){
Â Â lockedBets=[];
Â Â players.forEach((p,pi)=>{
Â Â Â Â if(p.money<=0 || p.dead) return;

Â Â Â Â const type=document.getElementById("type"+pi)?.value ?? "win";
Â Â Â Â const horseId=Number(document.getElementById("horse"+pi)?.value);
Â Â Â Â let amt=Number(document.getElementById("amt"+pi)?.value);

Â Â Â Â if(!Number.isFinite(horseId) || horseId<0 || horseId>9) return;
Â Â Â Â if(!Number.isFinite(amt) || amt<0) amt=0;

Â Â Â Â amt=floorStep(amt);
Â Â Â Â if(amt>p.money) amt=floorStep(p.money);
Â Â Â Â if(amt>0 && amt<MIN_BET) amt=0;

Â Â Â Â if(amt>=MIN_BET) lockedBets.push({pi,type,horseId,amt});
Â Â });
}
function renderLockedUI(){
Â Â const box=document.getElementById("lockedUI");
Â Â if(!lockedBets.length){
Â Â Â Â box.innerHTML = bettingClosed ? `<span class="bad">è³­ã‘ãªã—ï¼ˆã¾ãŸã¯å…¨å“¡ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰</span>` : "";
Â Â Â Â return;
Â Â }
Â Â const lines = lockedBets.map(b=>{
Â Â Â Â const h=horses[b.horseId];
Â Â Â Â const kind = b.type==="win" ? "å˜å‹" : "è¤‡å‹";
Â Â Â Â const odd = b.type==="win" ? h.winOdd : h.placeOdd;
Â Â Â Â return `${players[b.pi].name}ï¼š${kind} ${b.horseId+1}ç•ª ${h.name}Â Â ${b.amt}å††ï¼ˆ${odd}å€ï¼‰`;
Â Â });
Â Â box.innerHTML = `<div class="badge">ğŸ”’ ãƒ­ãƒƒã‚¯æ¸ˆã¿è³­ã‘</div><div style="margin-top:6px">${lines.join("<br>")}</div>`;
}

/* ===== ãƒ¬ãƒ¼ãƒ³ï¼ˆğŸã¯å¸¸ã«è¡¨ç¤ºï¼çµ¶å¯¾èµ°ã‚‹ï¼‰ ===== */
function renderRaceLanes(){
Â Â let html="";
Â Â horses.forEach(h=>{
Â Â Â Â html += `<div id="line${h.id}" class="horseLine">
Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â <b>${h.id+1} ${h.name}</b>
Â Â Â Â Â Â Â Â <span id="goal${h.id}" style="display:none" class="goalTag">GOAL</span>
Â Â Â Â Â Â Â Â <span class="badge">å˜å‹${h.winOdd}å€</span><span class="badge">è¤‡å‹${h.placeOdd}å€</span>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div id="track${h.id}" class="track" style="--bgx:0px">
Â Â Â Â Â Â Â Â <div class="lane"></div><div class="finishLine"></div>
Â Â Â Â Â Â Â Â <div id="shadow${h.id}" class="shadow"></div>

Â Â Â Â Â Â Â Â <video id="horseVid${h.id}" class="horseVideo" muted playsinline loop preload="metadata">
Â Â Â Â Â Â Â Â Â Â <source src="./horse.mp4" type="video/mp4">
Â Â Â Â Â Â Â Â </video>
Â Â Â Â Â Â Â Â <img id="horseGif${h.id}" class="horseIcon" src="./horse.gif" alt="horse">
Â Â Â Â Â Â Â Â <span id="horseEmoji${h.id}" class="horseEmoji">ğŸ</span>
Â Â Â Â Â Â </div>
Â Â Â Â </div>`;
Â Â });
Â Â document.getElementById("race").innerHTML=html;

Â Â horses.forEach(h=>{
Â Â Â Â document.getElementById("goal"+h.id).style.display="none";
Â Â Â Â setHorseX(h.id,0,0,true);
Â Â });

Â Â // GIFï¼šèª­ã‚ãŸã‚‰è¡¨ç¤º
Â Â horses.forEach(h=>{
Â Â Â Â const img=document.getElementById("horseGif"+h.id);
Â Â Â Â if(!img) return;
Â Â Â Â img.onload=()=>{ img.style.display="inline"; };
Â Â Â Â img.onerror=()=>{ img.style.display="none"; };
Â Â });

Â Â // å‹•ç”»ï¼šcanplayã®æ™‚ã ã‘è¡¨ç¤ºï¼ˆé»’ç®±é˜²æ­¢ï¼‰
Â Â horses.forEach(h=>{
Â Â Â Â const v=document.getElementById("horseVid"+h.id);
Â Â Â Â if(!v) return;
Â Â Â Â v.style.display="none";
Â Â Â Â v.addEventListener("canplay", ()=>{ v.style.display="inline"; }, {once:true});
Â Â Â Â const hide=()=>{ try{ v.pause(); }catch(e){} v.style.display="none"; };
Â Â Â Â v.addEventListener("error", hide, {once:true});
Â Â Â Â v.addEventListener("stalled", hide, {once:true});
Â Â Â Â setTimeout(()=>{ if(v.readyState<2) hide(); }, 800);
Â Â });
}

function setHorseX(id, p01, s01, init=false){
Â Â const x = clamp(p01,0,0.96)*100;
Â Â const bob = init?0:Math.sin((p01*55)+(performance.now()/90))*(2+s01*6);
Â Â const tilt = init?0:(-2+s01*4);
Â Â const scale = 1 + s01*0.05;

Â Â const sh=document.getElementById("shadow"+id);
Â Â if(sh){
Â Â Â Â sh.style.left=x+"%";
Â Â Â Â sh.style.width=(24+s01*10)+"px";
Â Â Â Â sh.style.opacity=(0.28+s01*0.22).toFixed(2);
Â Â Â Â sh.style.transform=`scaleX(${1+s01*0.35})`;
Â Â }

Â Â const v=document.getElementById("horseVid"+id);
Â Â const img=document.getElementById("horseGif"+id);
Â Â const emo=document.getElementById("horseEmoji"+id);

Â Â if(v && v.style.display!=="none"){
Â Â Â Â v.style.left=x+"%";
Â Â Â Â v.style.transform=`translateY(${bob}px) rotate(${tilt}deg) scale(${scale})`;
Â Â Â Â v.playbackRate = clamp(0.85+s01*0.9,0.8,1.6);
Â Â }
Â Â if(img && img.style.display!=="none"){
Â Â Â Â img.style.left=x+"%";
Â Â Â Â img.style.transform=`translateY(${bob*0.6}px) rotate(${tilt}deg) scale(${scale})`;
Â Â }
Â Â // ğŸã¯å¸¸ã«è¡¨ç¤ºï¼ˆ=å¿…ãšèµ°ã‚‹ï¼‰
Â Â if(emo){
Â Â Â Â emo.style.left=x+"%";
Â Â Â Â emo.style.transform=`translateY(${bob*0.4}px) rotate(${tilt}deg) scale(${scale})`;
Â Â }
}

function cameraFollow(){
Â Â if(!AUTO_CAMERA) return;
Â Â let leader=horses[0];
Â Â for(const h of horses) if(h.progress>leader.progress) leader=h;
Â Â if(leader.id!==lastLeader){
Â Â Â Â lastLeader=leader.id;
Â Â Â Â document.getElementById("line"+leader.id)?.scrollIntoView({behavior:"smooth", block:"center"});
Â Â }
}
function updateGround(dt){
Â Â let leader=horses[0];
Â Â for(const h of horses) if(h.progress>leader.progress) leader=h;
Â Â const v=leader?.speed||0;
Â Â bgx -= (v*1100)*dt;
Â Â horses.forEach(h=>{
Â Â Â Â const tr=document.getElementById("track"+h.id);
Â Â Â Â if(tr) tr.style.setProperty("--bgx", `${bgx}px`);
Â Â });
}

/* ===== èµ°ã‚Šï¼ˆç´„15ç§’ï¼‰ ===== */
function runFrame(ts){
Â Â if(!startT) startT=ts;
Â Â if(!lastT) lastT=ts;
Â Â const dt=(ts-lastT)/1000;
Â Â lastT=ts;
Â Â tick++;

Â Â if(tick%30===0){
Â Â Â Â let leader=horses[0];
Â Â Â Â for(const h of horses) if(h.progress>leader.progress) leader=h;
Â Â Â Â setCommentary(`å…ˆé ­ã¯ ${leader.id+1}ç•ª ${leader.name}ï¼`);
Â Â }

Â Â const elapsed=(ts-startT)/1000;
Â Â let leaderP=0;
Â Â for(const h of horses) leaderP=Math.max(leaderP,h.progress);
Â Â const remainT=Math.max(0.7, TARGET_SECONDS-elapsed);
Â Â const remainD=Math.max(0.001, 1-leaderP);
Â Â const desiredLeaderSpeed=remainD/remainT;
Â Â const baseAvg=1/TARGET_SECONDS;
Â Â const timeScale=clamp(desiredLeaderSpeed/baseAvg, 0.75, 1.35);

Â Â for(const h of horses){
Â Â Â Â if(h.fin) continue;

Â Â Â Â const p=h.progress;
Â Â Â Â const staminaDrop = 1 - (p*(0.55/h.stamina));
Â Â Â Â const staminaMult = clamp(staminaDrop, 0.55, 1.05);
Â Â Â Â const kickZone = p>0.80 ? (1 + (p-0.80)/0.20*(h.kick-1)) : 1;

Â Â Â Â let styleMult=1.0;
Â Â Â Â if(h.style==="é€ƒã’") styleMult*=(p<0.35?1.10:0.98);
Â Â Â Â if(h.style==="å…ˆè¡Œ") styleMult*=(p<0.55?1.06:1.00);
Â Â Â Â if(h.style==="å·®ã—") styleMult*=(p<0.55?1.00:1.05);
Â Â Â Â if(h.style==="è¿½è¾¼") styleMult*=(p<0.60?0.98:1.10);

Â Â Â Â if(pace==="ãƒã‚¤"){ if(h.style==="é€ƒã’") styleMult*=0.96; if(h.style==="è¿½è¾¼") styleMult*=1.05; }
Â Â Â Â if(pace==="ã‚¹ãƒ­ãƒ¼"){ if(h.style==="é€ƒã’") styleMult*=1.05; if(h.style==="è¿½è¾¼") styleMult*=0.97; }

Â Â Â Â const powerMult = (0.85+h.power*0.06) * (0.92+(h.condition-0.7)*0.7) * (1+(h.streak||0)*0.05);
Â Â Â Â const chaosMult = chaos ? (0.88+Math.random()*0.30) : 1.0;

Â Â Â Â const topSpeed = baseAvg*(0.75+h.top*0.55)*powerMult*staminaMult*styleMult*kickZone*chaosMult*timeScale;
Â Â Â Â const accel = h.accel*(0.9+Math.random()*0.2);

Â Â Â Â h.speed += (topSpeed-h.speed)*clamp(accel*dt,0,1);
Â Â Â Â const wobble = 1 + (Math.random()*2-1)*0.025;
Â Â Â Â h.progress += h.speed*dt*wobble;

Â Â Â Â if(h.progress>=1){
Â Â Â Â Â Â h.progress=1;
Â Â Â Â Â Â h.fin=true;
Â Â Â Â Â Â h._finishAt=performance.now();
Â Â Â Â Â Â order.push(h);
Â Â Â Â Â Â document.getElementById("goal"+h.id).style.display="inline-block";
Â Â Â Â }

Â Â Â Â const s01 = clamp(h.speed/(baseAvg*1.8),0,1);
Â Â Â Â setHorseX(h.id, h.progress, s01);
Â Â }

Â Â updateGround(dt);
Â Â cameraFollow();

Â Â if(order.length>=10){ finishRace(); return; }
Â Â raf=requestAnimationFrame(runFrame);
}

/* ===== ç²¾ç®—ï¼šå½“ãŸã‚Šã¯å¢—ãˆã‚‹ / å¤–ã‚Œã¯æ¸›ã‚‹ / 0å††ã®äººã ã‘GO ===== */
function settle(){
Â Â order.sort((a,b)=>a._finishAt-b._finishAt);
Â Â const first=order[0], second=order[1], third=order[2];
Â Â const top3=new Set([first.id, second.id, third.id]);

Â Â const log=[];
Â Â for(const b of lockedBets){
Â Â Â Â const p=players[b.pi];
Â Â Â Â if(!p || p.dead) continue;

Â Â Â Â // â€œçµ¶å¯¾ã«é–“é•ãˆãªã„â€ãŸã‚ã€ãƒ­ãƒƒã‚¯æ¸ˆã¿ã®horseId/amtã®ã¿ä½¿ç”¨
Â Â Â Â const stake = Math.min(b.amt, p.money);

Â Â Â Â const h=horses[b.horseId];
Â Â Â Â const odd = (b.type==="win") ? h.winOdd : h.placeOdd;
Â Â Â Â const hit = (b.type==="win") ? (b.horseId===first.id) : top3.has(b.horseId);

Â Â Â Â if(hit){
Â Â Â Â Â Â const gain = yen(stake * odd);
Â Â Â Â Â Â p.money += gain;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // å½“ãŸã‚Šâ†’å¢—ãˆã‚‹
Â Â Â Â Â Â log.push(`${p.name}: ${b.type==="win"?"å˜å‹":"è¤‡å‹"} ${b.horseId+1}ç•ª ${stake}å†† â†’ çš„ä¸­ï¼ +${gain}å††`);
Â Â Â Â }else{
Â Â Â Â Â Â p.money -= stake;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // å¤–ã‚Œâ†’æ¸›ã‚‹
Â Â Â Â Â Â log.push(`${p.name}: ${b.type==="win"?"å˜å‹":"è¤‡å‹"} ${b.horseId+1}ç•ª ${stake}å†† â†’ ãƒã‚ºãƒ¬ -${stake}å††`);
Â Â Â Â }

Â Â Â Â if(p.money<=0){
Â Â Â Â Â Â p.money=0; p.dead=true;Â Â Â Â Â Â Â Â Â Â // ãã®äººã ã‘ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
Â Â Â Â Â Â log.push(`${p.name}: 0å†† â†’ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼`);
Â Â Â Â }
Â Â }
Â Â return {log};
}

function finishRace(){
Â Â cancelAnimationFrame(raf); raf=null; lastT=null;

Â Â order.sort((a,b)=>a._finishAt-b._finishAt);
Â Â const first=order[0], second=order[1], third=order[2];

Â Â document.getElementById("line"+first.id)?.classList.add("top1");
Â Â document.getElementById("line"+second.id)?.classList.add("top2");
Â Â document.getElementById("line"+third.id)?.classList.add("top3");

Â Â const {log}=settle();

Â Â let txt="ğŸ çµæœï¼ˆå…¨ç€é †ï¼‰\n";
Â Â order.forEach((h,i)=>{ txt += `${i+1}ç€ ${h.id+1} ${h.name}\n`; });
Â Â txt += `\nã€ç²¾ç®—ã€‘å½“ãŸã‚Šï¼š+ï¼ˆè³­ã‘é‡‘Ã—å€ç‡ï¼‰ï¼å¤–ã‚Œï¼š-è³­ã‘é‡‘ï¼0å††ã ã‘GO\n`;
Â Â txt += `\nã€ç²¾ç®—ãƒ­ã‚°ã€‘\n` + log.map(s=>"ãƒ»"+s).join("\n") + "\n";
Â Â document.getElementById("result").textContent=txt;

Â Â bettingClosed=false; cardReady=false;
Â Â lockedBets=[];
Â Â document.getElementById("btnStart").disabled=true;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
Â Â document.getElementById("btnCard").disabled=false;
Â Â document.getElementById("liveTag").style.display="none";
Â Â setCommentary("ãƒ¬ãƒ¼ã‚¹çµ‚äº†ï¼");
Â Â drawPlayers(); save();
Â Â renderBetUI(); renderLockedUI();
}

/* ===== é–‹å§‹ï¼ˆé–‹å§‹æ™‚ã«ãƒ­ãƒƒã‚¯ã—ã¦å›ºå®šï¼‰ ===== */
function startRace(){
Â Â if(!cardReady || horses.length!==10) return;
Â Â if(raf) return;

Â Â bettingClosed=true;
Â Â renderBetUI();

Â Â // â˜…ã“ã“ã§ãƒ­ãƒƒã‚¯ï¼†è¡¨ç¤ºï¼ˆä»¥é™ã€çµ¶å¯¾ã«å¤‰ã‚ã‚‰ãªã„ï¼‰
Â Â lockBets();
Â Â renderLockedUI();

Â Â document.getElementById("btnCard").disabled=true;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹ä¸­â€¦";
Â Â document.getElementById("liveTag").style.display="inline-block";
Â Â setCommentary("ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸï¼");

Â Â order=[]; tick=0; bgx=0; lastLeader=-1;
Â Â lastT=null; startT=null;

Â Â horses.forEach(h=>{
Â Â Â Â h.progress=0; h.speed=0; h.fin=false; h._finishAt=0;
Â Â Â Â setHorseX(h.id,0,0,true);
Â Â });
Â Â renderRaceLanes();

Â Â // å‹•ç”»ã¯â€œã§ããŸã‚‰â€å†ç”Ÿï¼ˆã§ããªãã¦ã‚‚ğŸãŒå¿…ãšèµ°ã‚‹ï¼‰
Â Â horses.forEach(h=>{
Â Â Â Â const v=document.getElementById("horseVid"+h.id);
Â Â Â Â if(!v) return;
Â Â Â Â try{
Â Â Â Â Â Â const p=v.play();
Â Â Â Â Â Â if(p && typeof p.then==="function") p.catch(()=>{ v.style.display="none"; });
Â Â Â Â }catch(e){ v.style.display="none"; }
Â Â });

Â Â raf=requestAnimationFrame(runFrame);
}

/* ===== ãƒªã‚»ãƒƒãƒˆ ===== */
function resetAll(){
Â Â if(raf){ cancelAnimationFrame(raf); raf=null; }
Â Â try{ localStorage.removeItem(KEY); }catch(e){}
Â Â location.reload();
}
</script>
</body>
</html>
