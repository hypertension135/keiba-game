<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆæœ¬ç‰©é¦¬å‹•ç”»/æ‰€æŒé‡‘åˆ¶é™/è³­ã‘é‡‘Ã—å€ç‡/å˜å‹è¤‡å‹/15ç§’å®‰å®šï¼‰</title>
<style>
Â Â body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f5f5f5;color:#111;margin:0;padding:12px}
Â Â h2{background:#0b8f3c;color:#fff;padding:10px;border-radius:10px;margin:0 0 10px}
Â Â .box{background:#fff;border:1px solid #d0d0d0;border-radius:12px;padding:10px;margin:10px 0}
Â Â .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
Â Â button{padding:10px 12px;border:0;border-radius:10px;background:#0b8f3c;color:#fff;font-weight:900}
Â Â button.secondary{background:#333}
Â Â button:disabled{opacity:.45}
Â Â select,input{padding:8px;border-radius:10px;border:1px solid #ccc}
Â Â .muted{color:#666;font-size:13px}
Â Â .warn{color:#7a0000;font-weight:800}

Â Â .badge{display:inline-block;background:#eef6ff;border:1px solid #cfe6ff;color:#0a4a8a;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .bad{display:inline-block;background:#ffecec;border:1px solid #ffb3b3;color:#7a0000;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .ok{display:inline-block;background:#eaffea;border:1px solid #b9f2b9;color:#0b5a0b;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .goalTag{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#fff3cd;border:1px solid #ffe08a;color:#7a5a00;font-size:12px;font-weight:900}
Â Â .live{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#e8f0ff;border:1px solid #cfe0ff;color:#143a86;font-size:12px;font-weight:900}

Â Â .num{display:inline-block;min-width:26px;text-align:center;color:#fff;border-radius:7px;font-weight:900;padding:2px 0;margin-right:6px;font-size:13px;font-variant-numeric:tabular-nums}
Â Â .w1{background:#fff;color:#111;border:1px solid #111}
Â Â .w2{background:#111}
Â Â .w3{background:#d40000}
Â Â .w4{background:#0047ff}
Â Â .w5{background:#ffd400;color:#111}
Â Â .w6{background:#0b8f3c}
Â Â .w7{background:#ff8a00}
Â Â .w8{background:#ff5fb7;color:#111}

Â Â .table{width:100%;border-collapse:collapse;font-size:14px}
Â Â .table th,.table td{border-bottom:1px solid #e7e7e7;padding:8px 6px;text-align:left;vertical-align:top}
Â Â .table th{background:#f2f2f2}
Â Â .right{text-align:right}

Â Â /* ãƒ¬ãƒ¼ã‚¹æ¬„ï¼šè¦‹å¤±ã‚ãªã„ */
Â Â #raceWrap{position:sticky;top:72px;z-index:9;background:#fff;border:2px solid #0b8f3c;border-radius:14px;padding:10px}
Â Â .trackRow{display:grid;grid-template-columns:1fr;gap:8px;max-height:52vh;overflow:auto;border-radius:12px}
Â Â .horseLine{background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px}
Â Â .horseLine.top1{outline:3px solid #ffd400}
Â Â .horseLine.top2{outline:3px solid #c0c0c0}
Â Â .horseLine.top3{outline:3px solid #cd7f32}

Â Â /* ãƒˆãƒ©ãƒƒã‚¯ï¼šåœ°é¢ãŒæµã‚Œã¦ã‚¹ãƒ”ãƒ¼ãƒ‰æ„Ÿ */
Â Â .track{
Â Â Â Â position:relative;height:36px;border-radius:12px;overflow:hidden;margin-top:6px;
Â Â Â Â background:
Â Â Â Â Â Â linear-gradient(#141414, #101010),
Â Â Â Â Â Â repeating-linear-gradient(90deg, rgba(255,255,255,.07) 0 1px, transparent 1px 72px);
Â Â Â Â background-size: 100% 100%, 72px 100%;
Â Â Â Â background-position: 0 0, var(--bgx, 0px) 0;
Â Â }
Â Â .finishLine{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.75}
Â Â .lane{position:absolute;left:0;top:50%;width:100%;height:1px;background:#2b2b2b}

Â Â /* å½±ï¼ˆæœ¬ç‰©æ„Ÿï¼‰ */
Â Â .shadow{
Â Â Â Â position:absolute; left:0%; top:26px;
Â Â Â Â width:28px; height:6px; border-radius:50%;
Â Â Â Â background:rgba(0,0,0,.35);
Â Â Â Â filter: blur(1px);
Â Â Â Â transform-origin:center;
Â Â }

Â Â /* æœ¬ç‰©ã®é¦¬ï¼šå‹•ç”»ï¼ˆæœ€åˆã¯éè¡¨ç¤ºã€å†ç”Ÿã§ããŸã‚‰è¡¨ç¤ºï¼‰ */
Â Â .horseVideo{
Â Â Â Â position:absolute; left:0%; top:3px;
Â Â Â Â height:30px; width:auto;
Â Â Â Â transform-origin:center;
Â Â Â Â filter: drop-shadow(0 2px 2px rgba(0,0,0,.35));
Â Â Â Â border-radius:6px;
Â Â Â Â display:none;
Â Â }

Â Â /* ä¿é™ºï¼šGIF/çµµæ–‡å­— */
Â Â .horseIcon{position:absolute;left:0%;top:9px;height:20px;width:auto;user-select:none;display:none}
Â Â .horseFallback{position:absolute;left:0%;top:8px;font-size:18px;user-select:none;display:none}

Â Â pre{white-space:pre-wrap;background:#111;color:#eaeaea;border-radius:12px;padding:10px;overflow:auto}
</style>
</head>
<body>

<h2>ğŸ‡ ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆä¿®æ­£ç‰ˆï¼‰</h2>

<div class="box" id="players"></div>

<div class="box">
Â Â <div class="row">
Â Â Â Â <button id="btnCard" onclick="makeRaceCard()">å‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã‚’ä½œã‚‹</button>
Â Â Â Â <button id="btnStart" class="secondary" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰</button>
Â Â Â Â <button class="secondary" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
Â Â </div>
Â Â <div class="muted" style="margin-top:8px">
Â Â Â Â ãƒ»åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« <b>horse.mp4</b>ï¼ˆæœ¬ç‰©ã®é¦¬ã®èµ°ã‚Šå‹•ç”»ãƒ»æ¨©åˆ©OKï¼‰ã‚’ç½®ãã¨ â€œæœ¬ç‰©æ„Ÿâ€ ã§èµ°ã‚‹<br>
Â Â Â Â ãƒ»å‹•ç”»ãŒå†ç”Ÿã§ããªã„/ç„¡ã„å ´åˆã¯è‡ªå‹•ã§ <b>GIF â†’ ğŸ</b> ã«åˆ‡æ›¿ï¼ˆé»’ã„ç®±ã‚’å‡ºã•ãªã„ï¼‰<br>
Â Â Â Â ãƒ»æ‰•æˆ»ã¯ <b>è³­ã‘é‡‘Ã—å€ç‡</b>ï¼ˆå˜å‹/è¤‡å‹ï¼‰ï¼æ‰€æŒé‡‘ä»¥ä¸Šã¯è³­ã‘ã‚‰ã‚Œãªã„ï¼ˆå…¥åŠ›ã‚‚ãƒ­ãƒƒã‚¯ã‚‚ï¼‰<br>
Â Â Â Â ãƒ»å˜å‹ã¯ <b>1ç•ªäººæ°—â‰¤3.0</b> / <b>10ç•ªäººæ°—â‰¥150</b> ã‚’å¿…ãšæº€ãŸã™ï¼ˆä¸­é–“ã‚‚æ¥µç«¯ã«ãªã‚Šã«ãã„å½¢ï¼‰<br>
Â Â Â Â ãƒ»ãƒ¬ãƒ¼ã‚¹æ™‚é–“ã¯ <b>ç´„15ç§’</b> ã«å¯„ã›ã‚‹ï¼ˆãƒ–ãƒ¬ãŒå°ã•ã„ã‚¿ã‚¤ãƒ è£œæ­£å…¥ã‚Šï¼‰
Â Â </div>
Â Â <div id="storeWarn" class="muted"></div>
</div>

<div class="box" id="raceInfo"></div>
<div class="box" id="oddsTable"></div>

<div class="box">
Â Â <h3 style="margin:0 0 8px">ğŸŸï¸ è³­ã‘ï¼ˆå˜å‹ / è¤‡å‹ï¼‰</h3>
Â Â <div id="betUI"></div>
Â Â <div class="muted">æœ€ä½100å††ã€‚ãƒ¬ãƒ¼ã‚¹é–‹å§‹ã§ç· åˆ‡ï¼†è³­ã‘å†…å®¹ã‚’ãƒ­ãƒƒã‚¯ã€‚</div>
</div>

<div class="box" id="raceWrap">
Â Â <div class="row" style="justify-content:space-between;align-items:center">
Â Â Â Â <h3 style="margin:0">ğŸ ãƒ¬ãƒ¼ã‚¹ <span id="liveTag" style="display:none" class="live">LIVE</span></h3>
Â Â Â Â <div class="muted">å®Ÿæ³ï¼š<span id="commentary">â€”</span></div>
Â Â </div>
Â Â <div id="race" class="trackRow"></div>
</div>

<pre id="result"></pre>

<script>
/* ======================
Â Â è¨­å®š
====================== */
const KEY = "keiba_realhorse_v2_fixed";
const TARGET_SECONDS = 15;Â Â Â Â Â Â // ã ã„ãŸã„ã“ã®ç§’æ•°
const AUTO_CAMERA = true;
const BET_STEP = 100;Â Â Â Â Â Â Â Â Â Â Â // 100å††å˜ä½ã«ä¸¸ã‚ã‚‹
const MIN_BET = 100;

/* ======================
Â Â ä¾¿åˆ©é–¢æ•°
====================== */
const rand = n => Math.floor(Math.random()*n);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const frameClass = i => "w"+((i%8)+1);
const yen = n => Math.floor(n); // æ‰•æˆ»ï¼šåˆ‡ã‚Šæ¨ã¦
const roundDownStep = (v, step) => Math.floor(v/step)*step;

/* ======================
Â Â é¦¬åç”Ÿæˆï¼ˆæ¯å›é•ã†ãƒ»é‡è¤‡ãªã—ï¼‰
====================== */
const syll = ["ã‚µãƒ³","ãƒ©ã‚¤","ãƒ–ãƒ¬","ãƒ•ã‚¡","ãƒ‰","ãƒ«","ã‚«","ã‚°","ãƒ´","ãƒŠ","ãƒˆ","ã‚­","ãƒ©","ã‚¹","ã‚»ã‚¤","ãƒ¦ã‚¦","ã‚ªã‚¦","ã‚·ãƒ³","ãƒãƒ«","ãƒ†ãƒ„","ãƒ’ãƒ¡","ã‚¼ãƒ³","ãƒŸãƒ¤","ã‚¢ã‚­","ãƒ›ã‚·","ã‚«ã‚¼","ãƒ„ã‚­","ãƒ¦ãƒ¡"];
function genName(){
Â Â const parts = 2 + rand(2);
Â Â let s = "";
Â Â for(let i=0;i<parts;i++) s += syll[rand(syll.length)];
Â Â return s;
}
function genUniqueNames(n){
Â Â const set = new Set();
Â Â while(set.size < n) set.add(genName());
Â Â return [...set];
}

/* ======================
Â Â ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆå¤±æ•—ã‚‚è¡¨ç¤ºï¼‰
====================== */
let players = [
Â Â {name:"P1", money:1500},
Â Â {name:"P2", money:1500},
Â Â {name:"P3", money:1500},
];
let horseStats = Array.from({length:10}, ()=>({
Â Â powerBase: 1.8 + Math.random()*4.8,
Â Â wins: 0,
Â Â streak: 0
}));
let history = [];

function save(){
Â Â try{
Â Â Â Â localStorage.setItem(KEY, JSON.stringify({players, horseStats, history}));
Â Â Â Â document.getElementById("storeWarn").innerHTML = "";
Â Â }catch(e){
Â Â Â Â document.getElementById("storeWarn").innerHTML =
Â Â Â Â Â Â `<span class="warn">â€»ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶è¨­å®š/å®¹é‡/ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆç­‰ï¼‰</span>`;
Â Â }
}
function load(){
Â Â try{
Â Â Â Â const raw = localStorage.getItem(KEY);
Â Â Â Â if(!raw) return;
Â Â Â Â const d = JSON.parse(raw);
Â Â Â Â if(d?.players) players = d.players;
Â Â Â Â if(d?.horseStats) horseStats = d.horseStats;
Â Â Â Â if(d?.history) history = d.history;
Â Â }catch(e){}
}
load();

/* ======================
Â Â UI
====================== */
function setCommentary(t){ document.getElementById("commentary").textContent = t; }
function drawPlayers(){
Â Â let html = `<h3 style="margin:0 0 8px">ğŸ’° æ‰€æŒé‡‘</h3>`;
Â Â players.forEach(p=>{
Â Â Â Â html += `<div>${p.name}ï¼š<b>${p.money}</b>å†† ${p.money<=0?`<span class="bad">æ•—é€€</span>`:""}</div>`;
Â Â });
Â Â if(history.length){
Â Â Â Â html += `<div class="muted" style="margin-top:8px">ç›´è¿‘ï¼š${history.slice(0,3).map(h=>h.join(" / ")).join(" ï½œ ")}</div>`;
Â Â }
Â Â document.getElementById("players").innerHTML = html;
}
drawPlayers();

/* ======================
Â Â ãƒ¬ãƒ¼ã‚¹çŠ¶æ…‹
====================== */
let horses = [];
let order = [];
let surface="èŠ", going="è‰¯", pace="ãƒŸãƒ‰ãƒ«", distance=1600;
let chaos=false;
let cardReady=false;
let bettingClosed=false;

let raf=null;
let lastT=null;
let startT=null;
let tick=0;
let lastLeader=-1;
let lockedBets=[];

let bgx = 0;

/* ======================
Â Â ã‚ªãƒƒã‚ºï¼šä¸­é–“ãŒæ¥µç«¯ã«ãªã‚Šã«ãã„å½¢ + æ¡ä»¶å›ºå®š
====================== */
function styleBias(style, distance, pace){
Â Â let m=1.0;
Â Â if(distance<=1400){ if(style==="é€ƒã’")m*=1.10; if(style==="è¿½è¾¼")m*=0.92; }
Â Â else if(distance<=1800){ if(style==="é€ƒã’")m*=1.05; if(style==="è¿½è¾¼")m*=0.97; }
Â Â else if(distance<=2200){ if(style==="è¿½è¾¼")m*=1.05; }
Â Â else { if(style==="è¿½è¾¼")m*=1.10; if(style==="é€ƒã’")m*=0.93; }
Â Â if(pace==="ãƒã‚¤"){ if(style==="é€ƒã’")m*=0.94; if(style==="è¿½è¾¼")m*=1.06; }
Â Â if(pace==="ã‚¹ãƒ­ãƒ¼"){ if(style==="é€ƒã’")m*=1.06; if(style==="è¿½è¾¼")m*=0.95; }
Â Â return clamp(m,0.85,1.15);
}
function surfaceBias(surface, going){
Â Â let m=1.0;
Â Â if(surface==="ãƒ€ãƒ¼ãƒˆ") m*=1.03;
Â Â if(going==="ç¨é‡") m*=0.99;
Â Â if(going==="é‡") m*=0.97;
Â Â if(going==="ä¸è‰¯") m*=0.95;
Â Â return m;
}
function easeOut(t){ return 1 - Math.pow(1-t, 2); }
function easeIn(t){ return Math.pow(t, 2); }

// è¤‡å‹å€ç‡ï¼šå˜å‹ã‹ã‚‰ã€Œåœ§ç¸®ã€ã—ã¦ä½œã‚‹ï¼ˆå¼·ã™ãå•é¡Œã‚’æŠ‘ãˆã‚‹ï¼‰
function makePlaceOdd(winOdd, popRank){
Â Â // ã ã„ãŸã„ã€Œ1 + (win-1)*0.28ã€œ0.40ã€ãã‚‰ã„
Â Â const k = 0.28 + Math.random()*0.12;Â Â Â Â Â Â Â Â Â Â Â Â Â Â // 0.28..0.40
Â Â let base = 1 + (winOdd - 1) * k;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // åœ§ç¸®
Â Â base *= (0.95 + (popRank-1)*0.02);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // äººæ°—è–„ã»ã©å°‘ã—ä¸Š
Â Â base *= (0.97 + Math.random()*0.06);Â Â Â Â Â Â Â Â Â Â Â Â Â Â // å¾®ãƒ–ãƒ¬
Â Â // ä¸Šé™ã‚‚æŠ‘ãˆã‚‹
Â Â return Number(clamp(base, 1.10, 35.00).toFixed(2));
}

function assignOddsForRace(hs){
Â Â // ç«¯ã®æ¡ä»¶
Â Â const favTargetÂ Â = 2.2 + Math.random()*0.8;Â Â Â Â Â Â Â Â // <=3
Â Â const midTargetÂ Â = 25Â Â + Math.random()*35;Â Â Â Â Â Â Â Â Â // 25..60ï¼ˆä¸­é–“ã®ç›®å®‰ï¼‰
Â Â const lastTarget = 150 + Math.random()*120;Â Â Â Â Â Â Â Â // >=150

Â Â const temp=1.05, noise=0.14;
Â Â const surfM = surfaceBias(surface, going);

Â Â const scores = hs.map(h=>{
Â Â Â Â const streakBoost = 1 + (h.streak||0)*0.07;
Â Â Â Â const condBoost = 0.90 + (h.condition-0.7)*0.6;
Â Â Â Â const styleMult = styleBias(h.style, distance, pace);
Â Â Â Â const base = Math.max(0.01, h.power * streakBoost * condBoost * styleMult * surfM);
Â Â Â Â const logScore = Math.log(base) + (Math.random()*2-1)*noise;
Â Â Â Â return logScore / temp;
Â Â });

Â Â const idx = [...hs.keys()].sort((a,b)=>scores[b]-scores[a]); // å¼·ã„é †=äººæ°—

Â Â // ãƒ©ãƒ³ã‚¯0..9 â†’ 0..4ã¯ favâ†’midã€5..9ã¯ midâ†’last ã®2æ®µ
Â Â idx.forEach((horseIndex, rank)=>{
Â Â Â Â let odd;
Â Â Â Â if(rank <= 4){
Â Â Â Â Â Â const t = rank/4;
Â Â Â Â Â Â odd = favTarget + (midTarget - favTarget) * easeOut(t);
Â Â Â Â }else{
Â Â Â Â Â Â const t = (rank-5)/4;
Â Â Â Â Â Â odd = midTarget + (lastTarget - midTarget) * easeIn(t);
Â Â Â Â }
Â Â Â Â odd *= (0.96 + Math.random()*0.08);

Â Â Â Â if(rank===0) odd = Math.min(3.0, odd);
Â Â Â Â if(rank===9) odd = Math.max(150.0, odd);

Â Â Â Â hs[horseIndex].winOdd = Number(clamp(odd, 1.1, 999.9).toFixed(1));
Â Â });

Â Â // å¿µæŠ¼ã—
Â Â const sorted = [...hs].sort((a,b)=>a.winOdd-b.winOdd);
Â Â sorted[0].winOdd = Number(Math.min(sorted[0].winOdd, 3.0).toFixed(1));
Â Â sorted[9].winOdd = Number(Math.max(sorted[9].winOdd, 150.0).toFixed(1));

Â Â // è¤‡å‹å€ç‡
Â Â const popSorted=[...hs].sort((a,b)=>a.winOdd-b.winOdd);
Â Â const popRank=new Map();
Â Â popSorted.forEach((h,i)=>popRank.set(h.id, i+1));
Â Â hs.forEach(h=>{ h.placeOdd = makePlaceOdd(h.winOdd, popRank.get(h.id)); });
}

/* ======================
Â Â å‡ºèµ°è¡¨ä½œæˆ
====================== */
function makeRaceCard(){
Â Â if(raf) return;

Â Â surface = (Math.random()<0.7) ? "èŠ" : "ãƒ€ãƒ¼ãƒˆ";
Â Â going = (surface==="èŠ") ? (["è‰¯","ç¨é‡","é‡","ä¸è‰¯"][rand(4)]) : (["è‰¯","ç¨é‡","é‡"][rand(3)]);
Â Â pace = ["ã‚¹ãƒ­ãƒ¼","ãƒŸãƒ‰ãƒ«","ãƒã‚¤"][rand(3)];
Â Â distance = rand(1400)+1000;
Â Â chaos = Math.random() < 0.03;

Â Â const names = genUniqueNames(10);
Â Â const styles = ["é€ƒã’","å…ˆè¡Œ","å·®ã—","è¿½è¾¼"];

Â Â horses = horseStats.map((st,i)=>({
Â Â Â Â id:i,
Â Â Â Â name:names[i],
Â Â Â Â style:styles[rand(4)],
Â Â Â Â power:st.powerBase,
Â Â Â Â streak:st.streak||0,
Â Â Â Â condition: Math.random()*0.6+0.7,

Â Â Â Â winOdd:0,
Â Â Â Â placeOdd:0,

Â Â Â Â progress:0,
Â Â Â Â speed:0,
Â Â Â Â fin:false,
Â Â Â Â _finishAt:0,

Â Â Â Â stamina: 0.85 + Math.random()*0.25,
Â Â Â Â accel: 1.1 + Math.random()*0.9,
Â Â Â Â top:Â Â 0.95 + Math.random()*0.35,
Â Â Â Â kick: 1.0 + Math.random()*0.25,
Â Â }));

Â Â assignOddsForRace(horses);

Â Â cardReady=true;
Â Â bettingClosed=false;
Â Â lockedBets=[];
Â Â order=[];
Â Â tick=0; lastLeader=-1; lastT=null; startT=null; bgx=0;

Â Â document.getElementById("btnStart").disabled=false;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
Â Â document.getElementById("liveTag").style.display="none";
Â Â document.getElementById("result").textContent="";
Â Â setCommentary("â€”");

Â Â renderRaceInfo();
Â Â renderOddsTable();
Â Â renderBetUI();
Â Â renderRaceLanes();
Â Â save();
}

function renderRaceInfo(){
Â Â document.getElementById("raceInfo").innerHTML =
Â Â Â Â `<h3 style="margin:0 0 8px">ğŸ“Œ ãƒ¬ãƒ¼ã‚¹æ¡ä»¶</h3>
Â Â Â Â Â ${surface}${going} ï¼ è·é›¢ï¼š<b>${distance}m</b> ï¼ ãƒšãƒ¼ã‚¹ï¼š<b>${pace}</b>
Â Â Â Â Â ${chaos?`<span class="badge">âš ï¸ å¤§è’ã‚Œï¼ˆã”ãç¨€ï¼‰</span>`:""}
Â Â Â Â Â <span class="badge">æ‰•æˆ»ï¼è³­ã‘é‡‘Ã—å€ç‡</span>
Â Â Â Â Â <span class="badge">ç´„${TARGET_SECONDS}ç§’</span>
Â Â Â Â Â <span class="badge">å˜å‹ï¼š1äººæ°—â‰¤3.0 / 10äººæ°—â‰¥150</span>`;
}

function renderOddsTable(){
Â Â if(!horses.length){ document.getElementById("oddsTable").innerHTML=""; return; }
Â Â const sorted=[...horses].sort((a,b)=>a.winOdd-b.winOdd);

Â Â let html = `<h3 style="margin:0 0 8px">ğŸ“Š ã‚ªãƒƒã‚ºè¡¨ï¼ˆäººæ°—é †ï¼‰</h3>
Â Â <table class="table"><thead><tr>
Â Â Â Â <th>äººæ°—</th><th>æ </th><th>é¦¬å</th>
Â Â Â Â <th class="right">å˜å‹</th><th class="right">è¤‡å‹</th>
Â Â </tr></thead><tbody>`;

Â Â sorted.forEach((h,i)=>{
Â Â Â Â html += `<tr>
Â Â Â Â Â Â <td>${i+1}</td>
Â Â Â Â Â Â <td><span class="num ${frameClass(h.id)}">${h.id+1}</span></td>
Â Â Â Â Â Â <td>${h.name}${(h.streak||0)>0?`<span class="badge">é€£å‹:${h.streak}</span>`:""}</td>
Â Â Â Â Â Â <td class="right"><b>${h.winOdd}</b>å€</td>
Â Â Â Â Â Â <td class="right"><b>${h.placeOdd}</b>å€</td>
Â Â Â Â </tr>`;
Â Â });

Â Â html += `</tbody></table>`;
Â Â document.getElementById("oddsTable").innerHTML = html;
}

/* ======================
Â Â è³­ã‘UIï¼ˆæ‰€æŒé‡‘ä»¥ä¸Šã¯è³­ã‘ã‚‰ã‚Œãªã„ + å¤‰ãªå€¤å¯¾ç­–ï¼‰
====================== */
function buildHorseOptions(){
Â Â return horses.map(h=>
Â Â Â Â `<option value="${h.id}">${h.id+1} ${h.name}ï¼ˆå˜å‹${h.winOdd}å€ / è¤‡å‹${h.placeOdd}å€ï¼‰</option>`
Â Â ).join("");
}

function renderBetUI(){
Â Â const wrap = document.getElementById("betUI");
Â Â if(!horses.length){
Â Â Â Â wrap.innerHTML = `<div class="muted">å…ˆã«ã€Œå‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã€ã‚’ä½œã£ã¦ã­ã€‚</div>`;
Â Â Â Â return;
Â Â }
Â Â const opts = buildHorseOptions();
Â Â let html = "";

Â Â players.forEach((p,pi)=>{
Â Â Â Â const disabled = (bettingClosed || p.money<=0) ? "disabled" : "";
Â Â Â Â const note = bettingClosed ? `<span class="bad">ç· åˆ‡</span>` : (p.money<=0 ? `<span class="bad">æ•—é€€</span>` : `<span class="ok">å—ä»˜ä¸­</span>`);
Â Â Â Â const max = Math.max(0, p.money);
Â Â Â Â const v0 = max >= MIN_BET ? MIN_BET : 0;

Â Â Â Â html += `<div class="box" style="margin:10px 0">
Â Â Â Â Â Â <div><b>${p.name}</b>ï¼ˆæ‰€æŒé‡‘ï¼š${p.money}å††ï¼‰ ${note}</div>
Â Â Â Â Â Â <div class="row" style="margin-top:6px">
Â Â Â Â Â Â Â Â <label>åˆ¸ç¨®
Â Â Â Â Â Â Â Â Â Â <select id="type${pi}" ${disabled}>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="win">å˜å‹</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="place">è¤‡å‹</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é¦¬
Â Â Â Â Â Â Â Â Â Â <select id="horse${pi}" ${disabled}>${opts}</select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é‡‘é¡
Â Â Â Â Â Â Â Â Â Â <input id="amt${pi}" type="number" min="0" step="${BET_STEP}" value="${v0}" max="${max}" ${disabled}
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â inputmode="numeric" oninput="capBet(${pi})"/>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <span class="muted">ä¸Šé™ï¼š${max}å††</span>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div id="warn${pi}" class="muted" style="margin-top:6px"></div>
Â Â Â Â </div>`;
Â Â });

Â Â wrap.innerHTML = html;
Â Â players.forEach((_,pi)=>capBet(pi));
}

window.capBet = function(pi){
Â Â const p = players[pi];
Â Â const inp = document.getElementById("amt"+pi);
Â Â const warn = document.getElementById("warn"+pi);
Â Â if(!inp || !warn) return;

Â Â const max = Math.max(0, p.money);
Â Â inp.max = String(max);

Â Â let v = Number(inp.value);
Â Â if(!Number.isFinite(v)) v = 0;
Â Â if(v < 0) v = 0;

Â Â if(max <= 0){
Â Â Â Â inp.value = 0;
Â Â Â Â warn.textContent = "æ‰€æŒé‡‘ãŒ0å††ãªã®ã§è³­ã‘ã‚‰ã‚Œã¾ã›ã‚“ã€‚";
Â Â Â Â return;
Â Â }

Â Â // 100å††å˜ä½ã«ä¸¸ã‚ã‚‹
Â Â v = roundDownStep(v, BET_STEP);

Â Â if(v > max){
Â Â Â Â v = roundDownStep(max, BET_STEP);
Â Â Â Â inp.value = v;
Â Â Â Â warn.textContent = `æ‰€æŒé‡‘ã‚’è¶…ãˆã¦ã„ãŸã®ã§ ${v}å†† ã«ã—ã¾ã—ãŸã€‚`;
Â Â Â Â return;
Â Â }

Â Â if(v > 0 && v < MIN_BET){
Â Â Â Â v = MIN_BET;
Â Â Â Â if(v > max) v = 0;
Â Â Â Â inp.value = v;
Â Â Â Â warn.textContent = (v===0) ? "æ‰€æŒé‡‘ãŒè¶³ã‚Šãªã„ã®ã§è³­ã‘ãªã—ã«ãªã‚Šã¾ã™ã€‚" : "æœ€ä½100å††ãªã®ã§100å††ã«ã—ã¾ã—ãŸã€‚";
Â Â Â Â return;
Â Â }

Â Â inp.value = v;
Â Â warn.textContent = "";
};

/* ======================
Â Â ãƒ¬ãƒ¼ã‚¹è¡¨ç¤ºï¼ˆå‹•ç”»â†’GIFâ†’ğŸï¼‰
====================== */
function renderRaceLanes(){
Â Â let html = "";
Â Â horses.forEach(h=>{
Â Â Â Â html += `<div id="line${h.id}" class="horseLine">
Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â <span class="num ${frameClass(h.id)}">${h.id+1}</span>
Â Â Â Â Â Â Â Â <b>${h.name}</b>
Â Â Â Â Â Â Â Â <span id="goal${h.id}" style="display:none" class="goalTag">GOAL</span>
Â Â Â Â Â Â Â Â <span class="badge">å˜å‹${h.winOdd}å€</span>
Â Â Â Â Â Â Â Â <span class="badge">è¤‡å‹${h.placeOdd}å€</span>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div id="track${h.id}" class="track" style="--bgx:0px">
Â Â Â Â Â Â Â Â <div class="lane"></div>
Â Â Â Â Â Â Â Â <div class="finishLine"></div>

Â Â Â Â Â Â Â Â <div id="shadow${h.id}" class="shadow"></div>

Â Â Â Â Â Â Â Â <video id="horseVid${h.id}" class="horseVideo" muted playsinline loop preload="metadata">
Â Â Â Â Â Â Â Â Â Â <source src="./horse.mp4" type="video/mp4">
Â Â Â Â Â Â Â Â </video>

Â Â Â Â Â Â Â Â <img id="horseGif${h.id}" class="horseIcon" src="./horse.gif" alt="horse">
Â Â Â Â Â Â Â Â <span id="horseEmoji${h.id}" class="horseFallback">ğŸ</span>
Â Â Â Â Â Â </div>
Â Â Â Â </div>`;
Â Â });
Â Â document.getElementById("race").innerHTML = html;

Â Â // åˆæœŸåŒ–
Â Â horses.forEach(h=>{
Â Â Â Â const line = document.getElementById("line"+h.id);
Â Â Â Â if(line) line.classList.remove("top1","top2","top3");
Â Â Â Â const g = document.getElementById("goal"+h.id);
Â Â Â Â if(g) g.style.display="none";
Â Â Â Â setHorseX(h.id, 0, 0, true);
Â Â });

Â Â // GIFã¯èª­ã¿è¾¼ã‚ãŸã‚‰è¡¨ç¤ºã€ãƒ€ãƒ¡ãªã‚‰ğŸ
Â Â attachGifFallbacks();
Â Â // å‹•ç”»ã¯ â€œå†ç”Ÿã§ãã‚‹æ™‚ã ã‘â€ è¡¨ç¤º
Â Â attachVideoFallbacks();
}

function attachGifFallbacks(){
Â Â horses.forEach(h=>{
Â Â Â Â const img = document.getElementById("horseGif"+h.id);
Â Â Â Â const emo = document.getElementById("horseEmoji"+h.id);
Â Â Â Â if(!img || !emo) return;

Â Â Â Â img.onload = ()=>{ img.style.display="inline"; emo.style.display="none"; };
Â Â Â Â img.onerror = ()=>{ img.style.display="none"; emo.style.display="inline"; };
Â Â Â Â // å…ˆã«ä¸€æ—¦ğŸã‚’è¡¨ç¤ºï¼ˆGIFãŒæ¥ãŸã‚‰åˆ‡æ›¿ï¼‰
Â Â Â Â emo.style.display="inline";
Â Â });
}

function hideVideo(id){
Â Â const v = document.getElementById("horseVid"+id);
Â Â if(v){ v.pause(); v.style.display="none"; }
}

function attachVideoFallbacks(){
Â Â horses.forEach(h=>{
Â Â Â Â const v = document.getElementById("horseVid"+h.id);
Â Â Â Â if(!v) return;

Â Â Â Â // åˆæœŸã¯éè¡¨ç¤º
Â Â Â Â v.style.display="none";

Â Â Â Â // canplay ã§ããŸã‚‰è¡¨ç¤ºã—ã¦OK
Â Â Â Â const onCanPlay = ()=>{
Â Â Â Â Â Â v.style.display="inline";
Â Â Â Â };

Â Â Â Â // å¤±æ•—/è©°ã¾ã‚Šç³»ã¯éè¡¨ç¤ºã«ã—ã¦é»’ç®±é˜²æ­¢
Â Â Â Â const onBad = ()=>{ hideVideo(h.id); };

Â Â Â Â v.addEventListener("canplay", onCanPlay, {once:true});
Â Â Â Â v.addEventListener("error", onBad, {once:true});
Â Â Â Â v.addEventListener("stalled", onBad, {once:true});
Â Â Â Â v.addEventListener("abort", onBad, {once:true});
Â Â Â Â v.addEventListener("suspend", ()=>{/*ä½•ã‚‚ã—ãªã„*/}, {once:true});

Â Â Â Â // 0.8ç§’ä»¥å†…ã« canplay ã—ãªã‘ã‚Œã°è«¦ã‚ã¦éè¡¨ç¤ºï¼ˆé»’ã„ç®±å–ã‚Šã“ã¼ã—å¯¾ç­–ï¼‰
Â Â Â Â setTimeout(()=>{
Â Â Â Â Â Â if(v.readyState < 2){ // HAVE_CURRENT_DATA æœªæº€
Â Â Â Â Â Â Â Â hideVideo(h.id);
Â Â Â Â Â Â }
Â Â Â Â }, 800);
Â Â });
}

// idã®è¦‹ãŸç›®æ›´æ–°ï¼ˆæœ¬ç‰©ã£ã½ãï¼šä¸Šä¸‹å‹•ãƒ»å½±ãƒ»å‚¾ãï¼‰
function setHorseX(id, progress01, speed01, isInit=false){
Â Â const x = clamp(progress01, 0, 0.96) * 100;

Â Â const v = document.getElementById("horseVid"+id);
Â Â const img = document.getElementById("horseGif"+id);
Â Â const emo = document.getElementById("horseEmoji"+id);
Â Â const shÂ Â = document.getElementById("shadow"+id);

Â Â // ã‚¬ãƒ­ãƒƒãƒ—ã£ã½ã„ä¸Šä¸‹ï¼ˆé€Ÿåº¦ã§å¼·å¼±ï¼‰
Â Â const bob = isInit ? 0 : Math.sin((progress01*50) + (performance.now()/90)) * (2 + speed01*6);
Â Â const tilt = isInit ? 0 : (-2 + speed01*4); // ã¡ã‚‡ã„å‰å‚¾
Â Â const scale = 1 + speed01*0.05;

Â Â if(sh){
Â Â Â Â sh.style.left = x + "%";
Â Â Â Â const w = 24 + speed01*10;
Â Â Â Â const sx = 1 + speed01*0.35;
Â Â Â Â sh.style.width = w + "px";
Â Â Â Â sh.style.transform = `translateY(0px) scaleX(${sx})`;
Â Â Â Â sh.style.opacity = (0.28 + speed01*0.22).toFixed(2);
Â Â }

Â Â // å‹•ç”»ãŒä½¿ãˆã‚‹ãªã‚‰å‹•ç”»
Â Â if(v && v.style.display !== "none"){
Â Â Â Â v.style.left = x + "%";
Â Â Â Â v.style.transform = `translateY(${bob}px) rotate(${tilt}deg) scale(${scale})`;
Â Â Â Â // speedï¼ˆprogress/ç§’ï¼‰ã«å¿œã˜ã¦å†ç”Ÿé€Ÿåº¦å¤‰æ›´
Â Â Â Â const rate = clamp(0.85 + speed01 * 0.9, 0.8, 1.6);
Â Â Â Â v.playbackRate = rate;
Â Â Â Â return;
Â Â }

Â Â // GIFãŒä½¿ãˆã‚‹ãªã‚‰GIF
Â Â if(img && img.style.display !== "none"){
Â Â Â Â img.style.left = x + "%";
Â Â Â Â img.style.transform = `translateY(${bob*0.6}px) rotate(${tilt}deg) scale(${scale})`;
Â Â Â Â return;
Â Â }

Â Â // æœ€å¾Œã¯ğŸ
Â Â if(emo){
Â Â Â Â emo.style.display="inline";
Â Â Â Â emo.style.left = x + "%";
Â Â Â Â emo.style.transform = `translateY(${bob*0.4}px) rotate(${tilt}deg) scale(${scale})`;
Â Â }
}

/* å…ˆé ­è¿½å°¾ */
function cameraFollow(){
Â Â if(!AUTO_CAMERA) return;
Â Â let leader = horses[0];
Â Â for(const h of horses) if(h.progress > leader.progress) leader = h;
Â Â if(leader.id !== lastLeader){
Â Â Â Â lastLeader = leader.id;
Â Â Â Â document.getElementById("line"+leader.id)?.scrollIntoView({behavior:"smooth", block:"center"});
Â Â }
}

/* åœ°é¢ãŒæµã‚Œã‚‹ï¼ˆå…ˆé ­é€Ÿåº¦ã§ï¼‰ */
function updateGround(dt){
Â Â let leader = horses[0];
Â Â for(const h of horses) if(h.progress > leader.progress) leader = h;
Â Â const v = leader?.speed || 0;
Â Â bgx -= (v * 1100) * dt;
Â Â horses.forEach(h=>{
Â Â Â Â const tr = document.getElementById("track"+h.id);
Â Â Â Â if(tr) tr.style.setProperty("--bgx", `${bgx}px`);
Â Â });
}

/* ======================
Â Â è³­ã‘ã®ç¢ºå®šï¼ˆé–‹å§‹æ™‚ã«ãƒ­ãƒƒã‚¯ï¼‰
====================== */
function lockBets(){
Â Â lockedBets = [];
Â Â players.forEach((p,pi)=>{
Â Â Â Â if(p.money<=0) return;

Â Â Â Â const type = document.getElementById("type"+pi)?.value ?? "win";
Â Â Â Â const horseId = Number(document.getElementById("horse"+pi)?.value);
Â Â Â Â let amt = Number(document.getElementById("amt"+pi)?.value);

Â Â Â Â if(!Number.isFinite(horseId) || horseId<0 || horseId>9) return;
Â Â Â Â if(!Number.isFinite(amt)) amt = 0;
Â Â Â Â if(amt < 0) amt = 0;

Â Â Â Â // 100å††å˜ä½ã«ä¸¸ã‚ã€æ‰€æŒé‡‘ä»¥å†…ã«ã™ã‚‹
Â Â Â Â amt = roundDownStep(amt, BET_STEP);
Â Â Â Â amt = Math.min(amt, p.money);

Â Â Â Â if(amt > 0 && amt < MIN_BET) amt = 0;
Â Â Â Â if(amt >= MIN_BET){
Â Â Â Â Â Â lockedBets.push({pi, type, horseId, amt});
Â Â Â Â }
Â Â });
}

/* ======================
Â Â èµ°ã‚Šï¼ˆ15ç§’ã«å¯„ã›ã‚‹ã‚¿ã‚¤ãƒ è£œæ­£å…¥ã‚Šï¼‰
====================== */
function runFrame(ts){
Â Â if(!startT) startT = ts;
Â Â if(!lastT) lastT = ts;
Â Â const dt = (ts - lastT) / 1000;
Â Â lastT = ts;
Â Â tick++;

Â Â // å®Ÿæ³
Â Â if(tick % 30 === 0){
Â Â Â Â let leader = horses[0];
Â Â Â Â for(const h of horses) if(h.progress > leader.progress) leader = h;
Â Â Â Â setCommentary(`å…ˆé ­ã¯ ${leader.id+1}ç•ª ${leader.name}ï¼`);
Â Â }

Â Â // ç›®æ¨™æ™‚é–“ã«å¯„ã›ã‚‹ãŸã‚ã®å…¨ä½“ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆãƒ–ãƒ¬ã‚’å°ã•ãï¼‰
Â Â const elapsed = (ts - startT) / 1000;
Â Â let leaderP = 0;
Â Â for(const h of horses) leaderP = Math.max(leaderP, h.progress);
Â Â const remainTime = Math.max(0.7, TARGET_SECONDS - elapsed);
Â Â const remainDist = Math.max(0.001, 1 - leaderP);
Â Â const desiredLeaderSpeed = remainDist / remainTime;Â Â Â Â Â Â // progress/ç§’
Â Â const baseAvg = 1 / TARGET_SECONDS;
Â Â const timeScale = clamp(desiredLeaderSpeed / baseAvg, 0.75, 1.35);

Â Â for(const h of horses){
Â Â Â Â if(h.fin) continue;

Â Â Â Â const p = h.progress;

Â Â Â Â // ã‚¹ã‚¿ãƒŸãƒŠ
Â Â Â Â const staminaDrop = 1 - (p * (0.55 / h.stamina));
Â Â Â Â const staminaMult = clamp(staminaDrop, 0.55, 1.05);

Â Â Â Â // ãƒ©ã‚¹ãƒˆã‚¹ãƒ‘ãƒ¼ãƒˆ
Â Â Â Â const kickZone = p > 0.80 ? (1 + (p-0.80)/0.20 * (h.kick-1)) : 1;

Â Â Â Â // è„šè³ªã®é›°å›²æ°—
Â Â Â Â let styleMult = 1.0;
Â Â Â Â if(h.style==="é€ƒã’") styleMult *= (p<0.35 ? 1.10 : 0.98);
Â Â Â Â if(h.style==="å…ˆè¡Œ") styleMult *= (p<0.55 ? 1.06 : 1.00);
Â Â Â Â if(h.style==="å·®ã—") styleMult *= (p<0.55 ? 1.00 : 1.05);
Â Â Â Â if(h.style==="è¿½è¾¼") styleMult *= (p<0.60 ? 0.98 : 1.10);

Â Â Â Â // ãƒšãƒ¼ã‚¹
Â Â Â Â if(pace==="ãƒã‚¤"){
Â Â Â Â Â Â if(h.style==="é€ƒã’") styleMult *= 0.96;
Â Â Â Â Â Â if(h.style==="è¿½è¾¼") styleMult *= 1.05;
Â Â Â Â }
Â Â Â Â if(pace==="ã‚¹ãƒ­ãƒ¼"){
Â Â Â Â Â Â if(h.style==="é€ƒã’") styleMult *= 1.05;
Â Â Â Â Â Â if(h.style==="è¿½è¾¼") styleMult *= 0.97;
Â Â Â Â }

Â Â Â Â // åœ°åŠ›ãƒ»èª¿å­ãƒ»é€£å‹
Â Â Â Â const powerMult = (0.85 + h.power*0.06) * (0.92 + (h.condition-0.7)*0.7) * (1 + (h.streak||0)*0.05);

Â Â Â Â // å¤§è’ã‚Œï¼ˆå¾®ãƒ–ãƒ¬å¢—ï¼‰
Â Â Â Â const chaosMult = chaos ? (0.88 + Math.random()*0.30) : 1.0;

Â Â Â Â // æœ€é«˜é€Ÿï¼ˆtimeScaleã§å…¨ä½“æ™‚é–“ã‚’å¯„ã›ã‚‹ï¼‰
Â Â Â Â const topSpeed = baseAvg * (0.75 + h.top*0.55) * powerMult * staminaMult * styleMult * kickZone * chaosMult * timeScale;

Â Â Â Â // åŠ é€Ÿã§è¿‘ã¥ã‘ã‚‹
Â Â Â Â const accel = h.accel * (0.9 + Math.random()*0.2);
Â Â Â Â h.speed += (topSpeed - h.speed) * clamp(accel*dt, 0, 1);

Â Â Â Â // å°ã•ã„ãƒ–ãƒ¬
Â Â Â Â const wobble = 1 + (Math.random()*2-1) * 0.025;
Â Â Â Â h.progress += h.speed * dt * wobble;

Â Â Â Â if(h.progress >= 1){
Â Â Â Â Â Â h.progress = 1;
Â Â Â Â Â Â h.fin = true;
Â Â Â Â Â Â h._finishAt = performance.now();
Â Â Â Â Â Â order.push(h);

Â Â Â Â Â Â // ã‚´ãƒ¼ãƒ«ã—ãŸã‚‰ â€œå°‘ã—æ¸›é€Ÿã—ã¦æ­¢ã¾ã‚‹â€ ã£ã½ã
Â Â Â Â Â Â const v = document.getElementById("horseVid"+h.id);
Â Â Â Â Â Â if(v && v.style.display !== "none"){
Â Â Â Â Â Â Â Â v.playbackRate = 0.85;
Â Â Â Â Â Â Â Â setTimeout(()=>{ try{ v.pause(); }catch(e){} }, 600);
Â Â Â Â Â Â }

Â Â Â Â Â Â const g = document.getElementById("goal"+h.id);
Â Â Â Â Â Â if(g) g.style.display="inline-block";
Â Â Â Â }

Â Â Â Â // speed01ï¼ˆè¦‹ãŸç›®ç”¨ï¼‰ã‚’0..1ã«
Â Â Â Â const speed01 = clamp(h.speed / (baseAvg*1.8), 0, 1);
Â Â Â Â setHorseX(h.id, h.progress, speed01);
Â Â }

Â Â updateGround(dt);
Â Â cameraFollow();

Â Â if(order.length >= 10){
Â Â Â Â finishRace();
Â Â Â Â return;
Â Â }
Â Â raf = requestAnimationFrame(runFrame);
}

/* ======================
Â Â ç²¾ç®—ï¼šæ‰•æˆ»ï¼è³­ã‘é‡‘Ã—å€ç‡ï¼ˆé¸æŠã—ãŸé¦¬ãƒ»åˆ¸ç¨®ã§ï¼‰
====================== */
function settleBets(){
Â Â order.sort((a,b)=>a._finishAt - b._finishAt);

Â Â const first=order[0], second=order[1], third=order[2];
Â Â const top3 = new Set([first.id, second.id, third.id]);

Â Â // ã¾ãšè³­ã‘é‡‘ã‚’å¼•ãï¼ˆæ‰€æŒé‡‘ä»¥å†…ã§ãƒ­ãƒƒã‚¯æ¸ˆï¼‰
Â Â for(const b of lockedBets){
Â Â Â Â const p = players[b.pi];
Â Â Â Â if(!p || p.money<=0) continue;
Â Â Â Â p.money -= b.amt;
Â Â }

Â Â let log = [];
Â Â for(const b of lockedBets){
Â Â Â Â const p = players[b.pi];
Â Â Â Â const h = horses[b.horseId];
Â Â Â Â if(!p || !h) continue;

Â Â Â Â if(b.type==="win"){
Â Â Â Â Â Â if(b.horseId === first.id){
Â Â Â Â Â Â Â Â const back = yen(b.amt * h.winOdd);
Â Â Â Â Â Â Â Â p.money += back;
Â Â Â Â Â Â Â Â log.push(`${p.name}: å˜å‹ ${b.horseId+1} ${b.amt}å†† â†’ çš„ä¸­ï¼ æ‰•æˆ» ${back}å††ï¼ˆ${h.winOdd}å€ï¼‰`);
Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â log.push(`${p.name}: å˜å‹ ${b.horseId+1} ${b.amt}å†† â†’ ãƒã‚ºãƒ¬`);
Â Â Â Â Â Â }
Â Â Â Â }else{
Â Â Â Â Â Â if(top3.has(b.horseId)){
Â Â Â Â Â Â Â Â const back = yen(b.amt * h.placeOdd);
Â Â Â Â Â Â Â Â p.money += back;
Â Â Â Â Â Â Â Â log.push(`${p.name}: è¤‡å‹ ${b.horseId+1} ${b.amt}å†† â†’ çš„ä¸­ï¼ æ‰•æˆ» ${back}å††ï¼ˆ${h.placeOdd}å€ï¼‰`);
Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â log.push(`${p.name}: è¤‡å‹ ${b.horseId+1} ${b.amt}å†† â†’ ãƒã‚ºãƒ¬`);
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }

Â Â return {log, first, second, third};
}

/* ======================
Â Â çµ‚äº†
====================== */
function finishRace(){
Â Â cancelAnimationFrame(raf); raf=null;
Â Â lastT=null;

Â Â order.sort((a,b)=>a._finishAt - b._finishAt);
Â Â const first=order[0], second=order[1], third=order[2];

Â Â document.getElementById("line"+first.id)?.classList.add("top1");
Â Â document.getElementById("line"+second.id)?.classList.add("top2");
Â Â document.getElementById("line"+third.id)?.classList.add("top3");

Â Â const settle = settleBets();

Â Â // é€£å‹æ›´æ–°
Â Â const winnerId = first.id;
Â Â for(let i=0;i<10;i++){
Â Â Â Â if(i===winnerId){
Â Â Â Â Â Â horseStats[i].wins = (horseStats[i].wins||0) + 1;
Â Â Â Â Â Â horseStats[i].streak = (horseStats[i].streak||0) + 1;
Â Â Â Â }else{
Â Â Â Â Â Â horseStats[i].streak = 0;
Â Â Â Â }
Â Â }

Â Â history.unshift([first.name, second.name, third.name]);
Â Â if(history.length>20) history.pop();

Â Â let txt = "ğŸ çµæœï¼ˆå…¨ç€é †ï¼‰\n";
Â Â order.forEach((h,i)=>{
Â Â Â Â txt += `${i+1}ç€ ${h.id+1} ${h.name}ï¼ˆå˜å‹${h.winOdd}å€ / è¤‡å‹${h.placeOdd}å€ï¼‰\n`;
Â Â });

Â Â txt += `\nã€å€ç‡ã€‘\n`;
Â Â txt += `å˜å‹ï¼š${first.id+1} ${first.winOdd}å€\n`;
Â Â txt += `è¤‡å‹ï¼ˆ3é ­ï¼‰ï¼š${first.id+1} ${first.placeOdd}å€ / ${second.id+1} ${second.placeOdd}å€ / ${third.id+1} ${third.placeOdd}å€\n`;

Â Â txt += `\nã€ç²¾ç®—ãƒ­ã‚°ã€‘\n` + settle.log.map(s=>"ãƒ»"+s).join("\n") + "\n";
Â Â document.getElementById("result").textContent = txt;

Â Â drawPlayers();
Â Â save();

Â Â bettingClosed=false;
Â Â cardReady=false;
Â Â lockedBets=[];

Â Â document.getElementById("btnStart").disabled=true;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
Â Â document.getElementById("btnCard").disabled=false;
Â Â document.getElementById("liveTag").style.display="none";
Â Â setCommentary("ãƒ¬ãƒ¼ã‚¹çµ‚äº†ï¼");
Â Â renderBetUI();
}

/* =======
