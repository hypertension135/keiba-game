<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆPCå‘ã‘ å®Œæˆç‰ˆï¼‰</title>
<style>
Â Â body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f5f5f5;color:#111;margin:0;padding:12px}
Â Â h2{background:#0b8f3c;color:#fff;padding:10px;border-radius:10px;margin:0 0 10px}
Â Â .box{background:#fff;border:1px solid #d0d0d0;border-radius:12px;padding:10px;margin:10px 0}
Â Â .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
Â Â button{padding:10px 12px;border:0;border-radius:10px;background:#0b8f3c;color:#fff;font-weight:900}
Â Â button.secondary{background:#333}
Â Â button:disabled{opacity:.45}
Â Â select,input{padding:8px;border-radius:10px;border:1px solid #ccc}
Â Â .muted{color:#666;font-size:13px}
Â Â .bad{display:inline-block;background:#ffecec;border:1px solid #ffb3b3;color:#7a0000;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .ok{display:inline-block;background:#eaffea;border:1px solid #b9f2b9;color:#0b5a0b;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .badge{display:inline-block;background:#eef6ff;border:1px solid #cfe6ff;color:#0a4a8a;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .live{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#e8f0ff;border:1px solid #cfe0ff;color:#143a86;font-size:12px;font-weight:900}
Â Â .goalTag{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#fff3cd;border:1px solid #ffe08a;color:#7a5a00;font-size:12px;font-weight:900;display:none}

Â Â .table{width:100%;border-collapse:collapse;font-size:14px}
Â Â .table th,.table td{border-bottom:1px solid #e7e7e7;padding:8px 6px;text-align:left;vertical-align:top}
Â Â .table th{background:#f2f2f2}
Â Â .right{text-align:right}

Â Â #raceWrap{position:sticky;top:0;z-index:9;background:#fff;border:2px solid #0b8f3c;border-radius:14px;padding:10px}
Â Â .trackRow{display:grid;grid-template-columns:1fr;gap:8px;max-height:52vh;overflow:auto;border-radius:12px}
Â Â .horseLine{background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px}
Â Â .horseLine.top1{outline:3px solid #ffd400}
Â Â .horseLine.top2{outline:3px solid #c0c0c0}
Â Â .horseLine.top3{outline:3px solid #cd7f32}

Â Â .track{
Â Â Â Â position:relative;height:44px;border-radius:12px;overflow:hidden;margin-top:6px;
Â Â Â Â background:
Â Â Â Â Â Â linear-gradient(#141414, #101010),
Â Â Â Â Â Â repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 1px, transparent 1px 72px);
Â Â Â Â background-size: 100% 100%, 72px 100%;
Â Â Â Â background-position: 0 0, var(--bgx, 0px) 0;
Â Â }
Â Â .finishLine{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.8}
Â Â .lane{position:absolute;left:0;top:50%;width:100%;height:1px;background:#2b2b2b}

Â Â .shadow{
Â Â Â Â position:absolute; left:0%; top:31px;
Â Â Â Â width:28px; height:6px; border-radius:50%;
Â Â Â Â background:rgba(0,0,0,.35);
Â Â Â Â filter: blur(1px);
Â Â Â Â transform-origin:center;
Â Â }

Â Â .horseSprite{
Â Â Â Â position:absolute; left:0%; top:7px;
Â Â Â Â width:46px; height:46px;
Â Â Â Â background-repeat:no-repeat;
Â Â Â Â background-color:transparent;
Â Â Â Â transform-origin:center;
Â Â Â Â filter: drop-shadow(0 2px 2px rgba(0,0,0,.35));
Â Â Â Â display:none;
Â Â Â Â border-radius:8px;
Â Â }
Â Â .horseEmoji{
Â Â Â Â position:absolute; left:0%; top:12px;
Â Â Â Â font-size:18px; display:inline;
Â Â Â Â transform-origin:center; user-select:none;
Â Â Â Â filter: drop-shadow(0 2px 2px rgba(0,0,0,.35));
Â Â }
Â Â .onHorseLabel{
Â Â Â Â position:absolute; left:0%; top:-2px;
Â Â Â Â transform: translate(-4px, -12px);
Â Â Â Â font-size:11px; font-weight:900;
Â Â Â Â color:#fff; background:rgba(0,0,0,.55);
Â Â Â Â border:1px solid rgba(255,255,255,.25);
Â Â Â Â padding:2px 6px; border-radius:999px;
Â Â Â Â white-space:nowrap;
Â Â }

Â Â pre{white-space:pre-wrap;background:#111;color:#eaeaea;border-radius:12px;padding:10px;overflow:auto}
</style>
</head>
<body>

<h2>ğŸ‡ ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆPCå‘ã‘ï¼šæ‰‹é †è¾¼ã¿å®Œæˆç‰ˆï¼‰</h2>

<div class="box">
Â Â <h3 style="margin:0 0 8px">âœ… PCã§ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆè¶…é‡è¦ï¼‰</h3>
Â Â <ol style="margin:0 0 0 18px">
Â Â Â Â <li>ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã‚‹ï¼šåå‰ <b>keiba</b></li>
Â Â Â Â <li>é¦¬ç”»åƒã‚’ãã®ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã¦ã€åå‰ã‚’ <b>horse_sprite.png</b> ã«ã™ã‚‹</li>
Â Â Â Â <li>ã“ã®ãƒšãƒ¼ã‚¸è‡ªä½“ï¼ˆindex.htmlï¼‰ã‚‚åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã™ã‚‹</li>
Â Â Â Â <li><b>index.html</b> ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã</li>
Â Â </ol>
Â Â <div class="muted" style="margin-top:8px">
Â Â Â Â â€»ç”»åƒãŒèª­ã‚ãªãã¦ã‚‚ğŸã§å¿…ãšèµ°ã‚Šã¾ã™
Â Â </div>
</div>

<div class="box" id="players"></div>

<div class="box">
Â Â <div class="row">
Â Â Â Â <button id="btnCard" onclick="makeRaceCard()">å‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã‚’ä½œã‚‹</button>
Â Â Â Â <button id="btnStart" class="secondary" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰</button>
Â Â Â Â <button class="secondary" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
Â Â </div>
Â Â <div class="muted" style="margin-top:8px">
Â Â Â Â ãƒ»ãƒ¬ãƒ¼ã‚¹é–‹å§‹æ™‚ã« <b>é¦¬ç•ªå·/å˜å‹orè¤‡å‹/é‡‘é¡/å€ç‡</b> ã‚’ãƒ­ãƒƒã‚¯ â†’ <b>çµ¶å¯¾ã‚ºãƒ¬ãªã„</b><br>
Â Â Â Â ãƒ»å½“ãŸã‚Šï¼šæ‰€æŒé‡‘ï¼‹(è³­ã‘é‡‘Ã—å€ç‡)ï¼å¤–ã‚Œï¼šæ‰€æŒé‡‘âˆ’(è³­ã‘é‡‘)ï¼0å††ã ã‘GO<br>
Â Â Â Â ãƒ»ç›®æ¨™ãƒ¬ãƒ¼ã‚¹æ™‚é–“ï¼š<b>ç´„15ç§’</b>
Â Â </div>
</div>

<div class="box" id="raceInfo"></div>
<div class="box" id="oddsTable"></div>

<div class="box">
Â Â <h3 style="margin:0 0 8px">ğŸŸï¸ è³­ã‘ï¼ˆå˜å‹ / è¤‡å‹ï¼‰</h3>
Â Â <div id="betUI"></div>
Â Â <div id="lockedUI" class="muted"></div>
</div>

<div class="box" id="raceWrap">
Â Â <div class="row" style="justify-content:space-between;align-items:center">
Â Â Â Â <h3 style="margin:0">ğŸ ãƒ¬ãƒ¼ã‚¹ <span id="liveTag" style="display:none" class="live">LIVE</span></h3>
Â Â Â Â <div class="muted">å®Ÿæ³ï¼š<span id="commentary">â€”</span></div>
Â Â </div>
Â Â <div id="race" class="trackRow"></div>
</div>

<pre id="result"></pre>

<script>
const SPRITE_FILE = "horse_sprite.png";
let spriteOK=false, spriteCols=6, spriteRows=4, spriteFrames=24;

function detectGrid(w,h){
Â Â let best=null;
Â Â for(let f=32; f<=512; f++){
Â Â Â Â if(w%f===0 && h%f===0){
Â Â Â Â Â Â const cols=w/f, rows=h/f, frames=cols*rows;
Â Â Â Â Â Â if(frames>=8 && frames<=48){
Â Â Â Â Â Â Â Â const score=Math.abs(frames-24)+Math.abs(cols-6)*0.4+Math.abs(rows-4)*0.4;
Â Â Â Â Â Â Â Â if(!best || score<best.score) best={cols,rows,frames,score};
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
Â Â return best ? {cols:best.cols, rows:best.rows} : {cols:6, rows:4};
}
function applySpriteStyle(){
Â Â spriteFrames=spriteCols*spriteRows;
Â Â document.querySelectorAll(".horseSprite").forEach(el=>{
Â Â Â Â el.style.backgroundImage=`url('./${SPRITE_FILE}')`;
Â Â Â Â el.style.backgroundSize=`${spriteCols*100}% ${spriteRows*100}%`;
Â Â });
}
function loadSprite(){
Â Â const img=new Image();
Â Â img.onload=()=>{
Â Â Â Â spriteOK=true;
Â Â Â Â const g=detectGrid(img.naturalWidth,img.naturalHeight);
Â Â Â Â spriteCols=g.cols; spriteRows=g.rows;
Â Â Â Â applySpriteStyle();
Â Â };
Â Â img.onerror=()=>{ spriteOK=false; };
Â Â img.src="./"+SPRITE_FILE;
}
loadSprite();

const KEY="keiba_sprite_lock_v1";
const TARGET_SECONDS=15;
const MIN_BET=100;
const STEP=100;
const rand=n=>Math.floor(Math.random()*n);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const floorStep=v=>Math.floor(v/STEP)*STEP;
const yen=n=>Math.floor(n);
function setCommentary(t){ document.getElementById("commentary").textContent=t; }

const syll=["ã‚µãƒ³","ãƒ©ã‚¤","ãƒ–ãƒ¬","ãƒ•ã‚¡","ãƒ‰","ãƒ«","ã‚«","ã‚°","ãƒ´","ãƒŠ","ãƒˆ","ã‚­","ãƒ©","ã‚¹","ã‚»ã‚¤","ãƒ¦ã‚¦","ã‚ªã‚¦","ã‚·ãƒ³","ãƒãƒ«","ãƒ†ãƒ„","ãƒ’ãƒ¡","ã‚¼ãƒ³","ãƒŸãƒ¤","ã‚¢ã‚­","ãƒ›ã‚·","ã‚«ã‚¼","ãƒ„ã‚­","ãƒ¦ãƒ¡"];
function genName(){ let s=""; const parts=2+rand(2); for(let i=0;i<parts;i++) s+=syll[rand(syll.length)]; return s; }
function genUniqueNames(n){ const set=new Set(); while(set.size<n) set.add(genName()); return [...set]; }

let players=[{name:"P1",money:1500,dead:false},{name:"P2",money:1500,dead:false},{name:"P3",money:1500,dead:false}];
let horseStats=Array.from({length:10},()=>({powerBase:1.8+Math.random()*4.8,streak:0,wins:0}));
let history=[];
function save(){ try{ localStorage.setItem(KEY, JSON.stringify({players,horseStats,history})); }catch(e){} }
function load(){ try{ const raw=localStorage.getItem(KEY); if(!raw) return; const d=JSON.parse(raw); if(d?.players) players=d.players; if(d?.horseStats) horseStats=d.horseStats; if(d?.history) history=d.history; }catch(e){} }
load();

function drawPlayers(){
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ’° æ‰€æŒé‡‘</h3>`;
Â Â players.forEach(p=>{
Â Â Â Â const tag=(p.money<=0||p.dead)?`<span class="bad">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</span>`:"";
Â Â Â Â html+=`<div>${p.name}ï¼š<b>${p.money}</b>å†† ${tag}</div>`;
Â Â });
Â Â document.getElementById("players").innerHTML=html;
}
drawPlayers();

let horses=[], order=[];
let surface="èŠ", going="è‰¯", pace="ãƒŸãƒ‰ãƒ«", distance=1600, chaos=false;
let cardReady=false, bettingClosed=false;
let lockedBets=[];
let raf=null,lastT=null,startT=null,tick=0,bgx=0,lastLeader=-1;

function easeOut(t){ return 1-Math.pow(1-t,2); }
function easeIn(t){ return Math.pow(t,2); }
function makePlaceOdd(winOdd,popRank){
Â Â const k=0.28+Math.random()*0.12;
Â Â let base=1+(winOdd-1)*k;
Â Â base*=(0.95+(popRank-1)*0.02);
Â Â base*=(0.97+Math.random()*0.06);
Â Â return Number(clamp(base,1.10,35.00).toFixed(2));
}
function assignOddsForRace(hs){
Â Â const fav=2.2+Math.random()*0.8;
Â Â const mid=25+Math.random()*35;
Â Â const last=150+Math.random()*120;

Â Â const scores=hs.map(h=>Math.log(Math.max(0.01,h.power)) + (Math.random()*2-1)*0.12);
Â Â const idx=[...hs.keys()].sort((a,b)=>scores[b]-scores[a]);

Â Â idx.forEach((hid,rank)=>{
Â Â Â Â let odd;
Â Â Â Â if(rank<=4){
Â Â Â Â Â Â const t=rank/4; odd=fav+(mid-fav)*easeOut(t);
Â Â Â Â }else{
Â Â Â Â Â Â const t=(rank-5)/4; odd=mid+(last-mid)*easeIn(t);
Â Â Â Â }
Â Â Â Â odd*=(0.96+Math.random()*0.08);
Â Â Â Â if(rank===0) odd=Math.min(3.0,odd);
Â Â Â Â if(rank===9) odd=Math.max(150.0,odd);
Â Â Â Â hs[hid].winOdd=Number(clamp(odd,1.1,999.9).toFixed(1));
Â Â });

Â Â const popSorted=[...hs].sort((a,b)=>a.winOdd-b.winOdd);
Â Â const popRank=new Map(); popSorted.forEach((h,i)=>popRank.set(h.id,i+1));
Â Â hs.forEach(h=>h.placeOdd=makePlaceOdd(h.winOdd,popRank.get(h.id)));
}

function renderRaceInfo(){
Â Â document.getElementById("raceInfo").innerHTML=
Â Â Â Â `<h3 style="margin:0 0 8px">ğŸ“Œ ãƒ¬ãƒ¼ã‚¹æ¡ä»¶</h3>
Â Â Â Â Â ${surface}${going} ï¼ è·é›¢ï¼š<b>${distance}m</b> ï¼ ãƒšãƒ¼ã‚¹ï¼š<b>${pace}</b>
Â Â Â Â Â ${chaos?`<span class="badge">âš ï¸ å¤§è’ã‚Œ</span>`:""}
Â Â Â Â Â <span class="badge">ç´„${TARGET_SECONDS}ç§’</span>`;
}
function renderOddsTable(){
Â Â const sorted=[...horses].sort((a,b)=>a.winOdd-b.winOdd);
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ“Š ã‚ªãƒƒã‚ºè¡¨ï¼ˆäººæ°—é †ï¼‰</h3>
Â Â <table class="table"><thead><tr>
Â Â Â Â <th>äººæ°—</th><th>é¦¬ç•ª</th><th>é¦¬å</th><th class="right">å˜å‹</th><th class="right">è¤‡å‹</th>
Â Â </tr></thead><tbody>`;
Â Â sorted.forEach((h,i)=>{
Â Â Â Â html+=`<tr><td>${i+1}</td><td>${h.id+1}</td><td>${h.name}</td>
Â Â Â Â Â Â <td class="right"><b>${h.winOdd}</b>å€</td><td class="right"><b>${h.placeOdd}</b>å€</td></tr>`;
Â Â });
Â Â html+=`</tbody></table>`;
Â Â document.getElementById("oddsTable").innerHTML=html;
}
function buildHorseOptions(){
Â Â return horses.map(h=>`<option value="${h.id}">${h.id+1} ${h.name}ï¼ˆå˜å‹${h.winOdd}å€/è¤‡å‹${h.placeOdd}å€ï¼‰</option>`).join("");
}
function renderBetUI(){
Â Â const wrap=document.getElementById("betUI");
Â Â if(!horses.length){ wrap.innerHTML=`<div class="muted">å…ˆã«å‡ºèµ°è¡¨ã‚’ä½œã£ã¦ã­ã€‚</div>`; return; }

Â Â const opts=buildHorseOptions();
Â Â let html="";
Â Â players.forEach((p,pi)=>{
Â Â Â Â const dead=(p.money<=0||p.dead);
Â Â Â Â const disabled=(bettingClosed||dead)?"disabled":"";
Â Â Â Â const note=bettingClosed?`<span class="bad">ç· åˆ‡</span>`:(dead?`<span class="bad">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</span>`:`<span class="ok">å—ä»˜ä¸­</span>`);
Â Â Â Â const max=Math.max(0,p.money);
Â Â Â Â const v0=(max>=MIN_BET)?MIN_BET:0;

Â Â Â Â html+=`<div class="box" style="margin:10px 0">
Â Â Â Â Â Â <div><b>${p.name}</b>ï¼ˆæ‰€æŒé‡‘ï¼š${p.money}å††ï¼‰ ${note}</div>
Â Â Â Â Â Â <div class="row" style="margin-top:6px">
Â Â Â Â Â Â Â Â <label>åˆ¸ç¨®
Â Â Â Â Â Â Â Â Â Â <select id="type${pi}" ${disabled}>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="win">å˜å‹</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="place">è¤‡å‹</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é¦¬
Â Â Â Â Â Â Â Â Â Â <select id="horse${pi}" ${disabled}>${opts}</select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é‡‘é¡
Â Â Â Â Â Â Â Â Â Â <input id="amt${pi}" type="number" min="0" step="${STEP}" value="${v0}" max="${max}" ${disabled}
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â inputmode="numeric" oninput="capBet(${pi})"/>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <span class="muted">ä¸Šé™ï¼š${max}å††</span>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div id="warn${pi}" class="muted" style="margin-top:6px"></div>
Â Â Â Â </div>`;
Â Â });
Â Â wrap.innerHTML=html;
Â Â players.forEach((_,pi)=>capBet(pi));
}
window.capBet=function(pi){
Â Â const p=players[pi];
Â Â const inp=document.getElementById("amt"+pi);
Â Â const warn=document.getElementById("warn"+pi);
Â Â if(!inp||!warn) return;

Â Â const max=Math.max(0,p.money);
Â Â inp.max=String(max);

Â Â let v=Number(inp.value);
Â Â if(!Number.isFinite(v)||v<0) v=0;
Â Â v=floorStep(v);
Â Â if(v>max) v=floorStep(max);
Â Â if(v>0&&v<MIN_BET) v=MIN_BET;
Â Â if(v>max) v=0;

Â Â inp.value=v;
Â Â warn.textContent=(v===0 && max>0)?"0å††ï¼è³­ã‘ãªã—":"";
};

function renderLockedUI(){
Â Â const box=document.getElementById("lockedUI");
Â Â if(!lockedBets.length){
Â Â Â Â box.innerHTML=bettingClosed?`<span class="bad">è³­ã‘ãªã—ï¼ˆã¾ãŸã¯å…¨å“¡ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰</span>`:"";
Â Â Â Â return;
Â Â }
Â Â const lines=lockedBets.map(b=>{
Â Â Â Â const h=horses[b.horseId];
Â Â Â Â const kind=b.type==="win"?"å˜å‹":"è¤‡å‹";
Â Â Â Â return `${players[b.pi].name}ï¼š${kind} ${b.horseId+1}ç•ª ${h.name}Â Â ${b.amt}å††ï¼ˆå€ç‡ ${b.odd}å€ â†ãƒ­ãƒƒã‚¯ï¼‰`;
Â Â });
Â Â box.innerHTML=`<div class="badge">ğŸ”’ ãƒ­ãƒƒã‚¯æ¸ˆã¿è³­ã‘ï¼ˆã‚ºãƒ¬é˜²æ­¢ï¼‰</div><div style="margin-top:6px">${lines.join("<br>")}</div>`;
}

function renderRaceLanes(){
Â Â let html="";
Â Â horses.forEach(h=>{
Â Â Â Â html+=`<div id="line${h.id}" class="horseLine">
Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â <b>${h.id+1} ${h.name}</b>
Â Â Â Â Â Â Â Â <span id="goal${h.id}" class="goalTag">GOAL</span>
Â Â Â Â Â Â Â Â <span class="badge">å˜å‹${h.winOdd}å€</span><span class="badge">è¤‡å‹${h.placeOdd}å€</span>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div id="track${h.id}" class="track" style="--bgx:0px">
Â Â Â Â Â Â Â Â <div class="lane"></div><div class="finishLine"></div>
Â Â Â Â Â Â Â Â <div id="shadow${h.id}" class="shadow"></div>
Â Â Â Â Â Â Â Â <div id="label${h.id}" class="onHorseLabel">${h.id+1} ${h.name}</div>
Â Â Â Â Â Â Â Â <div id="spr${h.id}" class="horseSprite"></div>
Â Â Â Â Â Â Â Â <span id="emo${h.id}" class="horseEmoji">ğŸ</span>
Â Â Â Â Â Â </div>
Â Â Â Â </div>`;
Â Â });
Â Â document.getElementById("race").innerHTML=html;
Â Â if(spriteOK) applySpriteStyle();
Â Â horses.forEach(h=>{ document.getElementById("goal"+h.id).style.display="none"; setHorseX(h.id,0,0,true); });
}
function setSpriteFrame(id,s01){
Â Â const spr=document.getElementById("spr"+id);
Â Â if(!spr) return;
Â Â const ms=clamp(140 - s01*90, 55, 140);
Â Â const idx=Math.floor(performance.now()/ms) % Math.max(1,spriteFrames);
Â Â const col=(spriteCols>0)?(idx%spriteCols):0;
Â Â const row=(spriteCols>0)?Math.floor(idx/spriteCols):0;
Â Â const x=(spriteCols<=1)?0:(col*100/(spriteCols-1));
Â Â const y=(spriteRows<=1)?0:(row*100/(spriteRows-1));
Â Â spr.style.backgroundPosition=`${x}% ${y}%`;
}
function setHorseX(id,p01,s01,init=false){
Â Â const x=clamp(p01,0,0.96)*100;
Â Â const sh=document.getElementById("shadow"+id);
Â Â const spr=document.getElementById("spr"+id);
Â Â const emo=document.getElementById("emo"+id);
Â Â const lab=document.getElementById("label"+id);

Â Â const bob=init?0:Math.sin((p01*60)+(performance.now()/85))*(2+s01*6);
Â Â const tilt=init?0:(-2+s01*4);
Â Â const scale=1+s01*0.06;

Â Â if(sh){
Â Â Â Â sh.style.left=x+"%";
Â Â Â Â sh.style.width=(26+s01*12)+"px";
Â Â Â Â sh.style.opacity=(0.28+s01*0.25).toFixed(2);
Â Â Â Â sh.style.transform=`scaleX(${1+s01*0.35})`;
Â Â }
Â Â if(lab) lab.style.left=x+"%";

Â Â if(spriteOK && spr){
Â Â Â Â spr.style.display="block";
Â Â Â Â spr.style.left=x+"%";
Â Â Â Â spr.style.transform=`translateY(${bob*0.35}px) rotate(${tilt}deg) scale(${scale})`;
Â Â Â Â setSpriteFrame(id,s01);
Â Â Â Â if(emo) emo.style.display="none";
Â Â }else{
Â Â Â Â if(spr) spr.style.display="none";
Â Â Â Â if(emo){
Â Â Â Â Â Â emo.style.display="inline";
Â Â Â Â Â Â emo.style.left=x+"%";
Â Â Â Â Â Â emo.style.transform=`translateY(${bob*0.35}px) rotate(${tilt}deg) scale(${scale})`;
Â Â Â Â }
Â Â }
}

function lockBets(){
Â Â lockedBets=[];
Â Â players.forEach((p,pi)=>{
Â Â Â Â if(p.money<=0 || p.dead) return;
Â Â Â Â const type=document.getElementById("type"+pi)?.value ?? "win";
Â Â Â Â const horseId=Number(document.getElementById("horse"+pi)?.value);
Â Â Â Â let amt=Number(document.getElementById("amt"+pi)?.value);

Â Â Â Â if(!Number.isFinite(horseId)||horseId<0||horseId>9) return;
Â Â Â Â if(!Number.isFinite(amt)||amt<0) amt=0;

Â Â Â Â amt=floorStep(amt);
Â Â Â Â if(amt>p.money) amt=floorStep(p.money);
Â Â Â Â if(amt>0&&amt<MIN_BET) amt=0;
Â Â Â Â if(amt<MIN_BET) return;

Â Â Â Â const h=horses[horseId];
Â Â Â Â const odd=(type==="win")?h.winOdd:h.placeOdd; // â˜…å€ç‡ãƒ­ãƒƒã‚¯
Â Â Â Â lockedBets.push({pi,type,horseId,amt,odd});
Â Â });
}

function settle(){
Â Â order.sort((a,b)=>a._finishAt-b._finishAt);
Â Â const first=order[0], second=order[1], third=order[2];
Â Â const top3=new Set([first.id,second.id,third.id]);

Â Â const log=[];
Â Â for(const b of lockedBets){
Â Â Â Â const p=players[b.pi];
Â Â Â Â if(!p || p.dead) continue;

Â Â Â Â const stake=Math.min(b.amt, p.money);
Â Â Â Â const hit=(b.type==="win") ? (b.horseId===first.id) : top3.has(b.horseId);

Â Â Â Â if(hit){
Â Â Â Â Â Â const gain=yen(stake*b.odd);
Â Â Â Â Â Â p.money+=gain;
Â Â Â Â Â Â log.push(`${p.name}: ${b.type==="win"?"å˜å‹":"è¤‡å‹"} ${b.horseId+1}ç•ª ${stake}å†† â†’ çš„ä¸­ï¼ +${gain}å††ï¼ˆ${b.odd}å€ãƒ­ãƒƒã‚¯ï¼‰`);
Â Â Â Â }else{
Â Â Â Â Â Â p.money-=stake;
Â Â Â Â Â Â log.push(`${p.name}: ${b.type==="win"?"å˜å‹":"è¤‡å‹"} ${b.horseId+1}ç•ª ${stake}å†† â†’ ãƒã‚ºãƒ¬ -${stake}å††`);
Â Â Â Â }
Â Â Â Â if(p.money<=0){ p.money=0; p.dead=true; log.push(`${p.name}: 0å†† â†’ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼`); }
Â Â }
Â Â return {log};
}

function updateGround(dt){
Â Â let leader=horses[0];
Â Â for(const h of horses) if(h.progress>leader.progress) leader=h;
Â Â const v=leader?.speed||0;
Â Â bgx -= (v*1100)*dt;
Â Â horses.forEach(h=>{
Â Â Â Â const tr=document.getElementById("track"+h.id);
Â Â Â Â if(tr) tr.style.setProperty("--bgx", `${bgx}px`);
Â Â });
}

function runFrame(ts){
Â Â if(!startT) startT=ts;
Â Â if(!lastT) lastT=ts;
Â Â const dt=(ts-lastT)/1000;
Â Â lastT=ts;
Â Â tick++;

Â Â const elapsed=(ts-startT)/1000;
Â Â let leaderP=0;
Â Â for(const h of horses) leaderP=Math.max(leaderP,h.progress);
Â Â const remainT=Math.max(0.7, TARGET_SECONDS-elapsed);
Â Â const remainD=Math.max(0.001, 1-leaderP);
Â Â const desiredLeaderSpeed=remainD/remainT;
Â Â const baseAvg=1/TARGET_SECONDS;
Â Â const timeScale=clamp(desiredLeaderSpeed/baseAvg, 0.75, 1.35);

Â Â for(const h of horses){
Â Â Â Â if(h.fin) continue;
Â Â Â Â const p=h.progress;

Â Â Â Â const staminaDrop=1-(p*(0.55/h.stamina));
Â Â Â Â const staminaMult=clamp(staminaDrop,0.55,1.05);
Â Â Â Â const kickZone=p>0.80 ? (1+(p-0.80)/0.20*(h.kick-1)) : 1;

Â Â Â Â let styleMult=1.0;
Â Â Â Â if(h.style==="é€ƒã’") styleMult*=(p<0.35?1.10:0.98);
Â Â Â Â if(h.style==="å…ˆè¡Œ") styleMult*=(p<0.55?1.06:1.00);
Â Â Â Â if(h.style==="å·®ã—") styleMult*=(p<0.55?1.00:1.05);
Â Â Â Â if(h.style==="è¿½è¾¼") styleMult*=(p<0.60?0.98:1.10);

Â Â Â Â const powerMult=(0.85+h.power*0.06)*(0.92+(h.condition-0.7)*0.7)*(1+(h.streak||0)*0.05);
Â Â Â Â const chaosMult=chaos ? (0.88+Math.random()*0.30) : 1.0;

Â Â Â Â const minSpeed=baseAvg*0.35;
Â Â Â Â const topSpeed=Math.max(minSpeed, baseAvg*(0.75+h.top*0.55)*powerMult*staminaMult*styleMult*kickZone*chaosMult*timeScale);

Â Â Â Â const accel=h.accel*(0.9+Math.random()*0.2);
Â Â Â Â if(h.speed<=0) h.speed=minSpeed*0.5;
Â Â Â Â h.speed += (topSpeed-h.speed)*clamp(accel*dt,0,1);

Â Â Â Â const wobble=1+(Math.random()*2-1)*0.025;
Â Â Â Â h.progress += h.speed*dt*wobble;

Â Â Â Â if(h.progress>=1){
Â Â Â Â Â Â h.progress=1; h.fin=true; h._finishAt=performance.now();
Â Â Â Â Â Â order.push(h);
Â Â Â Â Â Â document.getElementById("goal"+h.id).style.display="inline-block";
Â Â Â Â }

Â Â Â Â const s01=clamp(h.speed/(baseAvg*1.8),0,1);
Â Â Â Â setHorseX(h.id,h.progress,s01);
Â Â }

Â Â updateGround(dt);

Â Â if(order.length>=10){ finishRace(); return; }
Â Â raf=requestAnimationFrame(runFrame);
}

function finishRace(){
Â Â cancelAnimationFrame(raf); raf=null;

Â Â order.sort((a,b)=>a._finishAt-b._finishAt);
Â Â const first=order[0], second=order[1], third=order[2];

Â Â document.getElementById("line"+first.id)?.classList.add("top1");
Â Â document.getElementById("line"+second.id)?.classList.add("top2");
Â Â document.getElementById("line"+third.id)?.classList.add("top3");

Â Â const {log}=settle();

Â Â let txt="ğŸ çµæœï¼ˆå…¨ç€é †ï¼‰\n";
Â Â order.forEach((h,i)=>txt+=`${i+1}ç€ ${h.id+1} ${h.name}\n`);
Â Â txt += `\nã€ç²¾ç®—ãƒ­ã‚°ã€‘\n` + log.map(s=>"ãƒ»"+s).join("\n") + "\n";
Â Â document.getElementById("result").textContent=txt;

Â Â document.getElementById("btnCard").disabled=false;
Â Â document.getElementById("btnStart").disabled=true;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
Â Â document.getElementById("liveTag").style.display="none";

Â Â drawPlayers(); save();
Â Â bettingClosed=false;
Â Â lockedBets=[];
Â Â renderBetUI(); renderLockedUI();
}

function makeRaceCard(){
Â Â if(raf) return;

Â Â surface=(Math.random()<0.7)?"èŠ":"ãƒ€ãƒ¼ãƒˆ";
Â Â going=(surface==="èŠ")?(["è‰¯","ç¨é‡","é‡","ä¸è‰¯"][rand(4)]):(["è‰¯","ç¨é‡","é‡"][rand(3)]);
Â Â pace=["ã‚¹ãƒ­ãƒ¼","ãƒŸãƒ‰ãƒ«","ãƒã‚¤"][rand(3)];
Â Â distance=rand(1400)+1000;
Â Â chaos=Math.random()<0.03;

Â Â const names=genUniqueNames(10);
Â Â const styles=["é€ƒã’","å…ˆè¡Œ","å·®ã—","è¿½è¾¼"];

Â Â horses=horseStats.map((st,i)=>({
Â Â Â Â id:i,
Â Â Â Â name:names[i],
Â Â Â Â style:styles[rand(4)],
Â Â Â Â power:st.powerBase*(0.92+Math.random()*0.16),
Â Â Â Â streak:st.streak||0,
Â Â Â Â condition:0.7+Math.random()*0.6,

Â Â Â Â winOdd:0, placeOdd:0,

Â Â Â Â progress:0,speed:0,fin:false,_finishAt:0,
Â Â Â Â stamina:0.85+Math.random()*0.25,
Â Â Â Â accel:1.2+Math.random()*0.9,
Â Â Â Â top:0.85+Math.random()*0.35,
Â Â Â Â kick:1.0+Math.random()*0.25,
Â Â }));

Â Â assignOddsForRace(horses);

Â Â cardReady=true;
Â Â bettingClosed=false;
Â Â lockedBets=[];
Â Â order=[];
Â Â tick=0; bgx=0; lastLeader=-1;
Â Â lastT=null; startT=null;

Â Â document.getElementById("btnStart").disabled=false;
Â Â document.getElementById("result").textContent="";
Â Â setCommentary("â€”");

Â Â renderRaceInfo();
Â Â renderOddsTable();
Â Â renderBetUI();
Â Â renderLockedUI();
Â Â renderRaceLanes();

Â Â if(spriteOK) applySpriteStyle();
Â Â save();
}

function startRace(){
Â Â if(!cardReady || horses.length!==10) return;
Â Â if(raf) return;

Â Â bettingClosed=true;
Â Â renderBetUI();

Â Â lockBets();
Â Â renderLockedUI();

Â Â document.getElementById("btnCard").disabled=true;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹ä¸­â€¦";
Â Â document.getElementById("liveTag").style.display="inline-block";
Â Â setCommentary("ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸï¼");

Â Â order=[]; tick=0; bgx=0; lastLeader=-1;
Â Â lastT=null; startT=null;

Â Â horses.forEach(h=>{
Â Â Â Â h.progress=0; h.speed=0; h.fin=false; h._finishAt=0;
Â Â Â Â document.getElementById("goal"+h.id).style.display="none";
Â Â Â Â setHorseX(h.id,0,0,true);
Â Â });

Â Â raf=requestAnimationFrame(runFrame);
}

function resetAll(){
Â Â if(raf){ cancelAnimationFrame(raf); raf=null; }
Â Â try{ localStorage.removeItem(KEY); }catch(e){}
Â Â location.reload();
}
</script>
</body>
</html>
