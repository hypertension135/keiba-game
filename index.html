<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆå®Œæˆç‰ˆï¼šx1å›ºå®š/ç´„15ç§’/1äººæ°—<=3/10äººæ°—>=150ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f5f5f5;color:#111;margin:0;padding:12px}
  h2{background:#0b8f3c;color:#fff;padding:10px;border-radius:10px;margin:0 0 10px}
  .box{background:#fff;border:1px solid #d0d0d0;border-radius:12px;padding:10px;margin:10px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{padding:10px 12px;border:0;border-radius:10px;background:#0b8f3c;color:#fff;font-weight:900}
  button.secondary{background:#333}
  button:disabled{opacity:.45}
  select,input{padding:8px;border-radius:10px;border:1px solid #ccc}
  .muted{color:#666;font-size:13px}

  .badge{display:inline-block;background:#eef6ff;border:1px solid #cfe6ff;color:#0a4a8a;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
  .bad{display:inline-block;background:#ffecec;border:1px solid #ffb3b3;color:#7a0000;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
  .ok{display:inline-block;background:#eaffea;border:1px solid #b9f2b9;color:#0b5a0b;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
  .goalTag{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#fff3cd;border:1px solid #ffe08a;color:#7a5a00;font-size:12px;font-weight:900}
  .live{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:#e8f0ff;border:1px solid #cfe0ff;color:#143a86;font-size:12px;font-weight:900}

  .num{display:inline-block;min-width:26px;text-align:center;color:#fff;border-radius:7px;font-weight:900;padding:2px 0;margin-right:6px;font-size:13px;font-variant-numeric:tabular-nums}
  .w1{background:#fff;color:#111;border:1px solid #111}
  .w2{background:#111}
  .w3{background:#d40000}
  .w4{background:#0047ff}
  .w5{background:#ffd400;color:#111}
  .w6{background:#0b8f3c}
  .w7{background:#ff8a00}
  .w8{background:#ff5fb7;color:#111}
  .frameClass{font-variant-numeric:tabular-nums}

  .table{width:100%;border-collapse:collapse;font-size:14px}
  .table th,.table td{border-bottom:1px solid #e7e7e7;padding:8px 6px;text-align:left;vertical-align:top}
  .table th{background:#f2f2f2}
  .right{text-align:right}

  /* ãƒ¬ãƒ¼ã‚¹æ¬„ï¼šè¦‹å¤±ã‚ãªã„ */
  #raceWrap{position:sticky;top:72px;z-index:9;background:#fff;border:2px solid #0b8f3c;border-radius:14px;padding:10px}
  .trackRow{display:grid;grid-template-columns:1fr;gap:8px;max-height:52vh;overflow:auto;border-radius:12px}
  .horseLine{background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px}
  .horseLine.top1{outline:3px solid #ffd400}
  .horseLine.top2{outline:3px solid #c0c0c0}
  .horseLine.top3{outline:3px solid #cd7f32}

  .track{position:relative;height:28px;background:#111;border-radius:12px;overflow:hidden;margin-top:6px}
  .finishLine{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.75}
  .lane{position:absolute;left:0;top:50%;width:100%;height:1px;background:#2b2b2b}
  .horseIcon{position:absolute;left:0%;top:4px;height:20px;width:auto;transition:left .10s linear;user-select:none}
  .horseFallback{position:absolute;left:0%;top:3px;font-size:18px;transition:left .10s linear;user-select:none}

  pre{white-space:pre-wrap;background:#111;color:#eaeaea;border-radius:12px;padding:10px;overflow:auto}
</style>
</head>
<body>

<h2>ğŸ‡ ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆå®Œæˆç‰ˆï¼‰</h2>

<div class="box" id="players"></div>

<div class="box">
  <div class="row">
    <button id="btnCard" onclick="makeRaceCard()">å‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã‚’ä½œã‚‹</button>
    <button id="btnStart" class="secondary" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰</button>
    <button class="secondary" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <div class="muted" style="margin-top:8px">
    ãƒ»ã‚¹ãƒ”ãƒ¼ãƒ‰ã¯ <b>x1å›ºå®š</b>ï¼ˆç›®å®‰ï¼šãƒ¬ãƒ¼ã‚¹ã¯ç´„15ç§’ï¼‰<br>
    ãƒ»å˜å‹ã¯ <b>1ç•ªäººæ°—â‰¤3.0å€</b> / <b>10ç•ªäººæ°—â‰¥150å€</b> ã‚’å¿…ãšæº€ãŸã™<br>
    ãƒ»åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« <b>horse.gif</b> ã‚’ç½®ãã¨GIFã§èµ°ã‚‹ï¼ˆç„¡ã„ã¨ğŸã«è‡ªå‹•åˆ‡æ›¿ï¼‰
  </div>
</div>

<div class="box" id="raceInfo"></div>
<div class="box" id="oddsTable"></div>

<div class="box">
  <h3 style="margin:0 0 8px">ğŸŸï¸ è³­ã‘ï¼ˆå˜å‹ / è¤‡å‹ï¼‰</h3>
  <div id="betUI"></div>
  <div class="muted">æœ€ä½100å††ã€‚ç„¡åŠ¹ãªè³­ã‘ã¯ç†ç”±ã‚’è¡¨ç¤ºï¼ˆãŠé‡‘ã¯æ¸›ã‚‰ãªã„ï¼‰ã€‚æ‰€æŒé‡‘0å††ã§æ•—é€€ã€‚</div>
</div>

<div class="box" id="raceWrap">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h3 style="margin:0">ğŸ ãƒ¬ãƒ¼ã‚¹ <span id="liveTag" style="display:none" class="live">LIVE</span></h3>
    <div class="muted">å®Ÿæ³ï¼š<span id="commentary">â€”</span></div>
  </div>
  <div id="race" class="trackRow"></div>
</div>

<pre id="result"></pre>

<script>
/* ======================
  è¨­å®šï¼ˆæ™‚é–“ï¼‰
====================== */
const KEY = "keiba_final_15sec_x1_v2";
const TICK_MS = 140;           // æ›´æ–°é–“éš”ï¼ˆ0.14ç§’ï¼‰
const RACE_TIME_FACTOR = 0.18; // â˜…x1å›ºå®šã§ç´„15ç§’ãã‚‰ã„ï¼ˆå¤šå°‘ãƒ–ãƒ¬ã‚ã‚Šï¼‰
const AUTO_CAMERA = true;      // å…ˆé ­è¿½å°¾

/* ======================
  ä¾¿åˆ©é–¢æ•°
====================== */
const rand = n => Math.floor(Math.random()*n);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const frameClass = i => "w"+((i%8)+1);

/* ======================
  é¦¬åç”Ÿæˆï¼ˆæ¯å›é•ã†ãƒ»é‡è¤‡ãªã—ï¼‰
====================== */
const syll = ["ã‚µãƒ³","ãƒ©ã‚¤","ãƒ–ãƒ¬","ãƒ•ã‚¡","ãƒ‰","ãƒ«","ã‚«","ã‚°","ãƒ´","ãƒŠ","ãƒˆ","ã‚­","ãƒ©","ã‚¹","ã‚»ã‚¤","ãƒ¦ã‚¦","ã‚ªã‚¦","ã‚·ãƒ³","ãƒãƒ«","ãƒ†ãƒ„","ãƒ’ãƒ¡","ã‚¼ãƒ³","ãƒŸãƒ¤","ã‚¢ã‚­","ãƒ›ã‚·","ã‚«ã‚¼","ãƒ„ã‚­","ãƒ¦ãƒ¡"];
function genName(){
  const parts = 2 + rand(2);
  let s = "";
  for(let i=0;i<parts;i++) s += syll[rand(syll.length)];
  return s;
}
function genUniqueNames(n){
  const set = new Set();
  while(set.size < n) set.add(genName());
  return [...set];
}

/* ======================
  ä¿å­˜ãƒ‡ãƒ¼ã‚¿
====================== */
let players = [
  {name:"P1", money:1500},
  {name:"P2", money:1500},
  {name:"P3", money:1500},
];

let horseStats = Array.from({length:10}, ()=>({
  powerBase: 1.8 + Math.random()*4.8,
  wins: 0,
  streak: 0
}));

let history = [];

function save(){ localStorage.setItem(KEY, JSON.stringify({players, horseStats, history})); }
function load(){
  const raw = localStorage.getItem(KEY);
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    if(d?.players) players = d.players;
    if(d?.horseStats) horseStats = d.horseStats;
    if(d?.history) history = d.history;
  }catch(e){}
}
load();

/* ======================
  UI
====================== */
function setCommentary(t){ document.getElementById("commentary").textContent = t; }
function drawPlayers(){
  let html = `<h3 style="margin:0 0 8px">ğŸ’° æ‰€æŒé‡‘</h3>`;
  players.forEach(p=>{
    html += `<div>${p.name}ï¼š<b>${p.money}</b>å†† ${p.money<=0?`<span class="bad">æ•—é€€</span>`:""}</div>`;
  });
  if(history.length){
    html += `<div class="muted" style="margin-top:8px">ç›´è¿‘ï¼š${history.slice(0,3).map(h=>h.join(" / ")).join(" ï½œ ")}</div>`;
  }
  document.getElementById("players").innerHTML = html;
}
drawPlayers();

/* ======================
  ãƒ¬ãƒ¼ã‚¹çŠ¶æ…‹
====================== */
let horses = [];
let order = [];
let surface="èŠ", going="è‰¯", pace="ãƒŸãƒ‰ãƒ«", distance=1600;
let chaos=false;
let cardReady=false;
let bettingClosed=false;
let timer=null;
let tick=0;
let lastLeader=-1;

/* ======================
  ã‚ªãƒƒã‚ºç”¨ï¼ˆå†…éƒ¨ï¼‰
====================== */
function styleBias(style, distance, pace){
  let m=1.0;
  if(distance<=1400){ if(style==="é€ƒã’")m*=1.10; if(style==="è¿½è¾¼")m*=0.92; }
  else if(distance<=1800){ if(style==="é€ƒã’")m*=1.05; if(style==="è¿½è¾¼")m*=0.97; }
  else if(distance<=2200){ if(style==="è¿½è¾¼")m*=1.05; }
  else { if(style==="è¿½è¾¼")m*=1.10; if(style==="é€ƒã’")m*=0.93; }
  if(pace==="ãƒã‚¤"){ if(style==="é€ƒã’")m*=0.94; if(style==="è¿½è¾¼")m*=1.06; }
  if(pace==="ã‚¹ãƒ­ãƒ¼"){ if(style==="é€ƒã’")m*=1.06; if(style==="è¿½è¾¼")m*=0.95; }
  return clamp(m,0.85,1.15);
}
function surfaceBias(surface, going){
  let m=1.0;
  if(surface==="ãƒ€ãƒ¼ãƒˆ") m*=1.03;
  if(going==="ç¨é‡") m*=0.99;
  if(going==="é‡") m*=0.97;
  if(going==="ä¸è‰¯") m*=0.95;
  return m;
}
function placePayout100BaseFromOdd(odd){
  const f = 0.36 + 0.08*Math.log(Math.max(1.1, odd));
  return Math.round((odd*100) * clamp(f, 0.30, 0.75));
}

/* ======================
  â˜…å˜å‹ï¼šå¿…ãš 1äººæ°—<=3 / 10äººæ°—>=150
====================== */
function assignOddsForRace(hs){
  const favTarget  = 2.2 + Math.random()*0.8; // 2.2ã€œ3.0
  const lastTarget = 150 + Math.random()*120; // 150ã€œ270

  const temp=1.05, noise=0.14;
  const surfM = surfaceBias(surface, going);

  const scores = hs.map(h=>{
    const streakBoost = 1 + (h.streak||0)*0.07;
    const condBoost = 0.90 + (h.condition-0.7)*0.6;
    const styleMult = styleBias(h.style, distance, pace);
    const base = Math.max(0.01, h.power * streakBoost * condBoost * styleMult * surfM);
    const logScore = Math.log(base) + (Math.random()*2-1)*noise;
    return logScore / temp;
  });

  const idx = [...hs.keys()].sort((a,b)=>scores[b]-scores[a]); // äººæ°—ï¼ˆå¼·ã„é †ï¼‰
  const ratio = lastTarget / favTarget;

  idx.forEach((horseIndex, rank)=>{
    const t = rank/9;
    let odd = favTarget * Math.pow(ratio, t);
    odd *= (0.96 + Math.random()*0.08);

    if(rank===0) odd = Math.min(3.0, odd);
    if(rank===9) odd = Math.max(150.0, odd);

    hs[horseIndex].odd = Number(clamp(odd,1.1,999.9).toFixed(1));
    const basePay = placePayout100BaseFromOdd(hs[horseIndex].odd);
    hs[horseIndex].placeRange = {min:Math.round(basePay*0.85), max:Math.round(basePay*1.15)};
  });

  const sorted = [...hs].sort((a,b)=>a.odd-b.odd);
  sorted[0].odd = Number(Math.min(sorted[0].odd, 3.0).toFixed(1));
  sorted[9].odd = Number(Math.max(sorted[9].odd, 150.0).toFixed(1));
}

/* ======================
  å‡ºèµ°è¡¨ä½œæˆ
====================== */
function makeRaceCard(){
  if(timer) return;

  surface = (Math.random()<0.7) ? "èŠ" : "ãƒ€ãƒ¼ãƒˆ";
  going = (surface==="èŠ") ? (["è‰¯","ç¨é‡","é‡","ä¸è‰¯"][rand(4)]) : (["è‰¯","ç¨é‡","é‡"][rand(3)]);
  pace = ["ã‚¹ãƒ­ãƒ¼","ãƒŸãƒ‰ãƒ«","ãƒã‚¤"][rand(3)];
  distance = rand(1400)+1000;
  chaos = Math.random() < 0.03;

  const names = genUniqueNames(10);
  const styles = ["é€ƒã’","å…ˆè¡Œ","å·®ã—","è¿½è¾¼"];

  horses = horseStats.map((st,i)=>({
    id:i,
    name:names[i],
    style:styles[rand(4)],
    power:st.powerBase,
    streak:st.streak||0,
    condition: Math.random()*0.6+0.7,
    pos:0,
    fin:false,
    odd:0,
    placeRange:{min:0,max:0}
  }));

  assignOddsForRace(horses);

  cardReady=true;
  bettingClosed=false;
  order=[];
  tick=0;
  lastLeader=-1;

  document.getElementById("btnStart").disabled=false;
  document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
  document.getElementById("liveTag").style.display="none";
  setCommentary("â€”");
  document.getElementById("result").textContent="";

  renderRaceInfo();
  renderOddsTable();
  renderBetUI();
  renderRaceLanes();
  save();
}

function renderRaceInfo(){
  document.getElementById("raceInfo").innerHTML =
    `<h3 style="margin:0 0 8px">ğŸ“Œ ãƒ¬ãƒ¼ã‚¹æ¡ä»¶</h3>
     ${surface}${going} ï¼ è·é›¢ï¼š<b>${distance}m</b> ï¼ ãƒšãƒ¼ã‚¹ï¼š<b>${pace}</b>
     ${chaos?`<span class="badge">âš ï¸ å¤§è’ã‚Œï¼ˆã”ãç¨€ï¼‰</span>`:""}
     <span class="badge">1äººæ°—â‰¤3.0 / 10äººæ°—â‰¥150</span>
     <span class="badge">ç´„15ç§’ï¼ˆx1å›ºå®šï¼‰</span>`;
}

/* ======================
  ã‚ªãƒƒã‚ºè¡¨
====================== */
function renderOddsTable(){
  if(!horses.length){ document.getElementById("oddsTable").innerHTML=""; return; }
  const sorted=[...horses].sort((a,b)=>a.odd-b.odd);

  let html = `<h3 style="margin:0 0 8px">ğŸ“Š ã‚ªãƒƒã‚ºè¡¨ï¼ˆäººæ°—é †ï¼‰</h3>
  <table class="table"><thead><tr>
    <th>äººæ°—</th><th>æ </th><th>é¦¬å</th><th class="right">å˜å‹</th><th class="right">è¤‡å‹ç›®å®‰</th>
  </tr></thead><tbody>`;

  sorted.forEach((h,i)=>{
    html += `<tr>
      <td>${i+1}</td>
      <td><span class="num ${frameClass(h.id)}">${h.id+1}</span></td>
      <td>${h.name}${(h.streak||0)>0?`<span class="badge">é€£å‹:${h.streak}</span>`:""}</td>
      <td class="right"><b>${h.odd}</b>å€</td>
      <td class="right">${h.placeRange.min}ã€œ${h.placeRange.max}å††</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById("oddsTable").innerHTML = html;
}

/* ======================
  è³­ã‘UIï¼ˆå˜å‹/è¤‡å‹ï¼‰
====================== */
function buildHorseOptions(){
  return horses.map(h=>`<option value="${h.id}">${h.id+1} ${h.name}ï¼ˆ${h.odd}å€ï¼‰</option>`).join("");
}
function renderBetUI(){
  if(!horses.length){
    document.getElementById("betUI").innerHTML = `<div class="muted">å…ˆã«ã€Œå‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã€ã‚’ä½œã£ã¦ã­ã€‚</div>`;
    return;
  }
  const opts = buildHorseOptions();
  let html = "";

  players.forEach((p,pi)=>{
    const disabled = (bettingClosed || p.money<=0) ? "disabled" : "";
    const note = bettingClosed ? `<span class="bad">ç· åˆ‡</span>` : (p.money<=0 ? `<span class="bad">æ•—é€€</span>` : `<span class="ok">å—ä»˜ä¸­</span>`);

    html += `<div class="box" style="margin:10px 0">
      <div><b>${p.name}</b>ï¼ˆæ‰€æŒé‡‘ï¼š${p.money}å††ï¼‰ ${note}</div>
      <div class="row" style="margin-top:6px">
        <label>åˆ¸ç¨®
          <select id="type${pi}" ${disabled}>
            <option value="win">å˜å‹</option>
            <option value="place">è¤‡å‹</option>
          </select>
        </label>
        <label>é¦¬
          <select id="horse${pi}" ${disabled}>${opts}</select>
        </label>
        <label>é‡‘é¡
          <input id="amt${pi}" type="number" min="100" step="100" value="100" ${disabled}/>
        </label>
      </div>
    </div>`;
  });

  document.getElementById("betUI").innerHTML = html;
}

/* ======================
  ãƒ¬ãƒ¼ã‚¹è¡¨ç¤ºï¼ˆGIF/ğŸï¼‰
====================== */
function renderRaceLanes(){
  let html = "";
  horses.forEach(h=>{
    html += `<div id="line${h.id}" class="horseLine">
      <div>
        <span class="num ${frameClass(h.id)}">${h.id+1}</span>
        <b>${h.name}</b>
        <span id="goal${h.id}" style="display:none" class="goalTag">GOAL</span>
        <span class="badge">${h.odd}å€</span>
      </div>
      <div class="track">
        <div class="lane"></div>
        <div class="finishLine"></div>
        <img id="horseGif${h.id}" class="horseIcon" src="./horse.gif" alt="horse" onerror="fallbackHorse(${h.id})">
        <span id="horseEmoji${h.id}" class="horseFallback" style="display:none">ğŸ</span>
      </div>
    </div>`;
  });
  document.getElementById("race").innerHTML = html;

  // ã‚´ãƒ¼ãƒ«æ ã®è‰²ãŒå‰å›æ®‹ã‚‰ãªã„ã‚ˆã†ã«
  horses.forEach(h=>{
    const line = document.getElementById("line"+h.id);
    if(line){
      line.classList.remove("top1","top2","top3");
    }
  });
}
window.fallbackHorse = function(id){
  const img = document.getElementById("horseGif"+id);
  const emo = document.getElementById("horseEmoji"+id);
  if(img) img.style.display="none";
  if(emo) emo.style.display="inline";
};

/* å…ˆé ­è¿½å°¾ */
function cameraFollow(){
  if(!AUTO_CAMERA) return;
  let leader = horses[0];
  for(const h of horses) if(h.pos > leader.pos) leader = h;
  if(leader.id !== lastLeader){
    lastLeader = leader.id;
    document.getElementById("line"+leader.id)?.scrollIntoView({behavior:"smooth", block:"center"});
  }
}

/* ======================
  èµ°è¡Œï¼ˆç´„15ç§’ï¼‰
====================== */
function step(){
  const newlyFinished = [];
  tick++;

  horses.forEach(h=>{
    if(h.fin) return;

    let s = (Math.random()*6 + (h.power*0.65));
    s *= (1 + (h.streak||0)*0.07);
    s *= h.condition;

    if(pace==="ãƒã‚¤" && h.style==="é€ƒã’") s -= 1.6;
    if(pace==="ãƒã‚¤" && h.style==="è¿½è¾¼") s += 2.2;
    if(pace==="ã‚¹ãƒ­ãƒ¼" && h.style==="é€ƒã’") s += 1.4;
    if(pace==="ã‚¹ãƒ­ãƒ¼" && h.style==="è¿½è¾¼") s -= 1.2;

    if(h.pos>80){
      if(h.style==="è¿½è¾¼") s *= 1.10;
      if(h.style==="å·®ã—") s *= 1.06;
    }

    if(chaos) s *= (Math.random()*0.7 + 0.65);
    if(Math.random()<0.06) s -= 2;
    if(Math.random()<0.06) s += 2;

    // â˜… 1å€å›ºå®šã®é€²ã¿ï¼ˆç´„15ç§’ï¼‰
    h.pos += s * RACE_TIME_FACTOR;

    const x = Math.max(0, Math.min(96, h.pos));
    const img = document.getElementById("horseGif"+h.id);
    const emo = document.getElementById("horseEmoji"+h.id);

    if(img && img.style.display!=="none"){
      img.style.left = x + "%";
    }else{
      if(emo){ emo.style.display="inline"; emo.style.left = x + "%"; }
    }

    if(h.pos>=100){
      h.fin = true;
      h._finishScore = h.pos + (Math.random()*0.001);
      newlyFinished.push(h);
      const g = document.getElementById("goal"+h.id);
      if(g) g.style.display="inline-block";
    }
  });

  if(newlyFinished.length){
    newlyFinished.sort((a,b)=>b._finishScore-a._finishScore);
    newlyFinished.forEach(h=>order.push(h));
  }

  if(tick%10===0){
    let leader = horses[0];
    for(const h of horses) if(h.pos > leader.pos) leader = h;
    setCommentary(`å…ˆé ­ã¯ ${leader.id+1}ç•ª ${leader.name}ï¼`);
  }
  if(order.length>=1 && tick%12===0) setCommentary(`å…¥ç·šä¸­â€¦ï¼ˆ${order.length}/10ï¼‰`);

  cameraFollow();
}

/* ======================
  æ‰•æˆ»
====================== */
function winPayout100(h){ return Math.round(h.odd*100); }
function placePayout100Final(h, finishRank, popularityRank){
  const rankMult = (finishRank===1) ? 0.92 : (finishRank===2 ? 1.00 : 1.08);
  const popMult  = 0.78 + (popularityRank-1)*0.045;
  const base = placePayout100BaseFromOdd(h.odd);
  const wobble = 0.92 + Math.random()*0.16;
  return clamp(Math.round(base*rankMult*popMult*wobble),110,9990);
}

function settleBets(){
  const first=order[0], second=order[1], third=order[2];
  const top3 = new Set([first.id, second.id, third.id]);

  const popSorted=[...horses].sort((a,b)=>a.odd-b.odd);
  const popRank=new Map();
  popSorted.forEach((h,i)=>popRank.set(h.id, i+1));

  const placePay=new Map();
  placePay.set(first.id,  placePayout100Final(first,  1, popRank.get(first.id)));
  placePay.set(second.id, placePayout100Final(second, 2, popRank.get(second.id)));
  placePay.set(third.id,  placePayout100Final(third,  3, popRank.get(third.id)));

  let log=[];
  players.forEach((p,pi)=>{
    if(p.money<=0){ log.push(`${p.name}: æ•—é€€ï¼ˆ0å††ï¼‰ãªã®ã§è³­ã‘ãªã—`); return; }

    const type = document.getElementById(`type${pi}`)?.value ?? "win";
    const pick = Number(document.getElementById(`horse${pi}`)?.value);
    let amt = Number(document.getElementById(`amt${pi}`)?.value);

    if(!Number.isFinite(amt) || amt < 100){ log.push(`${p.name}: ç„¡åŠ¹ï¼ˆ100å††ä»¥ä¸Šï¼‰`); return; }
    if(!Number.isFinite(pick) || pick<0 || pick>9){ log.push(`${p.name}: ç„¡åŠ¹ï¼ˆé¦¬ã®é¸æŠãŒãŠã‹ã—ã„ï¼‰`); return; }

    const orig=amt;
    if(amt > p.money) amt = p.money;
    p.money -= amt;

    if(type==="win"){
      if(pick===first.id){
        const back = Math.round(winPayout100(first) * (amt/100));
        p.money += back;
        log.push(`${p.name}: å˜å‹ ${pick+1} ${orig}å††ï¼ˆâ†’${amt}å††ï¼‰â†’çš„ä¸­ æ‰•æˆ»${back}å††`);
      }else{
        log.push(`${p.name}: å˜å‹ ${pick+1} ${orig}å††ï¼ˆâ†’${amt}å††ï¼‰â†’ãƒã‚ºãƒ¬`);
      }
    }else{
      if(top3.has(pick)){
        const back = Math.round(placePay.get(pick) * (amt/100));
        p.money += back;
        log.push(`${p.name}: è¤‡å‹ ${pick+1} ${orig}å††ï¼ˆâ†’${amt}å††ï¼‰â†’çš„ä¸­ æ‰•æˆ»${back}å††`);
      }else{
        log.push(`${p.name}: è¤‡å‹ ${pick+1} ${orig}å††ï¼ˆâ†’${amt}å††ï¼‰â†’ãƒã‚ºãƒ¬`);
      }
    }
  });

  return {log, placePay, popRank};
}

function finishRace(){
  const popSorted=[...horses].sort((a,b)=>a.odd-b.odd);
  const popRank=new Map();
  popSorted.forEach((h,i)=>popRank.set(h.id, i+1));

  const settle = settleBets();
  const first=order[0], second=order[1], third=order[2];

  document.getElementById("line"+first.id)?.classList.add("top1");
  document.getElementById("line"+second.id)?.classList.add("top2");
  document.getElementById("line"+third.id)?.classList.add("top3");

  const winPay = winPayout100(first);
  function rangeText(y){ return `${y}å††ï¼ˆ${Math.round(y*0.90)}ã€œ${Math.round(y*1.10)}ï¼‰`; }
  const p1 = settle.placePay.get(first.id);
  const p2 = settle.placePay.get(second.id);
  const p3 = settle.placePay.get(third.id);

  let txt = "ğŸ çµæœï¼ˆå…¨ç€é †ï¼‰\n";
  order.forEach((h,i)=>{
    txt += `${i+1}ç€ ${h.id+1} ${h.name}ï¼ˆäººæ°—:${popRank.get(h.id)} / ${h.odd}å€ï¼‰\n`;
  });

  txt += `\nã€æ‰•æˆ»é‡‘ï¼ˆ100å††ï¼‰ã€‘\n`;
  txt += `å˜å‹ã€€${first.id+1}ã€€${winPay}å††\n`;
  txt += `è¤‡å‹ã€€${first.id+1}ã€€${rangeText(p1)}\n`;
  txt += `è¤‡å‹ã€€${second.id+1}ã€€${rangeText(p2)}\n`;
  txt += `è¤‡å‹ã€€${third.id+1}ã€€${rangeText(p3)}\n`;
  txt += `\nã€ç²¾ç®—ãƒ­ã‚°ã€‘\n` + settle.log.map(s=>"ãƒ»"+s).join("\n") + "\n";

  // é€£å‹æ›´æ–°ï¼ˆæ ã”ã¨ã«ä¿å­˜ï¼‰
  const winnerId = first.id;
  for(let i=0;i<10;i++){
    if(i===winnerId){
      horseStats[i].wins = (horseStats[i].wins||0) + 1;
      horseStats[i].streak = (horseStats[i].streak||0) + 1;
    }else{
      horseStats[i].streak = 0;
    }
  }

  history.unshift([first.name, second.name, third.name]);
  if(history.length>20) history.pop();

  document.getElementById("result").textContent = txt;
  drawPlayers();
  save();

  clearInterval(timer); timer=null;
  bettingClosed=false;
  cardReady=false;

  document.getElementById("btnStart").disabled=true;
  document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
  document.getElementById("btnCard").disabled=false;
  document.getElementById("liveTag").style.display="none";
  setCommentary("ãƒ¬ãƒ¼ã‚¹çµ‚äº†ï¼");
  renderBetUI();
}

/* ======================
  ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆæŠ¼ã—ãŸç¬é–“ã«ç· åˆ‡ï¼‰
====================== */
function startRace(){
  if(!cardReady || horses.length!==10) return;
  if(timer) return;

  bettingClosed=true;
  renderBetUI();

  document.getElementById("btnCard").disabled=true;
  document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹ä¸­â€¦";
  document.getElementById("liveTag").style.display="inline-block";
  setCommentary("ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸï¼");

  order=[]; tick=0; lastLeader=-1;
  horses.forEach(h=>{ h.pos=0; h.fin=false; });
  renderRaceLanes();

  timer = setInterval(()=>{
    step();
    if(order.length>=10) finishRace();
  }, TICK_MS);
}

/* ======================
  ãƒªã‚»ãƒƒãƒˆ
====================== */
function resetAll(){
  if(timer){ clearInterval(timer); timer=null; }
  localStorage.removeItem(KEY);
  location.reload();
}
</script>
</body>
</html>
