<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆé¦¬1ã€œé¦¬10 / é¨æ‰‹ãªã— / å˜å‹ãƒ»è¤‡å‹ / GIFèµ°è¡Œï¼‰</title>
<style>
Â Â body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f5f5f5;color:#111;margin:0;padding:12px}
Â Â h2{background:#0b8f3c;color:#fff;padding:10px;border-radius:10px;margin:0 0 10px}
Â Â .box{background:#fff;border:1px solid #d0d0d0;border-radius:12px;padding:10px;margin:10px 0}
Â Â .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
Â Â button{padding:10px 12px;border:0;border-radius:10px;background:#0b8f3c;color:#fff;font-weight:800}
Â Â button.secondary{background:#333}
Â Â button:disabled{opacity:.45}
Â Â select,input{padding:8px;border-radius:10px;border:1px solid #ccc}
Â Â .muted{color:#666;font-size:13px}

Â Â .num{display:inline-block;min-width:26px;text-align:center;color:#fff;border-radius:7px;font-weight:900;padding:2px 0;margin-right:6px;font-size:13px}
Â Â .w1{background:#fff;color:#111;border:1px solid #111}
Â Â .w2{background:#111}
Â Â .w3{background:#d40000}
Â Â .w4{background:#0047ff}
Â Â .w5{background:#ffd400;color:#111}
Â Â .w6{background:#0b8f3c}
Â Â .w7{background:#ff8a00}
Â Â .w8{background:#ff5fb7;color:#111}

Â Â #oddsTable{position:sticky;top:8px;z-index:5}
Â Â .table{width:100%;border-collapse:collapse;font-size:14px}
Â Â .table th,.table td{border-bottom:1px solid #e7e7e7;padding:8px 6px;text-align:left;vertical-align:top}
Â Â .table th{background:#f2f2f2}
Â Â .right{text-align:right}
Â Â .badge{display:inline-block;background:#eef6ff;border:1px solid #cfe6ff;color:#0a4a8a;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .bad{display:inline-block;background:#ffecec;border:1px solid #ffb3b3;color:#7a0000;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
Â Â .ok{display:inline-block;background:#eaffea;border:1px solid #b9f2b9;color:#0b5a0b;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}

Â Â .trackRow{display:grid;grid-template-columns:1fr;gap:8px}
Â Â .horseLine{background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px}
Â Â .track{position:relative;height:26px;background:#111;border-radius:12px;overflow:hidden;margin-top:6px}
Â Â .finishLine{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.75}
Â Â .lane{position:absolute;left:0;top:50%;width:100%;height:1px;background:#2b2b2b}

Â Â /* GIFé¦¬ï¼ˆhorse.gifï¼‰ãŒæ¨ªã«å‹•ã */
Â Â .horseIcon{
Â Â Â Â position:absolute;
Â Â Â Â left:0%;
Â Â Â Â top:3px;
Â Â Â Â height:20px;
Â Â Â Â width:auto;
Â Â Â Â transition:left .10s linear;
Â Â Â Â user-select:none;
Â Â Â Â image-rendering:auto;
Â Â }

Â Â /* horse.gif ãŒç„¡ã„æ™‚ã®çµµæ–‡å­—ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
Â Â .horseFallback{
Â Â Â Â position:absolute;
Â Â Â Â left:0%;
Â Â Â Â top:2px;
Â Â Â Â font-size:18px;
Â Â Â Â transition:left .10s linear;
Â Â Â Â user-select:none
Â Â }

Â Â pre{white-space:pre-wrap;background:#111;color:#eaeaea;border-radius:12px;padding:10px;overflow:auto}
</style>
</head>
<body>

<h2>ğŸ‡ ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆé¦¬1ã€œé¦¬10 / å˜å‹ãƒ»è¤‡å‹ / GIFèµ°è¡Œï¼‰</h2>

<div class="box" id="players"></div>

<div class="box">
Â Â <div class="row">
Â Â Â Â <button id="btnCard" onclick="makeRaceCard()">å‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã‚’ä½œã‚‹</button>
Â Â Â Â <button id="btnStart" class="secondary" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰</button>
Â Â Â Â <button class="secondary" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
Â Â </div>
Â Â <div class="row" style="margin-top:8px">
Â Â Â Â <button class="secondary" onclick="exportData()">ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—</button>
Â Â Â Â <label class="secondary" style="padding:10px 12px;border-radius:10px;background:#333;color:#fff;font-weight:800;cursor:pointer">
Â Â Â Â Â Â ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
Â Â Â Â Â Â <input id="importFile" type="file" accept=".json,application/json" style="display:none" onchange="importData(event)">
Â Â Â Â </label>
Â Â </div>
Â Â <div class="muted">åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« <b>horse.gif</b> ã‚’ç½®ãã¨ã€é¦¬ãŒGIFã§èµ°ã‚Šã¾ã™ï¼ˆç„¡ã„ã¨ğŸã«è‡ªå‹•åˆ‡æ›¿ï¼‰ã€‚</div>
</div>

<div class="box" id="raceInfo"></div>
<div class="box" id="oddsTable"></div>

<div class="box">
Â Â <h3 style="margin:0 0 8px">ğŸŸï¸ è³­ã‘ï¼ˆå˜å‹ / è¤‡å‹ï¼‰</h3>
Â Â <div id="betUI"></div>
Â Â <div class="muted">æœ€ä½100å††ã€‚ç„¡åŠ¹ãªè³­ã‘ã¯ã€Œç„¡åŠ¹ç†ç”±ã€ã‚’çµæœã«è¡¨ç¤ºï¼ˆãŠé‡‘ã¯æ¸›ã‚‰ãªã„ï¼‰ã€‚</div>
</div>

<div class="box">
Â Â <h3 style="margin:0 0 8px">ğŸ ãƒ¬ãƒ¼ã‚¹</h3>
Â Â <div id="race" class="trackRow"></div>
</div>

<pre id="result"></pre>

<script>
/* =========================
Â Â åŸºæœ¬
========================= */
const KEY="keiba_gif_v1";
const rand=n=>Math.floor(Math.random()*n);
const frameClass=i=>"w"+((i%8)+1);
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

/* =========================
Â Â ä¿å­˜ãƒ‡ãƒ¼ã‚¿
========================= */
let players=[{name:"P1",money:1500},{name:"P2",money:1500},{name:"P3",money:1500}];

// 10é ­å›ºå®šï¼ˆé¦¬1ã€œé¦¬10ï¼‰: èƒ½åŠ›ã¯å›ºå®šã€é€£å‹/å‹åˆ©ã‚‚ä¿å­˜
let horseStats = Array.from({length:10}, (_,i)=>({
Â Â name:`é¦¬${i+1}`,
Â Â powerBase: 2.2 + Math.random()*3.0,
Â Â wins: 0,
Â Â streak: 0
}));

let history=[];

function save(){ localStorage.setItem(KEY, JSON.stringify({players, horseStats, history})); }
function load(){
Â Â const raw=localStorage.getItem(KEY);
Â Â if(!raw) return;
Â Â try{
Â Â Â Â const d=JSON.parse(raw);
Â Â Â Â if(d?.players) players=d.players;
Â Â Â Â if(d?.horseStats) horseStats=d.horseStats;
Â Â Â Â if(d?.history) history=d.history;
Â Â }catch(e){}
}
load();

/* =========================
Â Â ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
========================= */
function exportData(){
Â Â const data = {players, horseStats, history, exportedAt: new Date().toISOString()};
Â Â const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
Â Â const url = URL.createObjectURL(blob);
Â Â const a = document.createElement("a");
Â Â a.href = url;
Â Â a.download = "keiba_data.json";
Â Â document.body.appendChild(a);
Â Â a.click();
Â Â a.remove();
Â Â URL.revokeObjectURL(url);
Â Â toast("ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸï¼ˆkeiba_data.jsonï¼‰");
}
function importData(ev){
Â Â const f = ev.target.files?.[0];
Â Â if(!f) return;
Â Â const reader = new FileReader();
Â Â reader.onload = () => {
Â Â Â Â try{
Â Â Â Â Â Â const d = JSON.parse(String(reader.result||"{}"));
Â Â Â Â Â Â if(d?.players) players = d.players;
Â Â Â Â Â Â if(d?.horseStats) horseStats = d.horseStats;
Â Â Â Â Â Â if(d?.history) history = d.history;
Â Â Â Â Â Â save();
Â Â Â Â Â Â drawPlayers();
Â Â Â Â Â Â toast("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
Â Â Â Â }catch(e){
Â Â Â Â Â Â toast("èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼ˆJSONãŒãŠã‹ã—ã„ï¼‰", true);
Â Â Â Â }finally{
Â Â Â Â Â Â ev.target.value = "";
Â Â Â Â }
Â Â };
Â Â reader.readAsText(f);
}

/* =========================
Â Â UI
========================= */
function toast(msg, isBad=false){
Â Â const el = document.getElementById("result");
Â Â const tag = isBad ? "âš ï¸" : "âœ…";
Â Â el.textContent = `${tag} ${msg}\n\n` + (el.textContent||"");
}

function drawPlayers(){
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ’° æ‰€æŒé‡‘</h3>`;
Â Â players.forEach(p=>{
Â Â Â Â html+=`<div>${p.name}ï¼š<b>${p.money}</b>å††${p.money<=0?` <span class="bad">0å††ï¼ˆæ•—é€€ï¼‰</span>`:""}</div>`;
Â Â });
Â Â if(history.length){
Â Â Â Â html+=`<div class="muted" style="margin-top:8px">ç›´è¿‘ï¼š${history.slice(0,3).map(h=>h.join(" / ")).join(" ï½œ ")}</div>`;
Â Â }
Â Â document.getElementById("players").innerHTML=html;
}
drawPlayers();

/* =========================
Â Â ãƒ¬ãƒ¼ã‚¹çŠ¶æ…‹
========================= */
let horses=[], order=[];
let chaos=false, pace="ãƒŸãƒ‰ãƒ«", distance=1600;
let surface="èŠ", going="è‰¯";
let cardReady=false;
let bettingClosed=false;
let timer=null;

/* =========================
Â Â å‡ºèµ°è¡¨
========================= */
function makeRaceCard(){
Â Â if(timer){ toast("ãƒ¬ãƒ¼ã‚¹ä¸­ã¯å‡ºèµ°è¡¨ã‚’ä½œã‚Œã¾ã›ã‚“", true); return; }

Â Â surface = (Math.random()<0.7) ? "èŠ" : "ãƒ€ãƒ¼ãƒˆ";
Â Â going = (surface==="èŠ")
Â Â Â Â ? (["è‰¯","ç¨é‡","é‡","ä¸è‰¯"][rand(4)])
Â Â Â Â : (["è‰¯","ç¨é‡","é‡"][rand(3)]);

Â Â chaos = Math.random() < 0.03;
Â Â pace = ["ã‚¹ãƒ­ãƒ¼","ãƒŸãƒ‰ãƒ«","ãƒã‚¤"][rand(3)];
Â Â distance = rand(1400)+1000;

Â Â // è„šè³ªã¯å†…éƒ¨ã«ã ã‘æŒã¤ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰
Â Â const styles=["é€ƒã’","å…ˆè¡Œ","å·®ã—","è¿½è¾¼"];

Â Â horses = horseStats.map((st,i)=>({
Â Â Â Â id:i,
Â Â Â Â name:st.name,
Â Â Â Â style:styles[rand(4)],
Â Â Â Â power:st.powerBase,
Â Â Â Â streak:st.streak||0,
Â Â Â Â wins:st.wins||0,
Â Â Â Â condition: Math.random()*0.6+0.7,
Â Â Â Â pos:0,
Â Â Â Â fin:false,
Â Â Â Â odd: 0,
Â Â Â Â placeRange: null
Â Â }));

Â Â bettingClosed=false;
Â Â cardReady=true;
Â Â order=[];
Â Â document.getElementById("btnStart").disabled=false;
Â Â document.getElementById("btnCard").disabled=false;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";

Â Â assignOddsForRace(horses);

Â Â renderRaceInfo();
Â Â renderOddsTable();
Â Â renderBetUI();
Â Â renderRaceLanes();

Â Â document.getElementById("result").textContent="";
Â Â save();
}

function renderRaceInfo(){
Â Â document.getElementById("raceInfo").innerHTML=
Â Â Â Â `<h3 style="margin:0 0 8px">ğŸ“Œ ãƒ¬ãƒ¼ã‚¹æ¡ä»¶</h3>
Â Â Â Â Â ${surface}${going} ï¼ è·é›¢ï¼š<b>${distance}m</b> ï¼ ãƒšãƒ¼ã‚¹ï¼š<b>${pace}</b>
Â Â Â Â Â ${chaos?`<span class="badge">âš ï¸ å¤§è’ã‚Œï¼ˆã”ãç¨€ï¼‰</span>`:""}`;
}

/* =========================
Â Â ã‚ªãƒƒã‚ºï¼ˆå†…éƒ¨ã§è„šè³ªã‚’åæ˜ ï¼‰
========================= */
function styleBias(style, distance, pace){
Â Â const isSprint = distance <= 1400;
Â Â const isMileÂ Â Â = distance > 1400 && distance <= 1800;
Â Â const isMiddle = distance > 1800 && distance <= 2200;
Â Â const isLongÂ Â Â = distance > 2200;

Â Â let m = 1.0;
Â Â if(isSprint){
Â Â Â Â if(style==="é€ƒã’") m *= 1.10;
Â Â Â Â if(style==="å…ˆè¡Œ") m *= 1.06;
Â Â Â Â if(style==="å·®ã—") m *= 0.96;
Â Â Â Â if(style==="è¿½è¾¼") m *= 0.92;
Â Â }else if(isMile){
Â Â Â Â if(style==="é€ƒã’") m *= 1.05;
Â Â Â Â if(style==="å…ˆè¡Œ") m *= 1.05;
Â Â Â Â if(style==="å·®ã—") m *= 1.00;
Â Â Â Â if(style==="è¿½è¾¼") m *= 0.97;
Â Â }else if(isMiddle){
Â Â Â Â if(style==="é€ƒã’") m *= 0.98;
Â Â Â Â if(style==="å…ˆè¡Œ") m *= 1.00;
Â Â Â Â if(style==="å·®ã—") m *= 1.03;
Â Â Â Â if(style==="è¿½è¾¼") m *= 1.05;
Â Â }else if(isLong){
Â Â Â Â if(style==="é€ƒã’") m *= 0.93;
Â Â Â Â if(style==="å…ˆè¡Œ") m *= 0.97;
Â Â Â Â if(style==="å·®ã—") m *= 1.05;
Â Â Â Â if(style==="è¿½è¾¼") m *= 1.10;
Â Â }

Â Â if(pace==="ãƒã‚¤"){
Â Â Â Â if(style==="é€ƒã’") m *= 0.94;
Â Â Â Â if(style==="è¿½è¾¼") m *= 1.06;
Â Â }else if(pace==="ã‚¹ãƒ­ãƒ¼"){
Â Â Â Â if(style==="é€ƒã’") m *= 1.06;
Â Â Â Â if(style==="è¿½è¾¼") m *= 0.95;
Â Â }

Â Â return clamp(m, 0.85, 1.15);
}

function surfaceBias(surface, going){
Â Â let m = 1.0;
Â Â if(surface==="ãƒ€ãƒ¼ãƒˆ") m *= 1.03;
Â Â if(going==="ç¨é‡") m *= 0.99;
Â Â if(going==="é‡")Â Â Â m *= 0.97;
Â Â if(going==="ä¸è‰¯") m *= 0.95;
Â Â return m;
}

function placePayout100BaseFromOdd(odd){
Â Â const f = 0.36 + 0.08*Math.log(Math.max(1.1, odd));
Â Â return Math.round((odd*100) * clamp(f, 0.30, 0.75));
}

function assignOddsForRace(hs){
Â Â const houseEdge = 1.18;
Â Â const temp = 1.45;
Â Â const noise = 0.22;
Â Â const surfM = surfaceBias(surface, going);

Â Â const scores = hs.map(h=>{
Â Â Â Â const streakBoost = 1 + (h.streak||0)*0.07;
Â Â Â Â const condBoost = 0.90 + (h.condition-0.7)*0.6;
Â Â Â Â const styleMult = styleBias(h.style, distance, pace);
Â Â Â Â const base = Math.max(0.01, h.power * streakBoost * condBoost * styleMult * surfM);
Â Â Â Â const logScore = Math.log(base) + (Math.random()*2-1)*noise;
Â Â Â Â return logScore / temp;
Â Â });

Â Â const maxS = Math.max(...scores);
Â Â const exps = scores.map(s=>Math.exp(s-maxS));
Â Â const sumE = exps.reduce((a,b)=>a+b,0);
Â Â const probs = exps.map(e=>e/sumE);

Â Â hs.forEach((h,i)=>{
Â Â Â Â let p = Math.max(0.01, probs[i]);
Â Â Â Â let odd = (houseEdge / p);
Â Â Â Â odd = clamp(odd, 1.1, 99.9);
Â Â Â Â h.odd = Number(odd.toFixed(1));

Â Â Â Â const base = placePayout100BaseFromOdd(h.odd);
Â Â Â Â h.placeRange = {min: Math.round(base*0.85), max: Math.round(base*1.15)};
Â Â });
}

/* =========================
Â Â ã‚ªãƒƒã‚ºè¡¨ï¼ˆè„šè³ªã¯è¡¨ç¤ºã—ãªã„ï¼‰
========================= */
function renderOddsTable(){
Â Â if(!horses.length){ document.getElementById("oddsTable").innerHTML=""; return; }

Â Â const sorted=[...horses].sort((a,b)=>a.odd-b.odd);
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ“Š ã‚ªãƒƒã‚ºè¡¨ï¼ˆäººæ°—é †ï¼‰</h3>
Â Â <table class="table"><thead><tr>
Â Â Â Â <th>äººæ°—</th><th>é¦¬</th><th>é¦¬å</th><th class="right">å˜å‹</th><th class="right">è¤‡å‹ç›®å®‰</th>
Â Â </tr></thead><tbody>`;

Â Â sorted.forEach((h,i)=>{
Â Â Â Â const r = h.placeRange ? `${h.placeRange.min}ã€œ${h.placeRange.max}å††` : "-";
Â Â Â Â const streakTag = (h.streak||0) > 0 ? `<span class="badge">é€£å‹:${h.streak}</span>` : "";
Â Â Â Â html+=`<tr>
Â Â Â Â Â Â <td>${i+1}</td>
Â Â Â Â Â Â <td><span class="num ${frameClass(h.id)}">${h.id+1}</span></td>
Â Â Â Â Â Â <td>${h.name}${streakTag}</td>
Â Â Â Â Â Â <td class="right"><b>${h.odd}</b>å€</td>
Â Â Â Â Â Â <td class="right">${r}</td>
Â Â Â Â </tr>`;
Â Â });

Â Â html+=`</tbody></table>`;
Â Â document.getElementById("oddsTable").innerHTML=html;
}

/* =========================
Â Â è³­ã‘UIï¼ˆå˜å‹/è¤‡å‹ï¼‰ï¼‹ç· åˆ‡
========================= */
function buildHorseOptions(){
Â Â return horses.map(h=>`<option value="${h.id}">${h.id+1} ${h.name}ï¼ˆ${h.odd}å€ï¼‰</option>`).join("");
}

function renderBetUI(){
Â Â if(!horses.length){
Â Â Â Â document.getElementById("betUI").innerHTML=`<div class="muted">å…ˆã«ã€Œå‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã€ã‚’ä½œã£ã¦ã­ã€‚</div>`;
Â Â Â Â document.getElementById("oddsTable").innerHTML="";
Â Â Â Â return;
Â Â }

Â Â renderOddsTable();

Â Â const opts = buildHorseOptions();
Â Â let html = "";

Â Â players.forEach((p,pi)=>{
Â Â Â Â const disabled = bettingClosed || p.money<=0 ? "disabled" : "";
Â Â Â Â const note = bettingClosed ? `<span class="bad">ç· åˆ‡</span>` : (p.money<=0 ? `<span class="bad">æ•—é€€</span>` : `<span class="ok">å—ä»˜ä¸­</span>`);

Â Â Â Â html += `<div class="box" style="margin:10px 0">
Â Â Â Â Â Â <div><b>${p.name}</b>ï¼ˆæ‰€æŒé‡‘ï¼š${p.money}å††ï¼‰ ${note}</div>
Â Â Â Â Â Â <div class="row" style="margin-top:6px">
Â Â Â Â Â Â Â Â <label>åˆ¸ç¨®
Â Â Â Â Â Â Â Â Â Â <select id="type${pi}" ${disabled}>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="win">å˜å‹</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="place">è¤‡å‹</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é¦¬
Â Â Â Â Â Â Â Â Â Â <select id="horse${pi}" ${disabled}>${opts}</select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é‡‘é¡
Â Â Â Â Â Â Â Â Â Â <input id="amt${pi}" type="number" min="100" step="100" value="100" ${disabled}/>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â </div>`;
Â Â });

Â Â document.getElementById("betUI").innerHTML = html;
}

/* =========================
Â Â èµ°ã£ã¦ã‚‹é¦¬ï¼ˆGIFï¼‰
========================= */
function renderRaceLanes(){
Â Â let html="";
Â Â horses.forEach(h=>{
Â Â Â Â html+=`<div class="horseLine">
Â Â Â Â Â Â <div><span class="num ${frameClass(h.id)}">${h.id+1}</span>
Â Â Â Â Â Â Â Â <b>${h.name}</b> <span class="badge">${h.odd}å€</span>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="track">
Â Â Â Â Â Â Â Â <div class="lane"></div>
Â Â Â Â Â Â Â Â <div class="finishLine"></div>
Â Â Â Â Â Â Â Â <img id="horseGif${h.id}" class="horseIcon" src="horse.gif" alt="horse"
Â Â Â Â Â Â Â Â Â Â Â Â Â onerror="fallbackHorse(${h.id})">
Â Â Â Â Â Â Â Â <span id="horseEmoji${h.id}" class="horseFallback" style="display:none">ğŸ</span>
Â Â Â Â Â Â </div>
Â Â Â Â </div>`;
Â Â });
Â Â document.getElementById("race").innerHTML=html;
}

window.fallbackHorse = function(id){
Â Â const img = document.getElementById("horseGif"+id);
Â Â const emo = document.getElementById("horseEmoji"+id);
Â Â if(img) img.style.display="none";
Â Â if(emo) emo.style.display="inline";
};

/* =========================
Â Â ãƒ¬ãƒ¼ã‚¹ï¼ˆå…¨é ­ã‚´ãƒ¼ãƒ«ã¾ã§ï¼‰
========================= */
function goingSpeedFactor(going){
Â Â if(going==="è‰¯") return 1.00;
Â Â if(going==="ç¨é‡") return 0.99;
Â Â if(going==="é‡")Â Â Â return 0.97;
Â Â if(going==="ä¸è‰¯") return 0.95;
Â Â return 1.00;
}

function step(){
Â Â const newlyFinished = [];
Â Â const goF = goingSpeedFactor(going);

Â Â horses.forEach(h=>{
Â Â Â Â if(h.fin) return;

Â Â Â Â let s = Math.random()*6 + (h.power*0.65);
Â Â Â Â s *= (1 + (h.streak||0)*0.07);
Â Â Â Â s *= h.condition;
Â Â Â Â s *= goF;

Â Â Â Â if(pace==="ãƒã‚¤" && h.style==="é€ƒã’") s -= 1.6;
Â Â Â Â if(pace==="ãƒã‚¤" && h.style==="è¿½è¾¼") s += 2.2;
Â Â Â Â if(pace==="ã‚¹ãƒ­ãƒ¼" && h.style==="é€ƒã’") s += 1.4;
Â Â Â Â if(pace==="ã‚¹ãƒ­ãƒ¼" && h.style==="è¿½è¾¼") s -= 1.2;

Â Â Â Â if(h.pos>80){
Â Â Â Â Â Â if(h.style==="è¿½è¾¼") s *= 1.10;
Â Â Â Â Â Â if(h.style==="å·®ã—") s *= 1.06;
Â Â Â Â }

Â Â Â Â if(chaos){
Â Â Â Â Â Â s *= (Math.random()*0.7 + 0.65);
Â Â Â Â }

Â Â Â Â if(Math.random()<0.06) s -= 2;
Â Â Â Â if(Math.random()<0.06) s += 2;

Â Â Â Â h.pos += s;

Â Â Â Â const x = Math.max(0, Math.min(96, h.pos));
Â Â Â Â const img = document.getElementById("horseGif"+h.id);
Â Â Â Â const emo = document.getElementById("horseEmoji"+h.id);
Â Â Â Â if(img && img.style.display!=="none") img.style.left = x + "%";
Â Â Â Â if(emo && emo.style.display!=="none") emo.style.left = x + "%";

Â Â Â Â if(h.pos>=100){
Â Â Â Â Â Â h.fin=true;
Â Â Â Â Â Â h._finishScore = h.pos + (Math.random()*0.001);
Â Â Â Â Â Â newlyFinished.push(h);
Â Â Â Â }
Â Â });

Â Â if(newlyFinished.length){
Â Â Â Â newlyFinished.sort((a,b)=>b._finishScore-a._finishScore);
Â Â Â Â newlyFinished.forEach(h=>order.push(h));
Â Â }
}

/* =========================
Â Â æ‰•æˆ»
========================= */
function winPayout100(h){ return Math.round(h.odd * 100); }

function placePayout100Final(h, finishRank, popularityRank){
Â Â const rankMult = (finishRank===1) ? 0.92 : (finishRank===2 ? 1.00 : 1.08);
Â Â const popMultÂ Â = 0.78 + (popularityRank-1)*0.045;
Â Â const base = placePayout100BaseFromOdd(h.odd);
Â Â const wobble = 0.92 + Math.random()*0.16;
Â Â let yen = Math.round(base * rankMult * popMult * wobble);
Â Â return clamp(yen, 110, 9990);
}

/* =========================
Â Â ç²¾ç®—ï¼ˆç„¡åŠ¹ã¯ç†ç”±è¡¨ç¤ºï¼†ãŠé‡‘ã¯æ¸›ã‚‰ãªã„ï¼‰
========================= */
function settleBets(){
Â Â const first=order[0], second=order[1], third=order[2];
Â Â const top3 = new Set([first.id, second.id, third.id]);

Â Â const popSorted=[...horses].sort((a,b)=>a.odd-b.odd);
Â Â const popRankById = new Map();
Â Â popSorted.forEach((h,i)=>popRankById.set(h.id, i+1));

Â Â const placePayById = new Map();
Â Â placePayById.set(first.id,Â Â placePayout100Final(first,Â Â 1, popRankById.get(first.id)));
Â Â placePayById.set(second.id, placePayout100Final(second, 2, popRankById.get(second.id)));
Â Â placePayById.set(third.id,Â Â placePayout100Final(third,Â Â 3, popRankById.get(third.id)));

Â Â let log = [];
Â Â players.forEach((p,pi)=>{
Â Â Â Â if(p.money<=0){
Â Â Â Â Â Â log.push(`${p.name}: æ•—é€€ï¼ˆ0å††ï¼‰ãªã®ã§è³­ã‘ãªã—`);
Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â const typeEl = document.getElementById(`type${pi}`);
Â Â Â Â const horseEl = document.getElementById(`horse${pi}`);
Â Â Â Â const amtEl = document.getElementById(`amt${pi}`);

Â Â Â Â const type = typeEl ? typeEl.value : "win";
Â Â Â Â const pick = horseEl ? Number(horseEl.value) : NaN;
Â Â Â Â let amt = amtEl ? Number(amtEl.value) : NaN;

Â Â Â Â if(!Number.isFinite(amt) || amt < 100){
Â Â Â Â Â Â log.push(`${p.name}: ç„¡åŠ¹ï¼ˆ100å††ä»¥ä¸Šã§è³­ã‘ã¦ã­ï¼‰`);
Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â if(!Number.isFinite(pick) || pick<0 || pick>9){
Â Â Â Â Â Â log.push(`${p.name}: ç„¡åŠ¹ï¼ˆé¦¬ã®é¸æŠãŒãŠã‹ã—ã„ï¼‰`);
Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â const origAmt = amt;
Â Â Â Â if(amt > p.money) amt = p.money;

Â Â Â Â p.money -= amt;

Â Â Â Â if(type==="win"){
Â Â Â Â Â Â if(pick === first.id){
Â Â Â Â Â Â Â Â const back = Math.round(winPayout100(first) * (amt/100));
Â Â Â Â Â Â Â Â p.money += back;
Â Â Â Â Â Â Â Â log.push(`${p.name}: å˜å‹ ${pick+1} ${origAmt}å††ï¼ˆâ†’${amt}å††ï¼‰â†’çš„ä¸­ æ‰•æˆ»${back}å††`);
Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â log.push(`${p.name}: å˜å‹ ${pick+1} ${origAmt}å††ï¼ˆâ†’${amt}å††ï¼‰â†’ãƒã‚ºãƒ¬`);
Â Â Â Â Â Â }
Â Â Â Â }else{
Â Â Â Â Â Â if(top3.has(pick)){
Â Â Â Â Â Â Â Â const back = Math.round(placePayById.get(pick) * (amt/100));
Â Â Â Â Â Â Â Â p.money += back;
Â Â Â Â Â Â Â Â log.push(`${p.name}: è¤‡å‹ ${pick+1} ${origAmt}å††ï¼ˆâ†’${amt}å††ï¼‰â†’çš„ä¸­ æ‰•æˆ»${back}å††`);
Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â log.push(`${p.name}: è¤‡å‹ ${pick+1} ${origAmt}å††ï¼ˆâ†’${amt}å††ï¼‰â†’ãƒã‚ºãƒ¬`);
Â Â Â Â Â Â }
Â Â Â Â }
Â Â });

Â Â return {log, placePayById, popRankById};
}

/* =========================
Â Â çµ‚äº†ï¼ˆå…¨ç€é †ï¼‰
========================= */
function finishRace(){
Â Â const popSorted=[...horses].sort((a,b)=>a.odd-b.odd);
Â Â const popRankById = new Map();
Â Â popSorted.forEach((h,i)=>popRankById.set(h.id, i+1));

Â Â const settle = settleBets();

Â Â const first=order[0], second=order[1], third=order[2];
Â Â const winPay = winPayout100(first);

Â Â function rangeText(yen){
Â Â Â Â const min=Math.round(yen*0.90);
Â Â Â Â const max=Math.round(yen*1.10);
Â Â Â Â return `${yen}å††ï¼ˆ${min}ã€œ${max}ï¼‰`;
Â Â }
Â Â const p1 = settle.placePayById.get(first.id);
Â Â const p2 = settle.placePayById.get(second.id);
Â Â const p3 = settle.placePayById.get(third.id);

Â Â let txt="ğŸ çµæœï¼ˆå…¨ç€é †ï¼‰\n";
Â Â order.forEach((h,i)=>{
Â Â Â Â const pop = popRankById.get(h.id);
Â Â Â Â txt += `${i+1}ç€ ${h.id+1} ${h.name}ï¼ˆäººæ°—:${pop} / ${h.odd}å€ï¼‰\n`;
Â Â });

Â Â txt += `\nã€æ‰•æˆ»é‡‘ï¼ˆ100å††ï¼‰ã€‘\n`;
Â Â txt += `å˜å‹ã€€${first.id+1}ã€€${winPay}å††\n`;
Â Â txt += `è¤‡å‹ã€€${first.id+1}ã€€${rangeText(p1)}\n`;
Â Â txt += `è¤‡å‹ã€€${second.id+1}ã€€${rangeText(p2)}\n`;
Â Â txt += `è¤‡å‹ã€€${third.id+1}ã€€${rangeText(p3)}\n`;

Â Â txt += `\nã€ç²¾ç®—ãƒ­ã‚°ã€‘\n` + settle.log.map(s=>"ãƒ»"+s).join("\n") + "\n";

Â Â // é€£å‹æ›´æ–°ï¼ˆhorseStatsã«åæ˜ ï¼‰
Â Â const winnerId = first.id;
Â Â for(let i=0;i<10;i++){
Â Â Â Â if(i===winnerId){
Â Â Â Â Â Â horseStats[i].wins = (horseStats[i].wins||0) + 1;
Â Â Â Â Â Â horseStats[i].streak = (horseStats[i].streak||0) + 1;
Â Â Â Â }else{
Â Â Â Â Â Â horseStats[i].streak = 0;
Â Â Â Â }
Â Â }

Â Â history.unshift([`${first.name}`, `${second.name}`, `${third.name}`]);
Â Â if(history.length>20) history.pop();

Â Â document.getElementById("result").textContent = txt;

Â Â clearInterval(timer); timer=null;
Â Â bettingClosed=false;
Â Â cardReady=false;

Â Â document.getElementById("btnStart").disabled=true;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
Â Â document.getElementById("btnCard").disabled=false;

Â Â renderBetUI();
Â Â drawPlayers();
Â Â save();
}

/* =========================
Â Â ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆæŠ¼ã—ãŸç¬é–“ã«ç· åˆ‡ï¼†ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
========================= */
function startRace(){
Â Â if(!cardReady || horses.length!==10) { toast("å…ˆã«å‡ºèµ°è¡¨ã‚’ä½œã£ã¦ã­", true); return; }
Â Â if(timer) return;

Â Â bettingClosed=true;
Â Â renderBetUI();
Â Â document.getElementById("btnCard").disabled=true;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹ä¸­â€¦";
Â Â document.getElementById("result").textContent="ãƒ¬ãƒ¼ã‚¹ä¸­â€¦\n";

Â Â order=[];
Â Â horses.forEach(h=>{h.pos=0;h.fin=false;});
Â Â renderRaceLanes();

Â Â timer=setInterval(()=>{
Â Â Â Â step();
Â Â Â Â if(order.length>=10){
Â Â Â Â Â Â finishRace();
Â Â Â Â }
Â Â }, 100);
}

/* =========================
Â Â ãƒªã‚»ãƒƒãƒˆ
========================= */
function resetAll(){
Â Â if(timer){ clearInterval(timer); timer=null; }
Â Â localStorage.removeItem(KEY);
Â Â location.reload();
}
</script>
</body>
</html>
