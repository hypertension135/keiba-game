<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆèµ°ã‚‹ãƒ»è³­ã‘é‡‘Ã—å€ç‡ãƒ»1ç•ªå›ºå®šãªã—ï¼‰</title>
<style>
Â Â body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f4f4f4;margin:0;padding:12px;color:#111}
Â Â h2{margin:0 0 10px;background:#0b8f3c;color:#fff;padding:10px;border-radius:12px}
Â Â .box{background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px;margin:10px 0}
Â Â .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
Â Â button{border:0;border-radius:10px;padding:10px 12px;background:#0b8f3c;color:#fff;font-weight:900}
Â Â button.secondary{background:#333}
Â Â button:disabled{opacity:.45}
Â Â select,input{border:1px solid #ccc;border-radius:10px;padding:8px}
Â Â .muted{color:#666;font-size:13px}
Â Â .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #cfe6ff;background:#eef6ff;color:#0a4a8a;margin-left:6px}
Â Â .bad{border-color:#ffb3b3;background:#ffecec;color:#7a0000}
Â Â .ok{border-color:#b9f2b9;background:#eaffea;color:#0b5a0b}

Â Â .table{width:100%;border-collapse:collapse;font-size:14px}
Â Â .table th,.table td{border-bottom:1px solid #eee;padding:7px 6px;text-align:left}
Â Â .table th{background:#f2f2f2}
Â Â .right{text-align:right}

Â Â #race{display:grid;gap:8px;max-height:52vh;overflow:auto}
Â Â .laneBox{background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px}
Â Â .track{
Â Â Â Â position:relative;height:36px;border-radius:12px;overflow:hidden;margin-top:6px;
Â Â Â Â background:linear-gradient(#141414,#101010),
Â Â Â Â Â Â repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 1px, transparent 1px 72px);
Â Â Â Â background-size:100% 100%,72px 100%;
Â Â Â Â background-position:0 0,var(--bgx,0px) 0;
Â Â }
Â Â .finish{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.8}
Â Â .horse{
Â Â Â Â position:absolute;left:0%;top:7px;
Â Â Â Â font-size:18px;user-select:none;transform-origin:center;
Â Â Â Â filter:drop-shadow(0 2px 2px rgba(0,0,0,.35));
Â Â }
Â Â .label{
Â Â Â Â position:absolute;left:0%;top:-2px;transform:translate(-4px,-12px);
Â Â Â Â font-size:11px;font-weight:900;color:#fff;background:rgba(0,0,0,.55);
Â Â Â Â border:1px solid rgba(255,255,255,.25);padding:2px 6px;border-radius:999px;
Â Â Â Â white-space:nowrap;
Â Â }
Â Â pre{white-space:pre-wrap;background:#111;color:#eee;border-radius:12px;padding:10px;overflow:auto}
</style>
</head>
<body>
<h2>ğŸ‡ ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆèµ°ã‚‹ãƒ»è³­ã‘é‡‘Ã—å€ç‡ãƒ»1ç•ªå›ºå®šãªã—ï¼‰</h2>

<div class="box">
Â Â <div class="row">
Â Â Â Â <button id="btnCard" onclick="makeCard()">å‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã‚’ä½œã‚‹</button>
Â Â Â Â <button id="btnStart" class="secondary" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰</button>
Â Â Â Â <button class="secondary" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
Â Â </div>
Â Â <div class="muted" style="margin-top:8px">
Â Â Â Â ãƒ»å½“ãŸã‚Šï¼š<b>æ‰€æŒé‡‘ï¼‹(è³­ã‘é‡‘Ã—å€ç‡)</b> ï¼ å¤–ã‚Œï¼š<b>æ‰€æŒé‡‘âˆ’è³­ã‘é‡‘</b><br>
Â Â Â Â ãƒ»ãƒ¬ãƒ¼ã‚¹é–‹å§‹æ™‚ã« <b>åˆ¸ç¨®/é¦¬/é‡‘é¡/å€ç‡ã‚’ãƒ­ãƒƒã‚¯</b> â†’ å–ã‚Šé•ãˆãªã—<br>
Â Â Â Â ãƒ»ã€Œå…¨éƒ¨1ç•ªã€ã«ãªã‚‰ãªã„ï¼š<b>åˆæœŸé¸æŠã‚‚å‹æ•—ã‚‚ãƒ©ãƒ³ãƒ€ãƒ </b>ï¼ˆ1ç•ªå›ºå®šã¯ã—ãªã„ï¼‰
Â Â </div>
</div>

<div class="box" id="playersBox"></div>
<div class="box" id="raceInfo"></div>
<div class="box" id="oddsBox"></div>

<div class="box">
Â Â <h3 style="margin:0 0 8px">ğŸŸï¸ è³­ã‘ï¼ˆå˜å‹ / è¤‡å‹ï¼‰</h3>
Â Â <div id="betBox"></div>
Â Â <div id="lockedBox" class="muted"></div>
</div>

<div class="box">
Â Â <h3 style="margin:0 0 8px">ğŸ ãƒ¬ãƒ¼ã‚¹</h3>
Â Â <div id="race"></div>
</div>

<pre id="log">å‡ºèµ°è¡¨ã‚’ä½œã£ã¦ã­ã€‚</pre>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const TARGET_SECONDS = 15;
const MIN_BET = 100;
const STEP = 100;
const N = 10;
const KEY = "keiba_simple_v1";

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const rand=n=>Math.floor(Math.random()*n);
const yen=n=>Math.floor(n);

/* ===== åå‰ç”Ÿæˆ ===== */
const syll=["ã‚µãƒ³","ãƒ©ã‚¤","ãƒ–ãƒ¬","ãƒ•ã‚¡","ãƒ‰","ãƒ«","ã‚«","ã‚°","ãƒ´","ãƒŠ","ãƒˆ","ã‚­","ãƒ©","ã‚¹","ã‚»ã‚¤","ãƒ¦ã‚¦","ã‚ªã‚¦","ã‚·ãƒ³","ãƒãƒ«","ãƒ†ãƒ„","ãƒ’ãƒ¡","ã‚¼ãƒ³","ãƒŸãƒ¤","ã‚¢ã‚­","ãƒ›ã‚·","ã‚«ã‚¼","ãƒ„ã‚­","ãƒ¦ãƒ¡"];
function genName(){ let s=""; const parts=2+rand(2); for(let i=0;i<parts;i++) s+=syll[rand(syll.length)]; return s; }
function uniqueNames(n){ const set=new Set(); while(set.size<n) set.add(genName()); return [...set]; }

/* ===== ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ ===== */
let players=[{name:"P1",money:1500,dead:false},{name:"P2",money:1500,dead:false},{name:"P3",money:1500,dead:false}];
try{
Â Â const raw=localStorage.getItem(KEY);
Â Â if(raw){
Â Â Â Â const d=JSON.parse(raw);
Â Â Â Â if(d?.players) players=d.players;
Â Â }
}catch(e){}
function save(){ try{ localStorage.setItem(KEY, JSON.stringify({players})); }catch(e){} }

/* ===== ãƒ¬ãƒ¼ã‚¹çŠ¶æ…‹ ===== */
let horses=[];
let cardReady=false, bettingClosed=false;
let lockedBets=[]; // {pi,type,horseId,amt,odd}
let raf=null, lastT=null, startT=null, bgx=0, finishOrder=[];

/* ===== UI ===== */
function drawPlayers(){
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ’° æ‰€æŒé‡‘</h3>`;
Â Â for(const p of players){
Â Â Â Â const tag = (p.money<=0||p.dead) ? `<span class="tag bad">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</span>` : `<span class="tag ok">å‚åŠ ä¸­</span>`;
Â Â Â Â html += `<div>${p.name}ï¼š<b>${p.money}</b>å†† ${tag}</div>`;
Â Â }
Â Â document.getElementById("playersBox").innerHTML=html;
}
drawPlayers();

function raceInfo(){
Â Â document.getElementById("raceInfo").innerHTML =
Â Â Â Â `<h3 style="margin:0 0 8px">ğŸ“Œ ãƒ¬ãƒ¼ã‚¹æ¡ä»¶</h3>
Â Â Â Â Â è·é›¢ï¼š<b>${(1000+rand(1400))}m</b>ã€€<span class="tag">ç´„${TARGET_SECONDS}ç§’</span>`;
}

function renderOdds(){
Â Â const sorted=[...horses].sort((a,b)=>a.winOdd-b.winOdd);
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ“Š ã‚ªãƒƒã‚ºè¡¨ï¼ˆäººæ°—é †ï¼‰</h3>
Â Â Â Â <table class="table"><thead><tr>
Â Â Â Â Â Â <th>äººæ°—</th><th>é¦¬ç•ª</th><th>é¦¬å</th><th class="right">å˜å‹</th><th class="right">è¤‡å‹</th>
Â Â Â Â </tr></thead><tbody>`;
Â Â sorted.forEach((h,i)=>{
Â Â Â Â html += `<tr>
Â Â Â Â Â Â <td>${i+1}</td><td>${h.id+1}</td><td>${h.name}</td>
Â Â Â Â Â Â <td class="right"><b>${h.winOdd}</b>å€</td>
Â Â Â Â Â Â <td class="right"><b>${h.placeOdd}</b>å€</td>
Â Â Â Â </tr>`;
Â Â });
Â Â html += `</tbody></table>`;
Â Â document.getElementById("oddsBox").innerHTML=html;
}

function horseOptions(){
Â Â // â€œå…¨éƒ¨1ç•ªâ€ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã€UIã¯äººæ°—é †ã§ã¯ãªãç•ªå·é †ã§å‡ºã™
Â Â return horses.map(h=>`<option value="${h.id}">${h.id+1} ${h.name}ï¼ˆå˜${h.winOdd} / è¤‡${h.placeOdd}ï¼‰</option>`).join("");
}

function minBetFor(m){
Â Â if(m<=0) return 0;
Â Â return (m>=MIN_BET) ? MIN_BET : m; // å°‘ãªã„æ™‚ã¯å…¨é¡è³­ã‘ã‚‰ã‚Œã‚‹
}

function normalizeBet(m, v){
Â Â if(m<=0) return 0;
Â Â let x=Number(v);
Â Â if(!Number.isFinite(x) || x<0) x=0;

Â Â if(m>=MIN_BET){
Â Â Â Â x = Math.floor(x/STEP)*STEP;
Â Â Â Â if(x>m) x = Math.floor(m/STEP)*STEP;
Â Â Â Â if(x>0 && x<MIN_BET) x = MIN_BET;
Â Â Â Â if(x>m) x = 0;
Â Â }else{
Â Â Â Â x = Math.floor(x);
Â Â Â Â if(x>m) x = m;
Â Â Â Â if(x>0 && x<m) x = m; // 1ã€œ99å††ã¯å…¨é¡ã«å¯„ã›ã‚‹
Â Â }
Â Â return x;
}

function renderBets(){
Â Â const opts = horseOptions();
Â Â let html="";
Â Â players.forEach((p,pi)=>{
Â Â Â Â const dead = (p.money<=0||p.dead);
Â Â Â Â const disabled = (bettingClosed||dead) ? "disabled" : "";
Â Â Â Â const tag = bettingClosed ? `<span class="tag bad">ç· åˆ‡</span>` : (dead?`<span class="tag bad">GO</span>`:`<span class="tag ok">å—ä»˜</span>`);

Â Â Â Â // â€œå…¨éƒ¨1ç•ªâ€ã«ãªã‚‰ãªã„ï¼šåˆæœŸé¸æŠã¯æ¯å›ãƒ©ãƒ³ãƒ€ãƒ 
Â Â Â Â const defHorse = rand(N);
Â Â Â Â const defType = (Math.random()<0.5) ? "win" : "place";
Â Â Â Â const defAmt = minBetFor(p.money);

Â Â Â Â html += `<div class="box" style="margin:10px 0">
Â Â Â Â Â Â <div><b>${p.name}</b>ï¼ˆæ‰€æŒé‡‘ï¼š${p.money}å††ï¼‰ ${tag}</div>
Â Â Â Â Â Â <div class="row" style="margin-top:6px">
Â Â Â Â Â Â Â Â <label>åˆ¸ç¨®
Â Â Â Â Â Â Â Â Â Â <select id="type${pi}" ${disabled}>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="win"${defType==="win"?" selected":""}>å˜å‹</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="place"${defType==="place"?" selected":""}>è¤‡å‹</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é¦¬
Â Â Â Â Â Â Â Â Â Â <select id="horse${pi}" ${disabled}>${opts}</select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é‡‘é¡
Â Â Â Â Â Â Â Â Â Â <input id="amt${pi}" ${disabled} type="number" inputmode="numeric"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â min="0" step="${p.money>=MIN_BET?STEP:1}" value="${defAmt}">
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <span class="muted">â€»æ‰€æŒé‡‘ãŒå°‘ãªã„æ™‚ã‚‚è³­ã‘OK</span>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div id="warn${pi}" class="muted" style="margin-top:6px"></div>
Â Â Â Â </div>`;
Â Â });

Â Â document.getElementById("betBox").innerHTML=html;

Â Â // ãƒ©ãƒ³ãƒ€ãƒ åˆæœŸé¦¬ã‚’å®Ÿéš›ã«ã‚»ãƒƒãƒˆï¼ˆselectã¯å¾Œã§å€¤ã‚’å…¥ã‚Œã‚‹ï¼‰
Â Â players.forEach((p,pi)=>{
Â Â Â Â const sel = document.getElementById("horse"+pi);
Â Â Â Â if(sel){
Â Â Â Â Â Â sel.value = String(rand(N));
Â Â Â Â }
Â Â Â Â validateBet(pi);
Â Â Â Â // å…¥åŠ›æ™‚ã«éƒ½åº¦è£œæ­£
Â Â Â Â const amt = document.getElementById("amt"+pi);
Â Â Â Â if(amt){
Â Â Â Â Â Â amt.oninput = ()=>validateBet(pi);
Â Â Â Â }
Â Â });
}

function validateBet(pi){
Â Â const p=players[pi];
Â Â const warn=document.getElementById("warn"+pi);
Â Â const amt=document.getElementById("amt"+pi);
Â Â if(!p || !warn || !amt) return;

Â Â const norm = normalizeBet(p.money, amt.value);
Â Â amt.value = norm;

Â Â if(p.money<=0 || p.dead){
Â Â Â Â warn.textContent="ã“ã®äººã¯ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚";
Â Â Â Â return;
Â Â }
Â Â if(norm<=0){
Â Â Â Â // ã“ã“ãŒã€Œçµ¶å¯¾ã«è³­ã‘ã‚Œã‚‹ã€ï¼š0å††ãªã‚‰è‡ªå‹•ã§æœ€ä½é¡ã«æˆ»ã™
Â Â Â Â const m=minBetFor(p.money);
Â Â Â Â amt.value=m;
Â Â Â Â warn.textContent = `è‡ªå‹•ã§ ${m}å†† ã«ã—ã¾ã—ãŸï¼ˆå¿…ãšè³­ã‘ã‚‰ã‚Œã‚‹ä»•æ§˜ï¼‰`;
Â Â }else{
Â Â Â Â warn.textContent = "";
Â Â }
}

function renderLocked(){
Â Â const box=document.getElementById("lockedBox");
Â Â if(!lockedBets.length){
Â Â Â Â box.innerHTML = bettingClosed ? `<span class="tag bad">è³­ã‘ãªã—</span>` : "";
Â Â Â Â return;
Â Â }
Â Â const lines = lockedBets.map(b=>{
Â Â Â Â const h=horses[b.horseId];
Â Â Â Â const kind=(b.type==="win")?"å˜å‹":"è¤‡å‹";
Â Â Â Â return `${players[b.pi].name}ï¼š${kind} ${b.horseId+1} ${h.name} ${b.amt}å††ï¼ˆ${b.odd}å€ãƒ­ãƒƒã‚¯ï¼‰`;
Â Â });
Â Â box.innerHTML = `<div class="tag">ğŸ”’ ãƒ­ãƒƒã‚¯æ¸ˆã¿</div><div style="margin-top:6px">${lines.join("<br>")}</div>`;
}

/* ===== ã‚ªãƒƒã‚ºä½œæˆï¼ˆ1äººæ°—<=3 / 10äººæ°—>=150 / 1ç•ªå›ºå®šãªã—ï¼‰ ===== */
function makeOdds(hs){
Â Â // â€œç•ªå·1ãŒå¸¸ã«äººæ°—/å‹ã¤â€ã‚’é¿ã‘ã‚‹ï¼šèƒ½åŠ›ã¨äººæ°—ã¯æ¯å›ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚Œã‚‹
Â Â const scores=hs.map(h=>Math.log(h.power)+ (Math.random()*2-1)*0.18);
Â Â const idx=[...hs.keys()].sort((a,b)=>scores[b]-scores[a]);

Â Â const fav=2.2+Math.random()*0.8;
Â Â const mid=25+Math.random()*35;
Â Â const last=150+Math.random()*120;

Â Â function easeOut(t){return 1-Math.pow(1-t,2);}
Â Â function easeIn(t){return t*t;}

Â Â idx.forEach((hid,rank)=>{
Â Â Â Â let odd;
Â Â Â Â if(rank<=4){
Â Â Â Â Â Â odd = fav + (mid-fav)*easeOut(rank/4);
Â Â Â Â }else{
Â Â Â Â Â Â odd = mid + (last-mid)*easeIn((rank-5)/4);
Â Â Â Â }
Â Â Â Â odd *= (0.96+Math.random()*0.08);
Â Â Â Â if(rank===0) odd=Math.min(3.0,odd);
Â Â Â Â if(rank===9) odd=Math.max(150.0,odd);
Â Â Â Â hs[hid].winOdd = Number(clamp(odd,1.1,999.9).toFixed(1));
Â Â });

Â Â // è¤‡å‹ã¯å˜å‹ã‹ã‚‰ä½œã‚‹ï¼ˆæ§ãˆã‚ï¼‰
Â Â const pop=[...hs].sort((a,b)=>a.winOdd-b.winOdd);
Â Â const rankMap=new Map(); pop.forEach((h,i)=>rankMap.set(h.id,i+1));
Â Â hs.forEach(h=>{
Â Â Â Â const r=rankMap.get(h.id);
Â Â Â Â let po = 1 + (h.winOdd-1)*(0.28+Math.random()*0.12);
Â Â Â Â po *= (0.95+(r-1)*0.02);
Â Â Â Â po *= (0.97+Math.random()*0.06);
Â Â Â Â h.placeOdd = Number(clamp(po,1.1,35).toFixed(2));
Â Â });
}

/* ===== å‡ºèµ°è¡¨ä½œæˆ ===== */
function makeCard(){
Â Â stopRace();

Â Â const names=uniqueNames(N);
Â Â horses = Array.from({length:N},(_,i)=>({
Â Â Â Â id:i,
Â Â Â Â name:names[i],
Â Â Â Â power: 1.0 + Math.random()*8.0, // æ¯å›å¤‰ã‚ã‚‹
Â Â Â Â winOdd:0,
Â Â Â Â placeOdd:0,

Â Â Â Â p:0, v:0.02, fin:false, finAt:0, // vã‚’å°‘ã—å…¥ã‚Œã¦ã€Œå¿…ãšèµ°ã‚‹ã€
Â Â Â Â accel: 1.2 + Math.random()*1.1,
Â Â Â Â stamina: 0.85 + Math.random()*0.25,
Â Â Â Â top: 0.85 + Math.random()*0.35,
Â Â Â Â kick: 1.0 + Math.random()*0.25,
Â Â }));

Â Â makeOdds(horses);

Â Â cardReady=true;
Â Â bettingClosed=false;
Â Â lockedBets=[];
Â Â finishOrder=[];
Â Â bgx=0; lastT=null; startT=null;

Â Â document.getElementById("btnStart").disabled=false;
Â Â document.getElementById("log").textContent="è³­ã‘ã‚’å…¥ã‚Œã¦ã€Œãƒ¬ãƒ¼ã‚¹é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ã­ã€‚";

Â Â raceInfo();
Â Â renderOdds();
Â Â renderBets();
Â Â renderLocked();
Â Â renderRaceLanes();
}

function renderRaceLanes(){
Â Â let html="";
Â Â for(const h of horses){
Â Â Â Â html += `<div class="laneBox">
Â Â Â Â Â Â <div><b>${h.id+1} ${h.name}</b>
Â Â Â Â Â Â Â Â <span class="tag">å˜${h.winOdd}</span><span class="tag">è¤‡${h.placeOdd}</span>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div id="track${h.id}" class="track" style="--bgx:0px">
Â Â Â Â Â Â Â Â <div class="finish"></div>
Â Â Â Â Â Â Â Â <div id="label${h.id}" class="label">${h.id+1} ${h.name}</div>
Â Â Â Â Â Â Â Â <div id="horse${h.id}" class="horse">ğŸ</div>
Â Â Â Â Â Â </div>
Â Â Â Â </div>`;
Â Â }
Â Â document.getElementById("race").innerHTML=html;
Â Â for(const h of horses) setHorseX(h.id,0,0,true);
}

function setHorseX(id, p01, s01, init=false){
Â Â const x = clamp(p01,0,0.96)*100;
Â Â const horse=document.getElementById("horse"+id);
Â Â const label=document.getElementById("label"+id);
Â Â if(!horse || !label) return;

Â Â const bob = init?0:Math.sin((p01*60)+(performance.now()/85))*(2+s01*6);
Â Â const tilt = init?0:(-2+s01*4);
Â Â const scale = 1 + s01*0.06;

Â Â horse.style.left = x+"%";
Â Â horse.style.transform = `translateY(${bob*0.35}px) rotate(${tilt}deg) scale(${scale})`;

Â Â label.style.left = x+"%";
}

/* ===== è³­ã‘ãƒ­ãƒƒã‚¯ï¼ˆçµ¶å¯¾ã‚ºãƒ¬ãªã„ï¼‰ ===== */
function lockBets(){
Â Â lockedBets=[];
Â Â players.forEach((p,pi)=>{
Â Â Â Â if(p.money<=0 || p.dead) return;

Â Â Â Â const type = document.getElementById("type"+pi)?.value ?? "win";
Â Â Â Â const horseId = Number(document.getElementById("horse"+pi)?.value);
Â Â Â Â const amtIn = document.getElementById("amt"+pi)?.value ?? "0";
Â Â Â Â let amt = normalizeBet(p.money, amtIn);

Â Â Â Â // ã“ã“ã‚‚ã€Œå¿…ãšè³­ã‘ã‚Œã‚‹ã€ï¼š0ãªã‚‰æœ€ä½é¡ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆ
Â Â Â Â if(amt<=0){
Â Â Â Â Â Â amt = minBetFor(p.money);
Â Â Â Â Â Â const amtEl=document.getElementById("amt"+pi);
Â Â Â Â Â Â if(amtEl) amtEl.value = amt;
Â Â Â Â }

Â Â Â Â if(!Number.isFinite(horseId) || horseId<0 || horseId>=N) return;

Â Â Â Â const h = horses[horseId];
Â Â Â Â const odd = (type==="win") ? h.winOdd : h.placeOdd;

Â Â Â Â lockedBets.push({pi,type,horseId,amt,odd});
Â Â });
}

/* ===== èµ°ã‚Šï¼ˆç´„15ç§’ï¼‰ ===== */
function startRace(){
Â Â if(!cardReady || !horses.length) return;
Â Â if(raf) return;

Â Â // å…¨å“¡ã®è³­ã‘ã‚’è£œæ­£ã—ã¦ãƒ­ãƒƒã‚¯ï¼ˆå¿…ãšè³­ã‘ã‚‰ã‚Œã‚‹ï¼‰
Â Â bettingClosed=true;
Â Â players.forEach((_,pi)=>validateBet(pi));
Â Â lockBets();

Â Â // â€œè³­ã‘ãŒ0ä»¶â€ã ã‘ã¯é–‹å§‹ã§ããªã„ï¼ˆã§ã‚‚åŸºæœ¬ãƒ­ãƒƒã‚¯ã§å›é¿ã•ã‚Œã‚‹ï¼‰
Â Â if(lockedBets.length===0){
Â Â Â Â document.getElementById("log").textContent="è³­ã‘ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ‰€æŒé‡‘ãŒã‚ã‚‹äººã¯è‡ªå‹•ã§è³­ã‘ãŒå…¥ã‚‹ã¯ãšã§ã™ã€‚";
Â Â Â Â bettingClosed=false;
Â Â Â Â return;
Â Â }

Â Â renderLocked();
Â Â document.getElementById("btnCard").disabled=true;
Â Â document.getElementById("btnStart").disabled=true;

Â Â // åˆæœŸåŒ–
Â Â finishOrder=[];
Â Â bgx=0; lastT=null; startT=null;
Â Â for(const h of horses){
Â Â Â Â h.p=0; h.v=0.02; h.fin=false; h.finAt=0; // â€œå¿…ãšèµ°ã‚‹â€
Â Â Â Â setHorseX(h.id,0,0,true);
Â Â }

Â Â document.getElementById("log").textContent="ãƒ¬ãƒ¼ã‚¹ä¸­â€¦";
Â Â raf=requestAnimationFrame(step);
}

function step(ts){
Â Â if(!startT) startT=ts;
Â Â if(!lastT) lastT=ts;
Â Â const dt=(ts-lastT)/1000;
Â Â lastT=ts;

Â Â // 15ç§’ã«å¯„ã›ã‚‹ã‚¹ã‚±ãƒ¼ãƒ«
Â Â const elapsed=(ts-startT)/1000;
Â Â let leaderP=0;
Â Â for(const h of horses) leaderP=Math.max(leaderP,h.p);
Â Â const remainT=Math.max(0.7, TARGET_SECONDS-elapsed);
Â Â const remainD=Math.max(0.001, 1-leaderP);
Â Â const baseAvg=1/TARGET_SECONDS;
Â Â const desired=remainD/remainT;
Â Â const timeScale=clamp(desired/baseAvg, 0.75, 1.35);

Â Â // åœ°é¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
Â Â let leaderV=0; for(const h of horses) leaderV=Math.max(leaderV,h.v);
Â Â bgx -= (leaderV*1100)*dt;
Â Â for(const h of horses){
Â Â Â Â const tr=document.getElementById("track"+h.id);
Â Â Â Â if(tr) tr.style.setProperty("--bgx", `${bgx}px`);
Â Â }

Â Â for(const h of horses){
Â Â Â Â if(h.fin) continue;

Â Â Â Â const p=h.p;
Â Â Â Â const staminaDrop = 1 - (p*(0.55/h.stamina));
Â Â Â Â const staminaMult = clamp(staminaDrop,0.55,1.05);
Â Â Â Â const kickZone = p>0.80 ? (1 + (p-0.80)/0.20*(h.kick-1)) : 1;

Â Â Â Â // â€œ1ç•ªå›ºå®šâ€é˜²æ­¢ï¼šå‹æ•—ã¯power + ä¹±æ•°ã§å¤‰åŒ–
Â Â Â Â const powerMult = (0.85 + h.power*0.06) * (0.92 + (Math.random()*0.08));

Â Â Â Â const minSpeed = baseAvg*0.35; // çµ¶å¯¾æ­¢ã¾ã‚‰ãªã„
Â Â Â Â const topSpeed = Math.max(
Â Â Â Â Â Â minSpeed,
Â Â Â Â Â Â baseAvg*(0.75+h.top*0.55)*powerMult*staminaMult*kickZone*timeScale
Â Â Â Â );

Â Â Â Â const accel = h.accel*(0.9+Math.random()*0.2);
Â Â Â Â if(h.v<=0) h.v=minSpeed*0.5;
Â Â Â Â h.v += (topSpeed-h.v)*clamp(accel*dt,0,1);

Â Â Â Â const wobble = 1 + (Math.random()*2-1)*0.025;
Â Â Â Â h.p += h.v*dt*wobble;

Â Â Â Â if(h.p>=1){
Â Â Â Â Â Â h.p=1; h.fin=true; h.finAt=performance.now();
Â Â Â Â Â Â finishOrder.push(h);
Â Â Â Â }

Â Â Â Â const s01=clamp(h.v/(baseAvg*1.8),0,1);
Â Â Â Â setHorseX(h.id,h.p,s01);
Â Â }

Â Â if(finishOrder.length>=N){
Â Â Â Â finishRace();
Â Â Â Â return;
Â Â }
Â Â raf=requestAnimationFrame(step);
}

/* ===== ç²¾ç®—ï¼ˆè³­ã‘é‡‘Ã—å€ç‡ï¼‰ ===== */
function finishRace(){
Â Â stopRace();

Â Â finishOrder.sort((a,b)=>a.finAt-b.finAt);
Â Â const first=finishOrder[0], second=finishOrder[1], third=finishOrder[2];
Â Â const top3 = new Set([first.id, second.id, third.id]);

Â Â let out="ğŸ çµæœ\n";
Â Â finishOrder.forEach((h,i)=>out+=`${i+1}ç€ï¼š${h.id+1} ${h.name}\n`);

Â Â out += `\nã€ç²¾ç®—ã€‘å½“ãŸã‚Šï¼šï¼‹(è³­ã‘é‡‘Ã—å€ç‡) / å¤–ã‚Œï¼šâˆ’è³­ã‘é‡‘\n`;

Â Â for(const b of lockedBets){
Â Â Â Â const p=players[b.pi];
Â Â Â Â if(!p || p.dead) continue;

Â Â Â Â // å¿µã®ãŸã‚æ‰€æŒé‡‘ä»¥ä¸Šã¯è³­ã‘ãªã„
Â Â Â Â const stake = Math.min(b.amt, p.money);

Â Â Â Â const hit = (b.type==="win") ? (b.horseId===first.id) : top3.has(b.horseId);
Â Â Â Â if(hit){
Â Â Â Â Â Â const gain = yen(stake * b.odd);
Â Â Â Â Â Â p.money += gain;
Â Â Â Â Â Â out += `ãƒ»${p.name}ï¼š${b.type==="win"?"å˜å‹":"è¤‡å‹"} ${b.horseId+1}ç•ª ${stake}å†† â†’ çš„ä¸­ï¼ +${gain}å††ï¼ˆ${b.odd}å€ï¼‰\n`;
Â Â Â Â }else{
Â Â Â Â Â Â p.money -= stake;
Â Â Â Â Â Â out += `ãƒ»${p.name}ï¼š${b.type==="win"?"å˜å‹":"è¤‡å‹"} ${b.horseId+1}ç•ª ${stake}å†† â†’ ãƒã‚ºãƒ¬ -${stake}å††\n`;
Â Â Â Â }

Â Â Â Â if(p.money<=0){
Â Â Â Â Â Â p.money=0; p.dead=true;
Â Â Â Â Â Â out += `Â Â â†’ ${p.name} ã¯ 0å††ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼\n`;
Â Â Â Â }
Â Â }

Â Â document.getElementById("log").textContent=out;

Â Â // æ¬¡ã®æº–å‚™
Â Â drawPlayers();
Â Â save();

Â Â cardReady=false;
Â Â bettingClosed=false;
Â Â lockedBets=[];
Â Â document.getElementById("btnCard").disabled=false;
Â Â document.getElementById("btnStart").disabled=true;
}

/* ===== åœæ­¢ ===== */
function stopRace(){
Â Â if(raf){ cancelAnimationFrame(raf); raf=null; }
Â Â lastT=null; startT=null;
}

/* ===== ãƒªã‚»ãƒƒãƒˆ ===== */
function resetAll(){
Â Â stopRace();
Â Â try{ localStorage.removeItem(KEY); }catch(e){}
Â Â location.reload();
}
</script>
</body>
</html>
