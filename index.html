<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆå·¦â†’å³ã«ç¢ºå®Ÿã«èµ°ã‚‹ï¼‰</title>
<style>
Â Â body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f4f4f4;margin:0;padding:12px;color:#111}
Â Â h2{margin:0 0 10px;background:#0b8f3c;color:#fff;padding:10px;border-radius:12px}
Â Â .box{background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px;margin:10px 0}
Â Â .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
Â Â button{border:0;border-radius:10px;padding:10px 12px;background:#0b8f3c;color:#fff;font-weight:900}
Â Â button.secondary{background:#333}
Â Â button:disabled{opacity:.45}
Â Â select,input{border:1px solid #ccc;border-radius:10px;padding:8px}
Â Â .muted{color:#666;font-size:13px;line-height:1.5}
Â Â .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #cfe6ff;background:#eef6ff;color:#0a4a8a;margin-left:6px}
Â Â .bad{border-color:#ffb3b3;background:#ffecec;color:#7a0000}
Â Â .ok{border-color:#b9f2b9;background:#eaffea;color:#0b5a0b}
Â Â pre{white-space:pre-wrap;background:#111;color:#eee;border-radius:12px;padding:10px;overflow:auto}

Â Â .table{width:100%;border-collapse:collapse;font-size:14px}
Â Â .table th,.table td{border-bottom:1px solid #eee;padding:6px 6px;text-align:left;vertical-align:top}
Â Â .table th{background:#f2f2f2}
Â Â .right{text-align:right}

Â Â /* â˜…é¦¬åŒå£«ã®é–“éš”ã‚’è©°ã‚ã‚‹ */
Â Â #race{display:grid; gap:2px; max-height:70vh; overflow:auto}
Â Â .laneBox{background:#fff;border:1px solid #ddd;border-radius:10px;padding:4px}

Â Â .track{
Â Â Â Â position:relative;height:24px;border-radius:10px;overflow:hidden;margin-top:2px;
Â Â Â Â background:linear-gradient(#141414,#101010),
Â Â Â Â Â Â repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 1px, transparent 1px 72px);
Â Â }
Â Â .finish{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.85}

Â Â /* èµ°ã‚‹æœ¬ä½“ï¼ˆå·¦â†’å³ï¼‰ */
Â Â .runner{
Â Â Â Â position:absolute;left:0%;top:0;height:100%;
Â Â Â Â width:100%;
Â Â Â Â pointer-events:none;
Â Â }
Â Â @keyframes runLR{
Â Â Â Â from{ left:0%; }
Â Â Â Â to{ left:92%; } /* å³ç«¯ã¾ã§ */
Â Â }

Â Â /* ãƒ©ãƒ™ãƒ«ã¯é€†ã«ãªã‚‰ãªã„ï¼ˆrunnerã”ã¨å‹•ãï¼‰ */
Â Â .label{
Â Â Â Â position:absolute;left:0;top:-2px;transform:translate(-4px,-10px);
Â Â Â Â font-size:10px;font-weight:900;color:#fff;background:rgba(0,0,0,.55);
Â Â Â Â border:1px solid rgba(255,255,255,.25);padding:1px 6px;border-radius:999px;
Â Â Â Â white-space:nowrap;
Â Â }

Â Â /* é¦¬ã ã‘é€†å‘ãè¡¨ç¤ºï¼ˆå·¦å‘ãã®è¦‹ãŸç›®ï¼‰ */
Â Â .horseWrap{
Â Â Â Â position:absolute;left:0;top:2px;
Â Â Â Â transform:scaleX(-1); /* â˜…é¦¬ã ã‘åè»¢ */
Â Â Â Â transform-origin:left center;
Â Â Â Â filter:drop-shadow(0 2px 2px rgba(0,0,0,.35));
Â Â }
Â Â .horseIcon{
Â Â Â Â font-size:18px;
Â Â Â Â animation: bob .33s ease-in-out infinite;
Â Â }
Â Â @keyframes bob{
Â Â Â Â 0%{ transform:translateY(0px); }
Â Â Â Â 50%{ transform:translateY(-2px); }
Â Â Â Â 100%{ transform:translateY(0px); }
Â Â }
</style>
</head>
<body>
<h2>ğŸ‡ ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆå·¦â†’å³ã«ç¢ºå®Ÿã«èµ°ã‚‹ï¼‰</h2>

<div class="box">
Â Â <div class="row">
Â Â Â Â <button id="btnCard" onclick="makeCard()">å‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã‚’ä½œã‚‹</button>
Â Â Â Â <button id="btnStart" class="secondary" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰</button>
Â Â Â Â <button class="secondary" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
Â Â </div>
Â Â <div class="muted" style="margin-top:8px">
Â Â Â Â ãƒ»ã‚¹ã‚¿ãƒ¼ãƒˆæŠ¼ã—ãŸã‚‰ <b>çµ¶å¯¾ã«å·¦â†’å³ã¸èµ°ã‚‹</b>ï¼ˆCSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰<br>
Â Â Â Â ãƒ»è³­ã‘ï¼šå˜å‹/è¤‡å‹ ãƒ»é–‹å§‹æ™‚ã«è³­ã‘é‡‘ã‚’å¼•ã„ã¦ã€çš„ä¸­ã§ <b>è³­ã‘é‡‘Ã—å€ç‡</b> ãŒæˆ»ã‚‹<br>
Â Â Â Â ãƒ»ã‚ªãƒƒã‚ºæ¡ä»¶ï¼š<b>1äººæ°—â‰¤3.0</b> / <b>10äººæ°—â‰¥150</b>
Â Â </div>
</div>

<div class="box" id="playersBox"></div>
<div class="box" id="infoBox"></div>
<div class="box" id="oddsBox"></div>

<div class="box">
Â Â <h3 style="margin:0 0 8px">ğŸŸï¸ è³­ã‘</h3>
Â Â <div id="betBox"></div>
Â Â <div id="lockedBox" class="muted"></div>
</div>

<div class="box">
Â Â <h3 style="margin:0 0 8px">ğŸ ãƒ¬ãƒ¼ã‚¹</h3>
Â Â <div id="race"></div>
</div>

<div class="box" id="historyBox"></div>
<pre id="log">ã€Œå‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã‚’ä½œã‚‹ã€ã‚’æŠ¼ã—ã¦ã­ã€‚</pre>

<script>
/* ===== è¨­å®š ===== */
const N=10;
const TARGET_SECONDS=15;Â Â Â Â Â // ã ã„ãŸã„15ç§’
const MIN_BET=100;
const STEP=100;
const KEY="keiba_css_run_v1";
const HISTORY_KEEP=10;

/* ===== util ===== */
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const rand=n=>Math.floor(Math.random()*n);
const yen=n=>Math.floor(n);
const nowStr=()=>new Date().toLocaleString();

/* ===== ä¿å­˜ï¼ˆæ‰€æŒé‡‘ + å±¥æ­´ï¼‰ ===== */
let state={
Â Â players:[{name:"P1",money:1500,dead:false},{name:"P2",money:1500,dead:false},{name:"P3",money:1500,dead:false}],
Â Â history:[]
};
try{
Â Â const raw=localStorage.getItem(KEY);
Â Â if(raw){
Â Â Â Â const d=JSON.parse(raw);
Â Â Â Â if(d?.players) state.players=d.players;
Â Â Â Â if(d?.history) state.history=d.history;
Â Â }
}catch(e){}
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }

/* ===== é¦¬åç”Ÿæˆ ===== */
const syll=["ã‚µãƒ³","ãƒ©ã‚¤","ãƒ–ãƒ¬","ãƒ•ã‚¡","ãƒ‰","ãƒ«","ã‚«","ã‚°","ãƒŠ","ãƒˆ","ã‚­","ãƒ©","ã‚¹","ã‚»ã‚¤","ãƒ¦ã‚¦","ã‚ªã‚¦","ã‚·ãƒ³","ãƒãƒ«","ãƒ†ãƒ„","ãƒ’ãƒ¡","ãƒŸãƒ¤","ã‚¢ã‚­","ãƒ›ã‚·","ã‚«ã‚¼","ãƒ„ã‚­","ãƒ¦ãƒ¡"];
function genName(){ let s=""; const parts=2+rand(2); for(let i=0;i<parts;i++) s+=syll[rand(syll.length)]; return s; }
function uniqueNames(n){ const set=new Set(); while(set.size<n) set.add(genName()); return [...set]; }

/* ===== UI ===== */
function drawPlayers(){
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ’° æ‰€æŒé‡‘</h3>`;
Â Â state.players.forEach(p=>{
Â Â Â Â const tag=(p.money<=0||p.dead)?`<span class="tag bad">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</span>`:`<span class="tag ok">å‚åŠ ä¸­</span>`;
Â Â Â Â html+=`<div>${p.name}ï¼š<b>${p.money}</b>å†† ${tag}</div>`;
Â Â });
Â Â document.getElementById("playersBox").innerHTML=html;
}
function renderHistory(){
Â Â const h=state.history.slice(-HISTORY_KEEP).reverse();
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ§¾ å±¥æ­´</h3>`;
Â Â if(!h.length){ html+=`<div class="muted">ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`; document.getElementById("historyBox").innerHTML=html; return; }
Â Â html+=`<table class="table"><thead><tr><th>æ—¥æ™‚</th><th>1ç€</th><th>2ç€</th><th>3ç€</th></tr></thead><tbody>`;
Â Â h.forEach(r=>{ html+=`<tr><td>${r.when}</td><td>${r.top3[0]}</td><td>${r.top3[1]}</td><td>${r.top3[2]}</td></tr>`; });
Â Â html+=`</tbody></table>`;
Â Â document.getElementById("historyBox").innerHTML=html;
}
drawPlayers(); renderHistory();

/* ===== ç¾åœ¨ãƒ¬ãƒ¼ã‚¹ ===== */
let horses=[];
let dist=1600;
let cardReady=false, bettingClosed=false;
let lockedBets=[];
let finishPlan=[]; // ç§’ï¼ˆçŸ­ã„ã»ã©é€Ÿã„ï¼‰
let raceTimer=null;

/* ===== ã‚ªãƒƒã‚ºï¼ˆæ¡ä»¶ç¶­æŒï¼‰ ===== */
function makeOdds(hs){
Â Â const scores=hs.map(h=>Math.log(h.power)+(Math.random()*2-1)*0.22);
Â Â const order=[...hs.keys()].sort((a,b)=>scores[b]-scores[a]);

Â Â const FAV_MAX=3.0;
Â Â const LAST_MIN=150.0;

Â Â const last=LAST_MIN+Math.random()*70; // 150ã€œ220
Â Â const fav =2.0+Math.random()*1.0;Â Â Â Â Â // 2.0ã€œ3.0
Â Â const mid =26 +Math.random()*28;Â Â Â Â Â Â // 26ã€œ54

Â Â const pow=1.22;
Â Â const jitter=()=>Math.exp((Math.random()*2-1)*0.10);

Â Â let byRank=new Array(10).fill(0);
Â Â for(let r=0;r<10;r++){
Â Â Â Â const t=r/9;
Â Â Â Â const a=Math.pow(mid/fav, Math.pow(t,pow));
Â Â Â Â const b=Math.pow(last/mid, Math.pow(t,pow+0.22));
Â Â Â Â let odd=fav*a*b*jitter();
Â Â Â Â if(r===0) odd=Math.min(FAV_MAX, odd);
Â Â Â Â if(r===9) odd=Math.max(LAST_MIN, odd);
Â Â Â Â byRank[r]=odd;
Â Â }
Â Â for(let r=1;r<10;r++){
Â Â Â Â const minGap=(r<=2)?0.2:(r<=5)?1.5:(r<=7)?4.0:6.0;
Â Â Â Â byRank[r]=Math.max(byRank[r], byRank[r-1]+minGap);
Â Â }
Â Â byRank[0]=Math.min(FAV_MAX, byRank[0]);
Â Â byRank[9]=Math.max(LAST_MIN, byRank[9]);

Â Â order.forEach((hid,rpos)=> hs[hid].winOdd=Number(clamp(byRank[rpos],1.1,999.9).toFixed(1)));

Â Â const pop=[...hs].sort((a,b)=>a.winOdd-b.winOdd);
Â Â const rmap=new Map(); pop.forEach((h,i)=>rmap.set(h.id,i+1));
Â Â hs.forEach(h=>{
Â Â Â Â const r=rmap.get(h.id);
Â Â Â Â let po=1+(h.winOdd-1)*(0.26+Math.random()*0.10);
Â Â Â Â po*=(0.95+(r-1)*0.02);
Â Â Â Â po*=(0.95+Math.random()*0.08);
Â Â Â Â h.placeOdd=Number(clamp(po,1.1,35).toFixed(2));
Â Â });
}

/* ===== ã‚ªãƒƒã‚ºè¡¨ ===== */
function renderOdds(){
Â Â const sorted=[...horses].sort((a,b)=>a.winOdd-b.winOdd);
Â Â let html=`<h3 style="margin:0 0 8px">ğŸ“Š ã‚ªãƒƒã‚ºï¼ˆäººæ°—é †ï¼‰</h3>
Â Â Â Â <table class="table"><thead><tr>
Â Â Â Â Â Â <th>äººæ°—</th><th>é¦¬ç•ª</th><th>é¦¬å</th><th class="right">å˜å‹</th><th class="right">è¤‡å‹</th>
Â Â Â Â </tr></thead><tbody>`;
Â Â sorted.forEach((h,i)=>{
Â Â Â Â html+=`<tr><td>${i+1}</td><td>${h.id+1}</td><td>${h.name}</td>
Â Â Â Â Â Â <td class="right"><b>${h.winOdd}</b>å€</td><td class="right"><b>${h.placeOdd}</b>å€</td></tr>`;
Â Â });
Â Â html+=`</tbody></table>`;
Â Â document.getElementById("oddsBox").innerHTML=html;
}

/* ===== è³­ã‘ ===== */
function minBetFor(m){ if(m<=0) return 0; return (m>=MIN_BET)?MIN_BET:m; }
function normalizeBet(m,v){
Â Â if(m<=0) return 0;
Â Â let x=Number(v); if(!Number.isFinite(x)||x<0) x=0;
Â Â const step=(m>=MIN_BET)?STEP:1;
Â Â x=Math.floor(x/step)*step;
Â Â if(x>m) x=m;
Â Â if(m>=MIN_BET){
Â Â Â Â if(x>0 && x<MIN_BET) x=MIN_BET;
Â Â Â Â if(x>m) x=0;
Â Â }else{
Â Â Â Â if(x>0 && x<m) x=m;
Â Â }
Â Â return x;
}
function distinctDefaults(){
Â Â const used=new Set();
Â Â const pick=()=>{ let h=rand(N),g=0; while(used.has(h)&&g<50){h=rand(N);g++;} used.add(h); return h; };
Â Â return [
Â Â Â Â {horse:pick(), type:Math.random()<0.5?"win":"place"},
Â Â Â Â {horse:pick(), type:Math.random()<0.5?"win":"place"},
Â Â Â Â {horse:pick(), type:Math.random()<0.5?"win":"place"},
Â Â ];
}
function horseOptions(){
Â Â return horses.map(h=>`<option value="${h.id}">${h.id+1} ${h.name}ï¼ˆå˜${h.winOdd}/è¤‡${h.placeOdd}ï¼‰</option>`).join("");
}
function renderBets(){
Â Â const opts=horseOptions();
Â Â const defs=distinctDefaults();
Â Â let html="";
Â Â state.players.forEach((p,pi)=>{
Â Â Â Â const dead=(p.money<=0||p.dead);
Â Â Â Â const disabled=(bettingClosed||dead)?"disabled":"";
Â Â Â Â const tag=bettingClosed?`<span class="tag bad">ç· åˆ‡</span>`:(dead?`<span class="tag bad">GO</span>`:`<span class="tag ok">å—ä»˜</span>`);
Â Â Â Â const defAmt=minBetFor(p.money);

Â Â Â Â html+=`<div class="box" style="margin:8px 0">
Â Â Â Â Â Â <div><b>${p.name}</b>ï¼ˆæ‰€æŒé‡‘ï¼š${p.money}å††ï¼‰ ${tag}</div>
Â Â Â Â Â Â <div class="row" style="margin-top:6px">
Â Â Â Â Â Â Â Â <label>åˆ¸ç¨®
Â Â Â Â Â Â Â Â Â Â <select id="type${pi}" ${disabled}>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="win"${defs[pi].type==="win"?" selected":""}>å˜å‹</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="place"${defs[pi].type==="place"?" selected":""}>è¤‡å‹</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é¦¬
Â Â Â Â Â Â Â Â Â Â <select id="horse${pi}" ${disabled}>${opts}</select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â Â Â <label>é‡‘é¡
Â Â Â Â Â Â Â Â Â Â <input id="amt${pi}" ${disabled} type="number" inputmode="numeric"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â min="0" step="${p.money>=MIN_BET?STEP:1}" value="${defAmt}">
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div id="warn${pi}" class="muted" style="margin-top:4px"></div>
Â Â Â Â </div>`;
Â Â });
Â Â document.getElementById("betBox").innerHTML=html;

Â Â state.players.forEach((p,pi)=>{
Â Â Â Â const sel=document.getElementById("horse"+pi);
Â Â Â Â if(sel) sel.value=String(defs[pi].horse);
Â Â Â Â validateBet(pi);
Â Â Â Â const amt=document.getElementById("amt"+pi);
Â Â Â Â if(amt) amt.oninput=()=>validateBet(pi);
Â Â });
}
function validateBet(pi){
Â Â const p=state.players[pi];
Â Â const warn=document.getElementById("warn"+pi);
Â Â const amt=document.getElementById("amt"+pi);
Â Â if(!p||!warn||!amt) return;
Â Â if(p.money<=0||p.dead){ warn.textContent="ã“ã®äººã¯ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚"; return; }
Â Â let v=normalizeBet(p.money, amt.value);
Â Â if(v<=0){ v=minBetFor(p.money); warn.textContent=`è‡ªå‹•ã§ ${v}å†† ã«ã—ã¾ã—ãŸï¼ˆè³­ã‘å¿…é ˆï¼‰`; }
Â Â else warn.textContent="";
Â Â amt.value=v;
}
function renderLocked(){
Â Â const box=document.getElementById("lockedBox");
Â Â if(!lockedBets.length){ box.innerHTML=bettingClosed?`<span class="tag bad">è³­ã‘ãªã—</span>`:""; return; }
Â Â box.innerHTML = `<span class="tag">ğŸ”’ ãƒ­ãƒƒã‚¯æ¸ˆã¿</span><div style="margin-top:6px">${
Â Â Â Â lockedBets.map(b=>`${state.players[b.pi].name}ï¼š${b.type==="win"?"å˜å‹":"è¤‡å‹"} ${b.horseLabel} ${b.stake}å††ï¼ˆ${b.odd}å€ï¼‰`).join("<br>")
Â Â }</div>`;
}

/* ===== ãƒ¬ãƒ¼ã‚¹UI ===== */
function renderRaceLanes(){
Â Â let html="";
Â Â horses.forEach(h=>{
Â Â Â Â html+=`
Â Â Â Â Â Â <div class="laneBox">
Â Â Â Â Â Â Â Â <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;line-height:1.1">
Â Â Â Â Â Â Â Â Â Â <div><b>${h.id+1} ${h.name}</b></div>
Â Â Â Â Â Â Â Â Â Â <div style="white-space:nowrap">
Â Â Â Â Â Â Â Â Â Â Â Â <span class="tag">å˜${h.winOdd}</span><span class="tag">è¤‡${h.placeOdd}</span>
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>

Â Â Â Â Â Â Â Â <div id="track${h.id}" class="track">
Â Â Â Â Â Â Â Â Â Â <div class="finish"></div>
Â Â Â Â Â Â Â Â Â Â <div id="runner${h.id}" class="runner">
Â Â Â Â Â Â Â Â Â Â Â Â <div class="label">${h.id+1} ${h.name}</div>
Â Â Â Â Â Â Â Â Â Â Â Â <div class="horseWrap"><div class="horseIcon">ğŸ</div></div>
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>`;
Â Â });
Â Â document.getElementById("race").innerHTML=html;

Â Â // åˆæœŸä½ç½®ã«æˆ»ã™
Â Â for(let i=0;i<N;i++){
Â Â Â Â const r=document.getElementById("runner"+i);
Â Â Â Â if(r){ r.style.animation="none"; r.style.left="0%"; }
Â Â }
}

/* ===== å‡ºèµ°è¡¨ä½œæˆ ===== */
function makeCard(){
Â Â stopRace();

Â Â const names=uniqueNames(N);
Â Â horses = Array.from({length:N},(_,i)=>({
Â Â Â Â id:i,
Â Â Â Â name:names[i],
Â Â Â Â power:1.2+Math.random()*8.5,
Â Â Â Â winOdd:0, placeOdd:0
Â Â }));
Â Â makeOdds(horses);

Â Â dist=1000+rand(1400);
Â Â document.getElementById("infoBox").innerHTML =
Â Â Â Â `<h3 style="margin:0 0 8px">ğŸ“Œ ãƒ¬ãƒ¼ã‚¹æ¡ä»¶</h3>è·é›¢ï¼š<b>${dist}m</b> <span class="tag">ç´„${TARGET_SECONDS}ç§’</span>`;

Â Â // é€Ÿã•ï¼ˆçŸ­ã„ã»ã©é€Ÿã„ï¼‰
Â Â const scores=horses.map(h=>Math.log(h.power));
Â Â const minS=Math.min(...scores), maxS=Math.max(...scores);
Â Â const norm=s=>(maxS===minS)?0.5:(s-minS)/(maxS-minS);

Â Â const chaos = Math.random()<0.03; // ã”ãç¨€ã«å¤§è’ã‚Œ
Â Â finishPlan = horses.map(h=>{
Â Â Â Â const t=norm(Math.log(h.power));
Â Â Â Â let sec = TARGET_SECONDS*(1.08 - t*0.16) + (Math.random()*2-1)*0.8;
Â Â Â Â if(chaos && Math.random()<0.30) sec -= 1.0*(1-t);
Â Â Â Â return clamp(sec, TARGET_SECONDS*0.90, TARGET_SECONDS*1.10);
Â Â });

Â Â cardReady=true;
Â Â bettingClosed=false;
Â Â lockedBets=[];

Â Â document.getElementById("btnStart").disabled=false;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
Â Â document.getElementById("log").textContent="è³­ã‘ã¦ã‹ã‚‰ã€Œãƒ¬ãƒ¼ã‚¹é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ã­ã€‚";

Â Â renderOdds();
Â Â renderBets();
Â Â renderLocked();
Â Â renderRaceLanes();
}

/* ===== ãƒ­ãƒƒã‚¯ï¼†é–‹å§‹æ™‚ã«è³­ã‘é‡‘ã‚’å¼•ã ===== */
function lockBetsAndDeduct(){
Â Â lockedBets=[];
Â Â state.players.forEach((p,pi)=>{
Â Â Â Â if(p.money<=0||p.dead) return;
Â Â Â Â const type=document.getElementById("type"+pi)?.value ?? "win";
Â Â Â Â const horseId=Number(document.getElementById("horse"+pi)?.value);
Â Â Â Â const amtIn=document.getElementById("amt"+pi)?.value ?? "0";
Â Â Â Â if(!Number.isFinite(horseId)||horseId<0||horseId>=N) return;

Â Â Â Â let stake=normalizeBet(p.money, amtIn);
Â Â Â Â if(stake<=0) stake=minBetFor(p.money);
Â Â Â Â stake=Math.min(stake, p.money);
Â Â Â Â if(stake<=0) return;

Â Â Â Â p.money -= stake; // é–‹å§‹æ™‚ã«å¼•ã
Â Â Â Â const h=horses[horseId];
Â Â Â Â const odd=(type==="win")?h.winOdd:h.placeOdd;

Â Â Â Â lockedBets.push({pi,type,horseId,stake,odd,horseLabel:`${horseId+1} ${h.name}`});
Â Â });

Â Â state.players.forEach((_,pi)=>{
Â Â Â Â ["type","horse","amt"].forEach(prefix=>{
Â Â Â Â Â Â const el=document.getElementById(prefix+pi);
Â Â Â Â Â Â if(el) el.disabled=true;
Â Â Â Â });
Â Â });

Â Â drawPlayers();
Â Â save();
}

/* ===== ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆCSSã§ç¢ºå®Ÿã«å‹•ã‹ã™ï¼‰ ===== */
function startRace(){
Â Â if(!cardReady||!horses.length) return;

Â Â bettingClosed=true;
Â Â state.players.forEach((_,pi)=>validateBet(pi));
Â Â lockBetsAndDeduct();

Â Â if(!lockedBets.length){
Â Â Â Â document.getElementById("log").textContent="è³­ã‘ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
Â Â Â Â bettingClosed=false;
Â Â Â Â return;
Â Â }

Â Â renderLocked();
Â Â document.getElementById("btnCard").disabled=true;
Â Â document.getElementById("btnStart").disabled=true;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹ä¸­â€¦";
Â Â document.getElementById("log").textContent="ãƒ¬ãƒ¼ã‚¹ä¸­â€¦ï¼ˆå·¦â†’å³ã¸èµ°ã‚Šã¾ã™ï¼‰";

Â Â // â˜…ã“ã“ã§ã€Œç¢ºå®Ÿã«èµ°ã‚‹ã€
Â Â for(let i=0;i<N;i++){
Â Â Â Â const r=document.getElementById("runner"+i);
Â Â Â Â if(!r) continue;
Â Â Â Â r.style.animation="none";Â Â Â Â Â Â Â // ã„ã£ãŸã‚“æ¶ˆã™
Â Â Â Â r.style.left="0%";
Â Â Â Â // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¢ãƒ‹ãƒ¡é–‹å§‹ï¼ˆç¢ºå®Ÿã«ç™ºç«ï¼‰
Â Â Â Â requestAnimationFrame(()=>{
Â Â Â Â Â Â r.style.animation = `runLR ${finishPlan[i].toFixed(2)}s linear forwards`;
Â Â Â Â });
Â Â }

Â Â // æœ€å¤§æ™‚é–“ã§çµæœç™ºè¡¨
Â Â const maxSec = Math.max(...finishPlan) + 0.2;
Â Â raceTimer=setTimeout(finishRace, maxSec*1000);
}

/* ===== çµ‚äº†ï¼†ç²¾ç®— ===== */
function finishRace(){
Â Â stopRace();

Â Â // finishPlan ãŒçŸ­ã„é † = ç€é †
Â Â const order=[...horses].sort((a,b)=>finishPlan[a.id]-finishPlan[b.id]);
Â Â const first=order[0], second=order[1], third=order[2];
Â Â const top3=new Set([first.id, second.id, third.id]);

Â Â let out="ğŸ çµæœ\n";
Â Â order.forEach((h,i)=>out+=`${i+1}ç€ï¼š${h.id+1} ${h.name}\n`);
Â Â out += `\nã€ç²¾ç®—ã€‘é–‹å§‹æ™‚ã«è³­ã‘é‡‘ã‚’å¼•ã„ã¦ã„ã¾ã™ã€‚çš„ä¸­ã—ãŸã‚‰ (è³­ã‘é‡‘Ã—å€ç‡) ãŒæˆ»ã‚Šã¾ã™ã€‚\n`;

Â Â for(const b of lockedBets){
Â Â Â Â const p=state.players[b.pi];
Â Â Â Â if(!p||p.dead) continue;

Â Â Â Â const hit=(b.type==="win") ? (b.horseId===first.id) : top3.has(b.horseId);

Â Â Â Â if(hit){
Â Â Â Â Â Â const payout=yen(b.stake*b.odd);
Â Â Â Â Â Â p.money += payout;
Â Â Â Â Â Â out += `ãƒ»${p.name}ï¼š${b.type==="win"?"å˜å‹":"è¤‡å‹"} ${b.horseLabel} ${b.stake}å†† â†’ çš„ä¸­ æ‰•æˆ»${payout}å††\n`;
Â Â Â Â }else{
Â Â Â Â Â Â out += `ãƒ»${p.name}ï¼š${b.type==="win"?"å˜å‹":"è¤‡å‹"} ${b.horseLabel} ${b.stake}å†† â†’ ãƒã‚ºãƒ¬\n`;
Â Â Â Â }

Â Â Â Â if(p.money<=0){
Â Â Â Â Â Â p.money=0; p.dead=true;
Â Â Â Â Â Â out += `Â Â â†’ ${p.name} ã¯ 0å††ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼\n`;
Â Â Â Â }
Â Â }

Â Â state.history.push({
Â Â Â Â when: nowStr(),
Â Â Â Â top3: [`${first.id+1} ${first.name}`,`${second.id+1} ${second.name}`,`${third.id+1} ${third.name}`]
Â Â });
Â Â if(state.history.length>60) state.history=state.history.slice(-60);

Â Â document.getElementById("log").textContent=out;
Â Â drawPlayers();
Â Â renderHistory();
Â Â save();

Â Â cardReady=false;
Â Â bettingClosed=false;
Â Â lockedBets=[];

Â Â document.getElementById("btnCard").disabled=false;
Â Â document.getElementById("btnStart").disabled=true;
Â Â document.getElementById("btnStart").textContent="ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ˆç· åˆ‡ï¼‰";
}

/* ===== stop/reset ===== */
function stopRace(){
Â Â if(raceTimer){ clearTimeout(raceTimer); raceTimer=null; }
}
function resetAll(){
Â Â stopRace();
Â Â try{ localStorage.removeItem(KEY); }catch(e){}
Â Â location.reload();
}
</script>
</body>
</html>
