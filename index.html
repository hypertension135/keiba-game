<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆå…¨éƒ¨å…¥ã‚Šï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;background:#f5f5f5;color:#111;margin:0;padding:12px}
  h2{background:#0b8f3c;color:#fff;padding:10px;border-radius:8px;margin:0 0 10px}
  .box{background:#fff;border:1px solid #d0d0d0;border-radius:10px;padding:10px;margin:10px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{padding:10px 12px;border:0;border-radius:10px;background:#0b8f3c;color:#fff;font-weight:700}
  button.secondary{background:#333}
  button:disabled{opacity:.5}
  select,input{padding:8px;border-radius:8px;border:1px solid #ccc}
  .muted{color:#666;font-size:13px}

  /* æ è‰² */
  .num{display:inline-block;min-width:26px;text-align:center;color:#fff;border-radius:6px;font-weight:800;padding:2px 0;margin-right:6px;font-size:13px}
  .w1{background:#fff;color:#111;border:1px solid #111}
  .w2{background:#111}
  .w3{background:#d40000}
  .w4{background:#0047ff}
  .w5{background:#ffd400;color:#111}
  .w6{background:#0b8f3c}
  .w7{background:#ff8a00}
  .w8{background:#ff5fb7;color:#111}

  /* ã‚ªãƒƒã‚ºè¡¨ */
  .table{width:100%;border-collapse:collapse;font-size:14px}
  .table th,.table td{border-bottom:1px solid #e6e6e6;padding:8px 6px;text-align:left}
  .table th{background:#f2f2f2}
  .right{text-align:right}
  .badge{display:inline-block;background:#eef6ff;border:1px solid #cfe6ff;color:#0a4a8a;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}

  /* ãƒˆãƒ©ãƒƒã‚¯ */
  .trackRow{display:grid;grid-template-columns: 1fr;gap:8px}
  .horseLine{background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px}
  .track{position:relative;height:24px;background:#111;border-radius:10px;overflow:hidden;margin-top:6px}
  .finishLine{position:absolute;right:10px;top:0;width:3px;height:100%;background:#fff;opacity:.7}
  .horseIcon{position:absolute;left:0%;top:2px;font-size:18px;transition:left .10s linear;user-select:none}
  .lane{position:absolute;left:0;top:50%;width:100%;height:1px;background:#2b2b2b}

  pre{white-space:pre-wrap;background:#111;color:#eaeaea;border-radius:10px;padding:10px;overflow:auto}
</style>
</head>
<body>

<h2>ğŸ‡ ç«¶é¦¬ã‚²ãƒ¼ãƒ ï¼ˆå…¨éƒ¨å…¥ã‚Šï¼‰</h2>

<div class="box" id="players"></div>

<div class="box">
  <div class="row">
    <button id="btnCard" onclick="makeRaceCard()">å‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã‚’ä½œã‚‹</button>
    <button id="btnStart" class="secondary" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹</button>
    <button class="secondary" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <div class="muted">ã¾ãšã€Œå‡ºèµ°è¡¨ã€ã‚’ä½œã‚‹ â†’ ã‚ªãƒƒã‚ºã‚’è¦‹ã¦è³­ã‘ã‚‹ â†’ ãƒ¬ãƒ¼ã‚¹é–‹å§‹ã€‚</div>
</div>

<div class="box" id="raceInfo"></div>
<div class="box" id="oddsTable"></div>

<div class="box">
  <h3 style="margin:0 0 8px">ğŸŸï¸ è³­ã‘ï¼ˆ3äººå¯¾æˆ¦ï¼‰</h3>
  <div id="betUI"></div>
  <div class="muted">æœ€ä½100å††ã€‚0å††ã«ãªã£ãŸã‚‰ãã®äººã¯å®Ÿè³ªè² ã‘ï¼ˆè³­ã‘ã‚‰ã‚Œãªã„ï¼‰ã€‚</div>
</div>

<div class="box">
  <h3 style="margin:0 0 8px">ğŸ ãƒ¬ãƒ¼ã‚¹</h3>
  <div id="race" class="trackRow"></div>
</div>

<pre id="result"></pre>

<script>
/* =========================
   ãƒ‡ãƒ¼ã‚¿ & ä¿å­˜
========================= */
const KEY = "keiba_allin_v1";
const rand = n => Math.floor(Math.random()*n);

const styles = ["é€ƒã’","å…ˆè¡Œ","å·®ã—","è¿½è¾¼"];
const syll = ["ã‚µãƒ³","ãƒ©ã‚¤","ãƒ–ãƒ¬","ãƒ•ã‚¡","ãƒ‰","ãƒ«","ã‚«","ã‚°","ãƒ´","ãƒŠ","ãƒˆ","ã‚­","ãƒ©","ã‚¹"];
const randName = () => syll[rand(syll.length)] + syll[rand(syll.length)] + syll[rand(syll.length)];

let players = [
  {name:"P1", money:1500},
  {name:"P2", money:1500},
  {name:"P3", money:1500}
];

let jockeys = [];
for (let i=0;i<60;i++){
  jockeys.push({
    name:`J${i+1}é¨æ‰‹`,
    skill:Math.random()*0.4+0.8,   // åŸºæœ¬èƒ½åŠ›
    finish:Math.random()*0.4+0.8,  // ç›´ç·š
    chaos:Math.random()*0.6+0.7    // å¤§è’ã‚Œè€æ€§
  });
}

let horsePool = [];
for (let i=0;i<300;i++){
  horsePool.push({
    name: randName(),
    style: styles[rand(4)],
    power: Math.random()*3+2,
    wins: 0,
    streak: 0
  });
}

let history = [];

function save(){
  localStorage.setItem(KEY, JSON.stringify({players, horsePool, history}));
}
function load(){
  const raw = localStorage.getItem(KEY);
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    if(d?.players) players = d.players;
    if(d?.horsePool) horsePool = d.horsePool;
    if(d?.history) history = d.history;
  }catch(e){}
}
load();

/* =========================
   ç”»é¢æç”»
========================= */
function drawPlayers(){
  let html = `<h3 style="margin:0 0 8px">ğŸ’° æ‰€æŒé‡‘</h3>`;
  players.forEach(p=>{
    const danger = p.money<=0 ? " <span class='badge'>0å††</span>" : "";
    html += `<div>${p.name}ï¼š<b>${p.money}</b>å††${danger}</div>`;
  });
  if(history.length){
    html += `<div class="muted" style="margin-top:8px">ç›´è¿‘ãƒ¬ãƒ¼ã‚¹ï¼š${history.slice(0,3).map(h=>h.join(" / ")).join(" ï½œ ")}</div>`;
  }
  document.getElementById("players").innerHTML = html;
}
drawPlayers();

/* =========================
   ãƒ¬ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ï¼ˆã‚ªãƒƒã‚ºå…ˆï¼‰
========================= */
let horses = [];     // å‡ºèµ°10é ­ï¼ˆã“ã®ãƒ¬ãƒ¼ã‚¹ï¼‰
let order = [];      // ç€é †
let chaos = false;   // å¤§è’ã‚Œ
let pace = "ãƒŸãƒ‰ãƒ«";
let distance = 1600;
let cardReady = false;

function frameClass(i){ return "w"+((i%8)+1); }

function computeOdd(h){
  // é€£å‹ã§å¼·ããªã‚‹ï¼ˆå°‘ã—ã ã‘ï¼‰
  const streakBoost = 1 + (h.streak||0)*0.05;
  const perf = h.power * streakBoost;

  // é€£å‹ã§äººæ°—ã«ãªã‚‹ â†’ ã‚ªãƒƒã‚ºã¯ä¸‹ãŒã‚‹ï¼ˆ=å½“ãŸã‚Šã¥ã‚‰ã„é…å½“ï¼‰
  const pop = 1 / (1 + (h.streak||0)*0.25);

  const base = (16 / perf);
  const jockeyFactor = (2.05 - h.jockey.skill); // ä¸Šæ‰‹ã„é¨æ‰‹ã»ã©ã‚ªãƒƒã‚ºä¸‹ã’
  let odd = base * jockeyFactor * pop;

  // ä¸‹é™/ä¸Šé™
  odd = Math.max(1.1, Math.min(99.9, odd));
  return Number(odd.toFixed(1));
}

function makeRaceCard(){
  // 10é ­æŠ½é¸
  horses = horsePool.slice().sort(()=>Math.random()-0.5).slice(0,10);
  horses.forEach((h,i)=>{
    h.id = i;
    h.pos = 0;
    h.fin = false;
    h.jockey = jockeys[rand(jockeys.length)];
    h.condition = Math.random()*0.6+0.7;
    h.odd = computeOdd(h);
  });

  chaos = Math.random()<0.03; // ã”ãç¨€ã«å¤§è’ã‚Œ
  pace = ["ã‚¹ãƒ­ãƒ¼","ãƒŸãƒ‰ãƒ«","ãƒã‚¤"][rand(3)];
  distance = rand(1400)+1000; // 1000ã€œ2399m

  renderRaceInfo();
  renderOddsTable();
  renderBetUI();      // ã‚ªãƒƒã‚ºãŒå‡ºãŸå¾Œã«è³­ã‘UIã‚’æ•´ãˆã‚‹
  renderRaceLanes();  // èµ°ã‚‹ãƒ¬ãƒ¼ãƒ³ï¼ˆã¾ã å‹•ã‹ãªã„ï¼‰
  document.getElementById("btnStart").disabled = false;
  cardReady = true;

  save();
}

function renderRaceInfo(){
  document.getElementById("raceInfo").innerHTML =
    `<h3 style="margin:0 0 8px">ğŸ“Œ ãƒ¬ãƒ¼ã‚¹æ¡ä»¶</h3>
     è·é›¢ï¼š<b>${distance}m</b> ï¼ ãƒšãƒ¼ã‚¹ï¼š<b>${pace}</b>
     ${chaos ? "<span class='badge'>âš ï¸ å¤§è’ã‚Œï¼ˆã”ãç¨€ï¼‰</span>" : ""}`;
}

function renderOddsTable(){
  const sorted = [...horses].sort((a,b)=>a.odd-b.odd);
  let html = `<h3 style="margin:0 0 8px">ğŸ“Š ã‚ªãƒƒã‚ºè¡¨ï¼ˆäººæ°—é †ï¼‰</h3>
  <table class="table">
    <thead>
      <tr>
        <th>äººæ°—</th><th>é¦¬</th><th>é¦¬å</th><th>è„šè³ª</th><th>é¨æ‰‹</th><th class="right">å˜å‹</th>
      </tr>
    </thead><tbody>`;

  sorted.forEach((h,i)=>{
    html += `<tr>
      <td>${i+1}</td>
      <td><span class="num ${frameClass(h.id)}">${h.id+1}</span></td>
      <td>${h.name}</td>
      <td>${h.style}</td>
      <td>${h.jockey.name}</td>
      <td class="right"><b>${h.odd}</b>å€</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById("oddsTable").innerHTML = html;
}

function renderRaceLanes(){
  let html = "";
  horses.forEach(h=>{
    html += `<div class="horseLine">
      <div>
        <span class="num ${frameClass(h.id)}">${h.id+1}</span>
        <b>${h.name}</b>ï¼ˆ${h.style}ï¼‰ é¨æ‰‹:${h.jockey.name} <span class="badge">${h.odd}å€</span>
      </div>
      <div class="track">
        <div class="lane"></div>
        <div class="finishLine"></div>
        <span id="horse${h.id}" class="horseIcon">ğŸ</span>
      </div>
    </div>`;
  });
  document.getElementById("race").innerHTML = html;
}

/* =========================
   è³­ã‘UIï¼ˆå˜å‹/ä¸‰é€£è¤‡/ä¸‰é€£å˜ï¼‰
========================= */
function buildHorseOptions(){
  return horses.map(h=>`<option value="${h.id}">${h.id+1} ${h.name}ï¼ˆ${h.odd}å€ï¼‰</option>`).join("");
}

function renderBetUI(){
  if(!horses.length){
    document.getElementById("betUI").innerHTML = `<div class="muted">å…ˆã«ã€Œå‡ºèµ°è¡¨ï¼ˆã‚ªãƒƒã‚ºï¼‰ã€ã‚’ä½œã£ã¦ã­ã€‚</div>`;
    return;
  }
  const opts = buildHorseOptions();
  let html = "";

  players.forEach((p,pi)=>{
    html += `<div class="box" style="margin:10px 0">
      <div><b>${p.name}</b>ï¼ˆæ‰€æŒé‡‘ï¼š${p.money}å††ï¼‰</div>
      <div class="row" style="margin-top:6px">
        <label>åˆ¸ç¨®
          <select id="type${pi}" onchange="syncLegs(${pi})">
            <option value="win">å˜å‹</option>
            <option value="trio">ä¸‰é€£è¤‡</option>
            <option value="trifecta">ä¸‰é€£å˜</option>
          </select>
        </label>

        <label>é‡‘é¡
          <input id="amt${pi}" type="number" min="100" step="100" value="100" />
        </label>
      </div>

      <div class="row" style="margin-top:6px" id="legs${pi}">
        <label>é¦¬
          <select id="leg${pi}_0">${opts}</select>
        </label>
      </div>
      <div class="muted">â€» 0å††ã®äººã¯è³­ã‘ã¦ã‚‚æ„å‘³ãŒãªã„ã‚ˆã€‚</div>
    </div>`;
  });

  document.getElementById("betUI").innerHTML = html;
  players.forEach((_,pi)=>syncLegs(pi));
}

function syncLegs(pi){
  const type = document.getElementById(`type${pi}`)?.value || "win";
  const opts = buildHorseOptions();
  let html = "";

  if(type==="win"){
    html = `<label>é¦¬
      <select id="leg${pi}_0">${opts}</select>
    </label>`;
  }else if(type==="trio"){
    html = `<label>1é ­ç›® <select id="leg${pi}_0">${opts}</select></label>
            <label>2é ­ç›® <select id="leg${pi}_1">${opts}</select></label>
            <label>3é ­ç›® <select id="leg${pi}_2">${opts}</select></label>`;
  }else{
    html = `<label>1ç€ <select id="leg${pi}_0">${opts}</select></label>
            <label>2ç€ <select id="leg${pi}_1">${opts}</select></label>
            <label>3ç€ <select id="leg${pi}_2">${opts}</select></label>`;
  }

  document.getElementById(`legs${pi}`).innerHTML = html;
}

/* =========================
   ãƒ¬ãƒ¼ã‚¹èµ°è¡Œãƒ­ã‚¸ãƒƒã‚¯
========================= */
function step(){
  horses.forEach(h=>{
    if(h.fin) return;

    // ãƒ™ãƒ¼ã‚¹é€Ÿåº¦
    let s = Math.random()*6 + (h.power*0.65);
    // é€£å‹ã§å°‘ã—å¼·ããªã‚‹
    s *= (1
}
</script>
</body>
</html>
