<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç«¶é¦¬ã‚²ãƒ¼ãƒ </title>

<style>
body{
  font-family:sans-serif;
  background:#f5f5f5;
  color:#111;
}
h2{
  background:#0b8f3c;
  color:white;
  padding:8px;
}
.box{
  background:white;
  border:1px solid #ccc;
  border-radius:6px;
  padding:6px;
  margin:6px;
}
.bar{
  height:14px;
  background:linear-gradient(to right,#4caf50,#8bc34a);
  border-radius:4px;
}
.pop{
  display:flex;
  gap:6px;
  padding:4px;
  border-bottom:1px dotted #ccc;
  font-size:14px;
}
.rank{width:70px}
.num{
  width:24px;
  text-align:center;
  color:white;
  border-radius:3px;
  font-weight:bold;
}
.name{width:120px}
.style{width:40px}
.jockey{width:80px}
.odd{margin-left:auto;font-weight:bold}

/* æ è‰² */
.num.w1{background:white;color:black;border:1px solid #000}
.num.w2{background:black}
.num.w3{background:red}
.num.w4{background:blue}
.num.w5{background:yellow;color:black}
.num.w6{background:green}
.num.w7{background:orange}
.num.w8{background:pink;color:black}

select,input{margin:2px}
</style>
</head>

<body>
<h2>ğŸ‡ ç«¶é¦¬ã‚²ãƒ¼ãƒ </h2>

<div id="players" class="box"></div>

<div class="box">
  <h3>ğŸŸï¸ è³­ã‘</h3>
  <div id="betUI"></div>
  <button onclick="startRace()">ãƒ¬ãƒ¼ã‚¹é–‹å§‹</button>
</div>

<div id="info"></div>
<div id="race"></div>
<pre id="result"></pre>

<script>
// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
const rand=n=>Math.floor(Math.random()*n);
const styles=["é€ƒã’","å…ˆè¡Œ","å·®ã—","è¿½è¾¼"];
const syll=["ã‚µãƒ³","ãƒ©ã‚¤","ãƒ–ãƒ¬","ãƒ•ã‚¡","ãƒ‰","ãƒ«","ã‚«","ã‚°","ãƒ´","ãƒŠ","ãƒˆ","ã‚­","ãƒ©","ã‚¹"];
const randName=()=>syll[rand(syll.length)]+syll[rand(syll.length)]+syll[rand(syll.length)];

// ===== ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ =====
const save=()=>localStorage.setItem("keiba",JSON.stringify({players,horsePool,history}));
const load=()=>{
  let d=JSON.parse(localStorage.getItem("keiba"));
  if(d){
    players=d.players;
    horsePool=d.horsePool;
    history=d.history;
  }
};

// ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ =====
let players=[
  {name:"P1",money:1500},
  {name:"P2",money:1500},
  {name:"P3",money:1500}
];

// ===== é¨æ‰‹ =====
let jockeys=[];
for(let i=0;i<60;i++){
  jockeys.push({
    name:`J${i+1}é¨æ‰‹`,
    skill:Math.random()*0.4+0.8,
    judge:Math.random()*0.4+0.8,
    finish:Math.random()*0.4+0.8,
    chaos:Math.random()*0.6+0.7
  });
}

// ===== é¦¬300é ­ =====
let horsePool=[];
for(let i=0;i<300;i++){
  horsePool.push({
    name:randName(),
    style:styles[rand(4)],
    power:Math.random()*3+2,
    wins:0,
    streak:0
  });
}

let history=[];
load();

// ===== è¡¨ç¤º =====
function drawPlayers(){
  let t="";
  players.forEach(p=>t+=`${p.name} æ‰€æŒé‡‘:${p.money}å††<br>`);
  document.getElementById("players").innerHTML=t;
}
drawPlayers();

// ===== ã‹ã‘UI =====
function buildBetUI(){
  let ui="";
  players.forEach((p,i)=>{
    ui+=`
    <b>${p.name}</b>
    åˆ¸ç¨®:
    <select id="type${i}">
      <option>å˜å‹</option>
      <option>ä¸‰é€£è¤‡</option>
      <option>ä¸‰é€£å˜</option>
    </select>
    é¦¬:
    <input id="sel${i}" placeholder="ä¾‹:1 / 1-2-3 / 1â†’2â†’3">
    é‡‘é¡:
    <input type="number" id="amt${i}" value="100" min="100" step="100"><br><br>`;
  });
  document.getElementById("betUI").innerHTML=ui;
}
buildBetUI();

// ===== è³­ã‘å…¥åŠ›ã®ãƒ‘ãƒ¼ã‚¹ =====
function parseNums(str){
  if(!str) return [];
  return str
    .trim()
    .replace(/[â†’>]/g, "-")
    .split(/[\s\-_,/]+/)
    .map(s => Number(s))
    .filter(n => Number.isInteger(n) && n >= 1 && n <= 10);
}

// ===== çš„ä¸­åˆ¤å®šã¨æ‰•æˆ»è¨ˆç®—ï¼ˆpayã¯100å††ã‚ãŸã‚Šï¼‰ =====
function settleBet(type, selStr, amt, order, pay){
  // amtã¯100å††å˜ä½æƒ³å®š
  if(!amt || amt < 100) return {ok:false, msg:"é‡‘é¡ãŒä¸æ­£", payout:0};
  const scale = amt / 100;

  const a = order[0].id + 1;
  const b = order[1].id + 1;
  const c = order[2].id + 1;

  if(type === "å˜å‹"){
    const nums = parseNums(selStr);
    if(nums.length !== 1) return {ok:false, msg:"å˜å‹ã¯ã€Œ1ã€ã¿ãŸã„ã«1ã¤ã ã‘", payout:0};
    const hit = (nums[0] === a);
    return {ok:true, msg: hit ? "çš„ä¸­(å˜å‹)" : "ãƒã‚ºãƒ¬(å˜å‹)", payout: hit ? Math.round(pay.win * scale) : 0};
  }

  if(type === "ä¸‰é€£è¤‡"){
    const nums = parseNums(selStr);
    if(nums.length !== 3) return {ok:false, msg:"ä¸‰é€£è¤‡ã¯ã€Œ1-2-3ã€ã¿ãŸã„ã«3ã¤", payout:0};
    const set1 = nums.slice().sort((x,y)=>x-y).join(",");
    const set2 = [a,b,c].slice().sort((x,y)=>x-y).join(",");
    const hit = (set1 === set2);
    return {ok:true, msg: hit ? "çš„ä¸­(ä¸‰é€£è¤‡)" : "ãƒã‚ºãƒ¬(ä¸‰é€£è¤‡)", payout: hit ? Math.round(pay.trio * scale) : 0};
  }

  if(type === "ä¸‰é€£å˜"){
    const nums = parseNums(selStr);
    if(nums.length !== 3) return {ok:false, msg:"ä¸‰é€£å˜ã¯ã€Œ1-2-3ã€ã¾ãŸã¯ã€Œ1â†’2â†’3ã€", payout:0};
    const hit = (nums[0] === a && nums[1] === b && nums[2] === c);
    return {ok:true, msg: hit ? "çš„ä¸­(ä¸‰é€£å˜)" : "ãƒã‚ºãƒ¬(ä¸‰é€£å˜)", payout: hit ? Math.round(pay.trifecta * scale) : 0};
  }

  return {ok:false, msg:"åˆ¸ç¨®ãŒä¸æ˜", payout:0};
}

// ===== ãƒ¬ãƒ¼ã‚¹ =====
let horses=[],order=[],pace,chaos=false;

function startRace(){
  document.getElementById("race").innerHTML="";
  document.getElementById("info").innerHTML="";
  order=[];
  chaos=Math.random()<0.03;
  pace=["ã‚¹ãƒ­ãƒ¼","ãƒŸãƒ‰ãƒ«","ãƒã‚¤"][rand(3)];

  horses=horsePool.sort(()=>Math.random()-0.5).slice(0,10);
  horses.forEach((h,i)=>{
    h.id=i;h.pos=0;h.fin=false;
    h.jockey=jockeys[rand(jockeys.length)];
    h.condition=Math.random()*0.6+0.7;
    h.odd=((15/h.power)*(1+h.streak*0.2)*(2-h.jockey.skill)).toFixed(1);

    let frame=(i%8)+1;
    let d=document.createElement("div");
    d.innerHTML=`
      <span class="num w${frame}">${i+1}</span>
      ${h.name}ï¼ˆ${h.style}ï¼‰é¨æ‰‹:${h.jockey.name} ${h.odd}å€
      <div id="h${i}" class="bar"></div>`;
    document.getElementById("race").appendChild(d);
  });

  document.getElementById("info").innerHTML=
    `<div class="box">è·é›¢:${rand(1200)+1000}m / ãƒšãƒ¼ã‚¹:${pace}${chaos?" âš ï¸å¤§è’ã‚Œ":""}</div>`;

  drawPopularity();

  let timer=setInterval(()=>{
    step();
    if(order.length>=3){
      clearInterval(timer);
      finish();
    }
  },100);
}

function step(){
  horses.forEach(h=>{
    if(h.fin)return;
    let s=Math.random()*6+(h.power*0.6);
    s*=h.condition*h.jockey.skill;

    if(pace==="ãƒã‚¤"&&h.style==="é€ƒã’")s-=1.5;
    if(pace==="ãƒã‚¤"&&h.style==="è¿½è¾¼")s+=2;
    if(pace==="ã‚¹ãƒ­ãƒ¼"&&h.style==="é€ƒã’")s+=1.5;
    if(pace==="ã‚¹ãƒ­ãƒ¼"&&h.style==="è¿½è¾¼")s-=1;

    if(h.pos>80)s*=h.jockey.finish;
    if(chaos)s*=h.jockey.chaos;
    if(Math.random()<0.05)s-=2;
    if(Math.random()<0.05)s+=2;

    h.pos+=s;
    document.getElementById("h"+h.id).style.width=h.pos+"%";

    if(h.pos>=100){
      h.fin=true;
      order.push(h);
    }
  });
}

// ===== äººæ°—é † =====
function drawPopularity(){
  let sorted=[...horses].sort((a,b)=>a.odd-b.odd);
  let html="<div class='box'><h3>ğŸ“Š äººæ°—é †</h3>";
  sorted.forEach((h,i)=>{
    let frame=(h.id%8)+1;
    html+=`
      <div class="pop">
        <span class="rank">${i+1}ç•ªäººæ°—</span>
        <span class="num w${frame}">${h.id+1}</span>
        <span class="name">${h.name}</span>
        <span class="style">${h.style}</span>
        <span class="jockey">${h.jockey.name}</span>
        <span class="odd">${h.odd}å€</span>
      </div>`;
  });
  html+="</div>";
  document.getElementById("info").innerHTML+=html;
}

// ===== æ‰•æˆ»è¡¨ï¼ˆ100å††ã‚ãŸã‚Šï¼‰ =====
function payout(order){
  let f=order[0],s=order[1],t=order[2];
  return {
    win:Math.round(f.odd*100),
    trio:Math.round((Number(f.odd)+Number(s.odd)+Number(t.odd))/3*300),
    trifecta:Math.round(Number(f.odd)*800+Number(s.odd)*200+Number(t.odd)*100)
  };
}

// ===== çµæœ =====
function finish(){
  let res="ğŸ çµæœ\n";
  order.forEach((h,i)=>res+=`${i+1}ç€ ${h.name}\n`);

  let pay=payout(order);
  res+=`
ã€æ‰•æˆ»é‡‘ï¼ˆ100å††ã‚ãŸã‚Šï¼‰ã€‘
å˜å‹ã€€${order[0].id+1}ã€€${pay.win}å††
ä¸‰é€£è¤‡ã€€${order[0].id+1}-${order[1].id+1}-${order[2].id+1}ã€€${pay.trio}å††
ä¸‰é€£å˜ã€€${order[0].id+1}â†’${order[1].id+1}â†’${order[2].id+1}ã€€${pay.trifecta}å††
`;

  // ===== æ‰€æŒé‡‘å‡¦ç†ï¼ˆè³¼å…¥â†’çš„ä¸­ãªã‚‰æ‰•æˆ»ï¼‰ =====
  res += "\nã€è³¼å…¥çµæœã€‘\n";
  players.forEach((p,i)=>{
    const type = document.getElementById("type"+i).value;
    const sel  = document.getElementById("sel"+i).value;
    const amt  = Number(document.getElementById("amt"+i).value);

    // æœªå…¥åŠ›ãªã‚‰è³­ã‘ãªã—
    if(!sel || !amt){
      res += `${p.name}: è¦‹é€ã‚Š\n`;
      return;
    }

    // äºˆç®—ä¸è¶³ãªã‚‰è³­ã‘ä¸æˆç«‹
    if(amt > p.money){
      res += `${p.name}: è³‡é‡‘ä¸è¶³ã§ä¸æˆç«‹\n`;
      return;
    }

    // ã„ã£ãŸã‚“è³¼å…¥
    p.money -= amt;

    const r = settleBet(type, sel, amt, order, pay);
    if(!r.ok){
      // å…¥åŠ›ä¸æ­£ â†’ è³¼å…¥è‡ªä½“ã‚’ãªã‹ã£ãŸã“ã¨ã«ã™ã‚‹ï¼ˆè¿”é‡‘ï¼‰
      p.money += amt;
      res += `${p.name}: å…¥åŠ›ä¸æ­£ï¼ˆ${r.msg}ï¼‰â†’ä¸æˆç«‹\n`;
      return;
    }

    // æ‰•æˆ»
    if(r.payout > 0){
      p.money += r.payout;
      res += `${p.name}: ${r.msg} +${r.payout}å††\n`;
    }else{
      res += `${p.name}: ${r.msg}\n`;
    }
  });

  // ===== æˆç¸¾æ›´æ–° =====
  order[0].wins++;
  order[0].streak++;
  order.slice(1).forEach(h=>h.streak=0);

  history.unshift(order.map(h=>h.name));
  if(history.length>10)history.pop();

  save();
  drawPlayers();
  document.getElementById("result").textContent=res;
}
</script>
</body>
</html>
